package: bitlbee
rules:
  inject_compat_functions:
  - strcasestr
  drop_buildrequires:
  - systemd-rpm-macros
  - libpurple-devel
  - '%{_bindir}/python3'
  - docbook-style-xsl
  spec_replacements:
  - pattern: '%bcond_without otr'
    replacement: '%bcond_with otr'
  - pattern: '%{?systemd_requires}

      %{?sysusers_requires_compat}'
    replacement: '# systemd/sysusers not needed on IRIX'
  - pattern: 'License:           GPLv2+ and MIT'
    replacement: 'License:           GPLv2+ and MIT

      Provides: bitlbee(mips-32) = %{version}-%{release}'
  - pattern: touch -c -r bitlbee.conf{.forkdaemon,}
    replacement: touch -c -r bitlbee.conf.forkdaemon bitlbee.conf
  - pattern: "export PYTHON=\"%{_bindir}/python3\"\nexport CFLAGS=\"$RPM_OPT_FLAGS\"\n./configure \\\n  --prefix=%{_prefix} \\\n  --bindir=%{_sbindir} \\\n  --etcdir=%{_sysconfdir}/%{name} \\\n  --mandir=%{_mandir}\
      \ \\\n  --datadir=%{_datadir}/%{name} \\\n  --config=%{_localstatedir}/lib/%{name} \\\n  --pcdir=%{_libdir}/pkgconfig \\\n  --plugindir=%{_libdir}/%{name} \\\n  --systemdsystemunitdir=%{_unitdir}\
      \ \\\n  --strip=0 \\\n  --plugins=1 \\\n  --ssl=gnutls \\\n  --jabber=1 \\\n  --twitter=1 \\\n  --purple=1 \\\n%if %{with otr}\n  --otr=plugin\n%endif\n\n%make_build VERBOSE=\"\"\n(cd doc/user-guide/\
      \ && make user-guide.html)"
    replacement: "export CC=\"%{__cc}\"\nexport CFLAGS=\"%{optflags}\"\nexport PKG_CONFIG_LIBDIR=\"/opt/sgug-staging/usr/sgug/lib32/pkgconfig:/opt/sgug-staging/usr/sgug/share/pkgconfig\"\nexport PKG_CONFIG_SYSROOT_DIR=\"\
      /opt/sgug-staging\"\nexport LD=/home/edodd/projects/github/unxmaal/mogrix/tools/bin/ld.lld-irix-18\n./configure \\\n  --prefix=%{_prefix} \\\n  --bindir=%{_sbindir} \\\n  --etcdir=%{_sysconfdir}/%{name}\
      \ \\\n  --mandir=%{_mandir} \\\n  --datadir=%{_datadir}/%{name} \\\n  --config=%{_localstatedir}/lib/%{name} \\\n  --pcdir=%{_libdir}/pkgconfig \\\n  --plugindir=%{_libdir}/%{name} \\\n  --strip=0\
      \ \\\n  --plugins=1 \\\n  --ssl=gnutls \\\n  --jabber=1 \\\n  --twitter=1 \\\n  --purple=0 \\\n  --otr=0 \\\n  --pie=0\n# Inject compat library and gcrypt (libgcrypt-config not in PATH)\n# Dynamic\
      \ list: export only the 48 symbols plugins need (discord.so etc.)\n# --export-dynamic exports ALL symbols and crashes IRIX rld (>468 entries)\n# --dynamic-list exports only listed symbols for dlopen\
      \ resolution\necho \"EFLAGS += -L$COMPAT_DIR -lmogrix-compat -lgcrypt -Wl,--dynamic-list=/home/edodd/projects/github/unxmaal/mogrix/cross/bitlbee-plugin-symbols.list\" >> Makefile.settings\n%make_build\
      \ VERBOSE=\"\"\n"
  - pattern: '%make_install install-etc install-dev install-systemd


      # Declarative allocation of system users and groups

      install -D -p -m 0644 %{SOURCE1} $RPM_BUILD_ROOT%{_sysusersdir}/%{name}.conf


      # Create some directories manually

      mkdir -p $RPM_BUILD_ROOT{%{_localstatedir}/lib,%{_libdir}}/%{name}/'
    replacement: '%make_install install-etc install-dev

      # Create directories manually (no brace expansion in /bin/sh)

      mkdir -p $RPM_BUILD_ROOT%{_localstatedir}/lib/%{name}/

      mkdir -p $RPM_BUILD_ROOT%{_libdir}/%{name}/

      '
  - pattern: '%pre

      %sysusers_create_compat %{SOURCE1}


      %post

      %systemd_post %{name}.service


      %preun

      %systemd_preun %{name}.service


      %postun

      %systemd_postun_with_restart %{name}.service'
    replacement: '# Scriptlets removed for IRIX (no systemd/sysusers)'
  - pattern: '%files

      %license COPYING

      %doc doc/{AUTHORS,CHANGES,CREDITS,FAQ,README}

      %doc doc/user-guide/user-guide.html

      %attr(0750,root,bitlbee) %dir %{_sysconfdir}/%{name}/

      %attr(0640,root,bitlbee) %config(noreplace) %{_sysconfdir}/%{name}/*

      %{_sbindir}/%{name}

      %dir %{_libdir}/%{name}/

      %{_datadir}/%{name}/

      %{_mandir}/man?/%{name}*

      %attr(0750,bitlbee,bitlbee) %dir %{_localstatedir}/lib/%{name}/

      %{_unitdir}/%{name}*

      %{_sysusersdir}/%{name}.conf'
    replacement: '%files

      %license COPYING

      %doc doc/AUTHORS doc/CHANGES doc/CREDITS doc/FAQ doc/README

      %dir %{_sysconfdir}/%{name}/

      %config(noreplace) %{_sysconfdir}/%{name}/*

      %{_sbindir}/%{name}

      %dir %{_libdir}/%{name}/

      %{_datadir}/%{name}/

      %{_mandir}/man?/%{name}*

      %dir %{_localstatedir}/lib/%{name}/

      '
  - pattern: 'Requires:          %{name}%{?_isa} = %{version}-%{release}, pkgconfig'
    replacement: 'Requires:          %{name} = %{version}-%{release}'
  prep_commands:
  - sed -i -e 's/%10zd/%10d/g' -e 's/%zu/%u/g' -e 's/%zd/%d/g' -e 's/%zx/%x/g' conf.c dcc.c lib/oauth.c lib/oauth2.c protocols/jabber/si.c protocols/twitter/twitter_http.c root_commands.c
  - sed -i 's/sa_len/saddr_len/g' dcc.c
