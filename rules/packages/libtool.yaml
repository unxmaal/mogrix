# libtool package rules for IRIX cross-compilation
package: libtool

# libtool 2.4.7 already has the IRIX inherit_rpath fixes from SGUG-RSE
# Old libtool.sgifixes.patch no longer needed

rules:
  # No NLS in cross-compilation
  skip_find_lang: true

  # help2man not available during cross-compilation
  drop_buildrequires:
    - help2man

  # Drop Fedora-specific requires that don't apply to IRIX
  # gcc(major) = 13 is Fedora GCC - we use clang
  # automake version lock is too strict
  drop_requires:
    - "gcc(major)"
    - "automake = 1.16.5"

  # Fix shebangs: /bin/bash doesn't exist on IRIX, use /usr/sgug/bin/bash
  install_cleanup:
    - "sed -i 's|#!.*/bin/bash|#!/usr/sgug/bin/bash|g' %{buildroot}%{_bindir}/libtool %{buildroot}%{_bindir}/libtoolize"

  spec_replacements:
    # Replace make command: remove Fedora hardening flags (not defined for IRIX)
    # and add HELP2MAN=true to skip man page generation
    - pattern: |
        %make_build \
            CUSTOM_LTDL_CFLAGS="%_hardening_cflags" \
            CUSTOM_LTDL_LDFLAGS="%_hardening_ldflags"
      replacement: "%make_build HELP2MAN=true"
    # Also pass HELP2MAN=true during install (Makefile regenerates man pages)
    - pattern: "%make_install"
      replacement: "%make_install HELP2MAN=true"
    # Info files aren't auto-compressed in cross-compilation (no __brp_compress)
    - pattern: "%{_infodir}/libtool.info*.gz"
      replacement: "%{_infodir}/libtool.info*"
    # Fix host triple: %configure expands --host=mips-irix (from rpmbuild --target),
    # but libtool's configure needs host_os=irix6* to enable shared library support.
    # Appending --host= overrides the earlier one from %configure expansion.
    - pattern: "%configure"
      replacement: "%configure --host=mips-sgi-irix6.5"
    # Fix bash brace expansion not supported in rpmbuild shell
    - pattern: "rm -f %{buildroot}%{_libdir}/libltdl.{a,la}"
      replacement: "rm -f %{buildroot}%{_libdir}/libltdl.a %{buildroot}%{_libdir}/libltdl.la"

