# sed - GNU stream text editor
# FC40: sed-4.9-1.fc40
# Analysis: 36 findings (3 errors, 5 warnings, 28 infos)
# %zu errors only in lib/malloc/dynarray_at_failure.c (error path) + gnulib-tests (skipped)
# Most findings are in gnulib-tests/ which won't compile (skip_check)

package: sed

rules:
  # Compat functions needed for IRIX
  # strdup: dlmalloc/libc allocator mismatch (15+ locations in lib/)
  # getopt_long: sed/sed.c uses it for option parsing
  # reallocarray: lib/xmalloc.c, lib/ialloc.h, lib/reallocarray.c
  # strerror_r: lib/error.c
  inject_compat_functions:
    - strdup
    - getopt_long
    - reallocarray
    - strerror_r

  # Drop build deps not available or not needed
  drop_buildrequires:
    - valgrind            # test-only (skip_check)
    - glibc-langpack-el   # test locales
    - glibc-langpack-en   # test locales
    - glibc-langpack-ru   # test locales
    - perl-Getopt-Long    # test-only

  # Avoid getrandom/sys/random.h conflict with dicl-clang-compat header
  ac_cv_overrides:
    ac_cv_header_sys_random_h: "no"

  # Disable NLS (no gettext available yet) and ACL (no libacl on IRIX)
  # Use included regex: IRIX libc only has POSIX regex (regcomp/regexec),
  # not GNU regex extensions (re_compile_pattern/re_search/re_set_syntax).
  # Fedora uses --without-included-regex because glibc has GNU regex.
  configure_flags:
    add:
      - --disable-nls
      - --disable-acl
    remove:
      - --without-included-regex

  # Fix %zu in error path (IRIX libc doesn't support %zu format specifier)
  # Remove gnulib-tests from SUBDIRS â€” it's built during 'make all' but
  # references Linux-specific functions (select wrapper, getrandom tests, etc.)
  # Since we skip_check, these tests are never needed.
  prep_commands:
    - "sed -i 's/%zu/%u/g' lib/malloc/dynarray_at_failure.c"
    - "sed -i 's/gnulib-tests//' Makefile.in"

  # NLS disabled, no lang files
  skip_find_lang: true

  spec_replacements:
    # Remove lang file reference from %files
    - pattern: "%find_lang %{name}"
      replacement: "# %find_lang disabled (--disable-nls)"
    - pattern: "%files -f %{name}.lang"
      replacement: "%files"
