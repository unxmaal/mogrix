# pixman - Pixel manipulation library (FC40: 0.43.0)
# Uses meson build system; no assembly optimizations for MIPS
#
# === IRIX TLS fix ===
# IRIX 6.5 rld has no TLS support (__tls_get_addr doesn't exist).
# Clang cross-compiler supports __thread syntax (meson detects it as available),
# but the generated code calls __tls_get_addr which rld can't resolve.
# Pixman uses TLS for internal per-thread caches (compositing fast-paths).
# Symptom: cairo_stroke(), cairo_arc(), cairo_show_text() crash with:
#   rld: Fatal Error: attempted access to unresolvable symbol in libpixman-1.so.0: __tls_get_addr
# while cairo_paint() and cairo_fill(rectangle) work (they use pixman fast-paths
# that don't touch TLS variables).
# Fix: -Dtls=disabled + PIXMAN_NO_TLS define â†’ plain static variables (not
# thread-safe, but all IRIX GUI apps are single-threaded).
package: pixman

rules:

  prep_commands:
    # Define PIXMAN_NO_TLS before the TLS detection block in pixman-compiler.h.
    # Belt-and-suspenders with -Dtls=disabled in meson: ensures pixman uses
    # plain static variables even if pthreads detection fails in cross-compile.
    - "$MOGRIX_ROOT/tools/safepatch pixman/pixman-compiler.h --insert-top '#define PIXMAN_NO_TLS 1' --no-backup --quiet"

  spec_replacements:
    # Replace %meson with raw meson commands using our cross file
    - pattern: "%meson --auto-features=auto \\\n%ifarch %{arm}\n  -Diwmmxt=disabled -Diwmmxt2=false \\\n%endif\n  %nil\n\n%meson_build"
      replacement: "MOGRIX_CROSS=/home/edodd/projects/github/unxmaal/mogrix/cross/meson-irix-cross.ini\n/home/edodd/.local/bin/meson setup _build \\\n  --cross-file=$MOGRIX_CROSS \\\n  --prefix=%{_prefix} \\\n  --libdir=%{_libdir} \\\n  --auto-features=auto \\\n  -Dtls=disabled \\\n  -Dtests=disabled \\\n  -Ddemos=disabled \\\n  -Dc_link_args=\"-L$COMPAT_DIR -lmogrix-compat\"\n/home/edodd/.local/bin/meson compile -C _build"

    # Replace %meson_install
    - pattern: "%meson_install"
      replacement: "DESTDIR=$RPM_BUILD_ROOT /home/edodd/.local/bin/meson install -C _build --no-rebuild"

