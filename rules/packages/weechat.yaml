# weechat - IRC/Matrix client
# Build system: cmake (uses %cmake3 macros in FC40 spec)
# First community-requested app bundle target
#
# Strategy: Replace %cmake3 macro block with raw cmake cross-compilation
# command (following tdnf.yaml pattern). Disable ALL scripting languages,
# spell checking, docs, and headless mode.

package: weechat

rules:
  # Compat functions needed for IRIX
  inject_compat_functions:
    - setenv
    - mkdtemp

  # Drop scripting language and doc BuildRequires
  drop_buildrequires:
    - enchant-devel
    - guile22-devel
    - guile-devel
    - lua-devel
    - perl-ExtUtils-Embed
    - perl-devel
    - python3-devel
    - ruby
    - ruby-devel
    - tcl-devel
    - docbook-style-xsl
    - source-highlight
    - asciidoctor
    - cpputest-devel
    - glibc-langpack-en
    - ca-certificates
    - hicolor-icon-theme

  drop_requires:
    - hicolor-icon-theme

  # PKG_CONFIG paths for cross-compilation
  export_vars:
    PKG_CONFIG_PATH: "/opt/sgug-staging/usr/sgug/lib32/pkgconfig"
    PKG_CONFIG_LIBDIR: "/opt/sgug-staging/usr/sgug/lib32/pkgconfig"
    PKG_CONFIG_SYSROOT_DIR: "/opt/sgug-staging"

  spec_replacements:
    # Flip check/docs bconds to OFF (so RPM evaluates %if blocks correctly)
    - pattern: "%bcond_without check"
      replacement: "%bcond_with check"
    - pattern: "%bcond_without docs"
      replacement: "%bcond_with docs"
    # Replace %cmake3 macro block with raw cmake cross-compilation command
    # Must match exact text of the original spec
    - pattern: |
        %cmake3 \
          -DPREFIX=%{_prefix} \
          -DLIBDIR=%{_libdir} \
          -DENABLE_ENCHANT=ON \
          -DENABLE_PHP=OFF \
        %if %{with check}
          -DENABLE_TESTS=ON \
        %else
          -DENABLE_TESTS=OFF \
        %endif
        %if %{with docs}
          -DENABLE_DOC=ON \
          -DENABLE_DOC_INCOMPLETE=ON \
          -DENABLE_MAN=ON \
        %else
          -DENABLE_DOC=OFF \
          -DENABLE_MAN=OFF \
        %endif
          -DCA_FILE=/etc/pki/tls/certs/ca-bundle.crt \
          %{nil}
        %cmake3_build
      replacement: |
        export COMPAT_DIR=$(pwd)/mogrix-compat
        cmake -B _build -S . \
          -DCMAKE_MAKE_PROGRAM=/usr/bin/make \
          -DPKG_CONFIG_EXECUTABLE=/usr/bin/pkg-config \
          -DCMAKE_SYSTEM_NAME=IRIX \
          -DCMAKE_C_COMPILER=%{__cc} \
          -DCMAKE_CXX_COMPILER=%{__cxx} \
          -DCMAKE_AR=%{__ar} \
          -DCMAKE_RANLIB=%{__ranlib} \
          -DCMAKE_INSTALL_PREFIX=%{_prefix} \
          -DCMAKE_INSTALL_LIBDIR=%{_libdir} \
          -DCMAKE_C_FLAGS="-I/opt/sgug-staging/usr/sgug/include/mogrix-compat/generic -I/opt/sgug-staging/usr/sgug/include" \
          -DCMAKE_EXE_LINKER_FLAGS="-L/opt/sgug-staging/usr/sgug/lib32 $COMPAT_DIR/libmogrix-compat.a -lgen -lpthread" \
          -DCMAKE_SHARED_LINKER_FLAGS="-L/opt/sgug-staging/usr/sgug/lib32 $COMPAT_DIR/libmogrix-compat.a -lgen -lpthread" \
          -DCMAKE_PREFIX_PATH=/opt/sgug-staging/usr/sgug \
          -DCMAKE_INCLUDE_PATH=/opt/sgug-staging/usr/sgug/include \
          -DCMAKE_LIBRARY_PATH=/opt/sgug-staging/usr/sgug/lib32 \
          -DCMAKE_FIND_ROOT_PATH=/opt/sgug-staging/usr/sgug \
          -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY \
          -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY \
          -DCMAKE_BUILD_TYPE=Release \
          -DICONV_INCLUDE_PATH=/opt/irix-sysroot/usr/include \
          -DICONV_FOUND:BOOL=TRUE \
          -DPREFIX=%{_prefix} \
          -DLIBDIR=%{_libdir} \
          -DENABLE_PYTHON=OFF \
          -DENABLE_PERL=OFF \
          -DENABLE_RUBY=OFF \
          -DENABLE_LUA=OFF \
          -DENABLE_TCL=OFF \
          -DENABLE_GUILE=OFF \
          -DENABLE_PHP=OFF \
          -DENABLE_JAVASCRIPT=OFF \
          -DENABLE_ENCHANT=OFF \
          -DENABLE_SPELL=OFF \
          -DENABLE_DOC=OFF \
          -DENABLE_MAN=OFF \
          -DENABLE_TESTS=OFF \
          -DENABLE_HEADLESS=OFF \
          -DENABLE_NLS=OFF \
          -DENABLE_CJSON=OFF
        cd _build && make %{?_smp_mflags}
    # Replace cmake install macro
    - pattern: "%cmake3_install"
      replacement: "cd _build && make install DESTDIR=%{buildroot}"
    # Remove headless binary from %files (disabled)
    - pattern: "%{_bindir}/%{name}-headless\n"
      replacement: ""
    # Remove desktop and icon entries (IRIX has no freedesktop)
    - pattern: "%{_datadir}/icons/hicolor/32x32/apps/%{name}.png\n"
      replacement: ""
    - pattern: "%{_datadir}/applications/%{name}.desktop\n"
      replacement: ""
    - pattern: "%{_datadir}/icons/hicolor/128x128/apps/%{name}.png\n"
      replacement: ""
    - pattern: "%{_datadir}/icons/hicolor/16x16/apps/%{name}.png\n"
      replacement: ""
    - pattern: "%{_datadir}/icons/hicolor/256x256/apps/%{name}.png\n"
      replacement: ""
    - pattern: "%{_datadir}/icons/hicolor/512x512/apps/%{name}.png\n"
      replacement: ""
    - pattern: "%{_datadir}/icons/hicolor/64x64/apps/%{name}.png\n"
      replacement: ""
    # Remove doc/man entries gated by %if fedora (docs generation disabled)
    - pattern: "%{_pkgdocdir}/weechat_*.html\n"
      replacement: ""
    - pattern: "%{_mandir}/man1/weechat.1*\n"
      replacement: ""
    - pattern: "%{_mandir}/*/man1/weechat.1*\n"
      replacement: ""
    - pattern: "%{_mandir}/man1/%{name}-headless.1*\n"
      replacement: ""
    - pattern: "%{_mandir}/*/man1/%{name}-headless.1*\n"
      replacement: ""

  # Remove desktop/icon files that make install still creates
  install_cleanup:
    - "rm -rf %{buildroot}%{_datadir}/icons"
    - "rm -rf %{buildroot}%{_datadir}/applications"

  # NLS disabled, skip find_lang
  skip_find_lang: true

