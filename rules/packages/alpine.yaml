package: alpine
rules:
  inject_compat_functions:
  - mkdtemp
  drop_buildrequires:
  - pam-devel
  - krb5-devel
  - openldap-devel
  - passwd
  - hunspell
  drop_requires:
  - hunspell
  - mailcap
  - /usr/sbin/sendmail
  configure_flags:
    add:
    - --without-krb5
    - --without-ldap
    - --without-ntlm
    - --with-ssl-dir=/opt/sgug-staging/usr/sgug
    - --with-ssl-certs-dir=/usr/sgug/etc/pki/tls/certs
    - --with-ssl-include-dir=/opt/sgug-staging/usr/sgug/include
    - --with-ssl-lib-dir=/opt/sgug-staging/usr/sgug/lib32
  spec_replacements:
  - pattern: --with-c-client-target=lfd
    replacement: --with-c-client-target=slx
  - pattern: '%configure'
    replacement: 'export LIBS="$LIBS -lgen"

      %configure'
  - pattern: --with-smtp-msa=/usr/sbin/sendmail
    replacement: --with-smtp-msa=/usr/sgug/sbin/sendmail
  - pattern: --with-npa=/usr/bin/inews
    replacement: --with-npa=/usr/sgug/bin/inews
  - pattern: export RPM_BUILD_NCPUS=1
    replacement: '# Build help generators with host gcc (cross-compile HOSTCC pattern)

      gcc -o pith/help_h_gen pith/help_h_gen.c

      gcc -o pith/help_c_gen pith/help_c_gen.c

      cd pith && ./help_h_gen < pine.hlp > helptext.h && ./help_c_gen < pine.hlp > helptext.c && cd ..

      # Neuter the Makefile rules so make doesn''t rebuild with cross-compiler

      sed -i ''s|help_h_gen\$(EXEEXT): \$(help_h_gen_OBJECTS) \$(help_h_gen_DEPENDENCIES)|help_h_gen$(EXEEXT):|'' pith/Makefile

      sed -i ''s|help_c_gen\$(EXEEXT): \$(help_c_gen_OBJECTS) \$(help_c_gen_DEPENDENCIES)|help_c_gen$(EXEEXT):|'' pith/Makefile

      # Make helptext files appear up-to-date

      touch pith/helptext.h pith/helptext.c

      export RPM_BUILD_NCPUS=1

      '
  - pattern: install -m644 -p %{SOURCE1} .
    replacement: 'install -m644 -p %{SOURCE1} .


      # Fix CC_FOR_BUILD LIBS contamination: ac_link uses $LIBS which leaks

      # cross-compiled -lmogrix-compat into host gcc test.

      sed -i ''s|\$CC_FOR_BUILD -o conftest\$ac_build_exeext \$CFLAGS_FOR_BUILD \$CPPFLAGS_FOR_BUILD \$LDFLAGS_FOR_BUILD conftest\.\$ac_ext \$LIBS|\$CC_FOR_BUILD -o conftest\$ac_build_exeext \$CFLAGS_FOR_BUILD
      \$CPPFLAGS_FOR_BUILD \$LDFLAGS_FOR_BUILD conftest\.$ac_ext|g'' configure


      # Add IRIX case to the host detection case block (before the default *)

      sed -i ''/^  \*)$/i\  *-*-irix*)\n    systype="SGI"\n    alpine_path_delim="/"\n    alpine_mode_readonly="(0600)"\n    alpine_c_client_target="slx"\n    ;;'' configure


      # Fix %zu format specifier in smime.c — IRIX libc doesn''t support %zu

      sed -i ''s/%zu/%u/g'' pith/smime.c


      # IRIX: vfork is hidden under _SGIAPI (irix-cc defines _SGI_SOURCE).

      # IRIX vfork == fork anyway. Define vfork as fork in all pipe.c files.

      sed -i ''1i\#define vfork fork'' pith/osdep/pipe.c


      # Replace flocklnx.c with flocksim.c in the slx OS target.

      # flocklnx.c uses fstatfs/sys/vfs.h which IRIX doesn''t have.

      # flocksim.c uses fcntl-based locking which works on IRIX.

      sed -i ''s/#include "flocklnx.c"/#include "flocksim.c"/'' imap/src/osdep/unix/os_slx.c


      # os_slx.h needs flocksim.h (the flocksim API) and ustat.h

      # (flocksim.c uses struct ustat). os_sgi.h includes both but os_slx.h doesn''t.

      sed -i ''/#include "tcp.h"/a\#include "flocksim.h"'' imap/src/osdep/unix/os_slx.h

      sed -i ''/#include <sys\/file.h>/a\#include <ustat.h>'' imap/src/osdep/unix/os_slx.h


      # IRIX header visibility: _XOPEN_SOURCE=1 hides scandir() (needs _SGIAPI)

      # but removing _XOPEN_SOURCE hides vfork() (needs !_SGIAPI on IRIX).

      # Fix: keep _XOPEN_SOURCE but provide explicit prototypes for scandir.

      # Guard with #if !_SGIAPI (not #ifndef — _SGIAPI is a macro expression,

      # always defined, evaluates to 0 or 1). Signatures match IRIX dirent.h.

      sed -i ''/^#define direct dirent/a\/* IRIX: scandir/alphasort not visible under _XOPEN_SOURCE, declare them */\n#if !_SGIAPI\nstruct dirent;\nint scandir(const char *, struct dirent ***,\n            int
      (*)(const struct dirent *),\n            int (*)(const struct dirent **, const struct dirent **));\nint alphasort(const struct dirent **, const struct dirent **);\n#endif'' imap/src/osdep/unix/os_slx.h

      '
