From: Mogrix Project
Subject: [PATCH] LLD: Skip MIPS ABIFLAGS for IRIX targets

IRIX 6.5's ELF parser predates the MIPS ABIFLAGS feature (introduced
in later MIPS toolchains). When IRIX encounters:
- PT_MIPS_ABIFLAGS program header (type 0x70000003)
- SHT_MIPS_ABIFLAGS section (type 0x7000002a)

It crashes (segfaults in odump, rld, etc.) because it doesn't
recognize these types.

This patch conditionally skips creating the .MIPS.abiflags section
and PT_MIPS_ABIFLAGS program header when the target OSABI is IRIX.

Tested: Cross-compiled shared libraries now work on IRIX 6.5.30
when built without ABIFLAGS.

---
 lld/ELF/Writer.cpp | 10 +++++++---
 1 file changed, 7 insertions(+), 3 deletions(-)

--- a/lld/ELF/Writer.cpp
+++ b/lld/ELF/Writer.cpp
@@ -326,8 +326,11 @@ template <class ELFT> void Writer<ELFT>::createSyntheticSections() {
       in.mipsRldMap = std::make_unique<MipsRldMapSection>();
       add(*in.mipsRldMap);
     }
-    if ((in.mipsAbiFlags = MipsAbiFlagsSection<ELFT>::create()))
-      add(*in.mipsAbiFlags);
+    // IRIX predates MIPS ABIFLAGS - its ELF parser crashes on the section type
+    if (config->osabi != ELFOSABI_IRIX) {
+      if ((in.mipsAbiFlags = MipsAbiFlagsSection<ELFT>::create()))
+        add(*in.mipsAbiFlags);
+    }
     if ((in.mipsOptions = MipsOptionsSection<ELFT>::create()))
       add(*in.mipsOptions);
     if ((in.mipsReginfo = MipsReginfoSection<ELFT>::create()))
@@ -2073,8 +2076,11 @@ template <class ELFT> void Writer<ELFT>::createPhdrs() {
       if (config->emachine == EM_MIPS) {
         // Add separate segments for MIPS-specific sections.
         // IRIX requires PT_MIPS_OPTIONS to be before the DYNAMIC phdr.
+        // However, IRIX predates PT_MIPS_ABIFLAGS and crashes on it.
         int loc = config->osabi == ELFOSABI_IRIX ? 2 : -1;
-        addPhdrForSection(part, SHT_MIPS_ABIFLAGS, PT_MIPS_ABIFLAGS, PF_R, loc);
+        if (config->osabi != ELFOSABI_IRIX) {
+          addPhdrForSection(part, SHT_MIPS_ABIFLAGS, PT_MIPS_ABIFLAGS, PF_R, loc);
+        }
         addPhdrForSection(part, SHT_MIPS_REGINFO, PT_MIPS_REGINFO, PF_R, loc);
         addPhdrForSection(part, SHT_MIPS_OPTIONS, PT_MIPS_OPTIONS, PF_R, loc);
       }
