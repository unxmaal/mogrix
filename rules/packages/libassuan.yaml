# libassuan - IPC library for GnuPG
# Build system: autoconf (no libtool in this version, uses custom shlib build)
#
# IRIX has conflicting feature test macros:
#   - _XOPEN_SOURCE=500 gives SCM_RIGHTS and snprintf, but hides IPv6 and inet_pton
#   - _SGI_SOURCE gives IPv6, snprintf, inet_pton, but hides SCM_RIGHTS
#
# Solution: Use _SGI_SOURCE and manually define SCM_RIGHTS=0x01

package: libassuan

rules:
  # IRIX needs _SGI_SOURCE for IPv6/snprintf, and manual SCM_RIGHTS definition
  extra_cflags:
    - -D_SGI_SOURCE
    - -DSCM_RIGHTS=0x01

  skip_check: true

  # Remove static library and .la files
  # Symlink assuan.h from libassuan2/ subdirectory to top-level include dir
  # so cross-compiled packages can find it (libassuan-config returns the
  # subdirectory path which doesn't work through the sysroot)
  install_cleanup:
    - "rm -f %{buildroot}%{_libdir}/*.a"
    - "rm -rf %{buildroot}%{_infodir}"
    - "ln -sf libassuan2/assuan.h %{buildroot}%{_includedir}/assuan.h"

  # Fix missing declarations for unsetenv/clearenv when HAVE_SETENV is not defined.
  # The macros redirect unsetenvâ†’_assuan_unsetenv but only setenv gets a prototype.
  # This is a bug hidden on Linux where HAVE_SETENV is always true.
  prep_commands:
    - "perl -pi -e 's/^(int setenv \\(const char \\*name, const char \\*value, int replace\\);)$/$1\\nint unsetenv (const char *name);\\nint clearenv (void);/' src/assuan-defs.h"

  # Configure flags
  configure_flags:
    add:
      - --with-libgpg-error-prefix=/opt/sgug-staging/usr/sgug
      - --enable-shared
      - --disable-static

  spec_replacements:
    # Remove info page from %files devel (may not be generated)
    - pattern: "%{_infodir}/assuan.info*\n"
      replacement: ""
    # Add the assuan.h symlink (created by install_cleanup) to %files devel
    - pattern: "%{_includedir}/libassuan2/"
      replacement: "%{_includedir}/assuan.h\n%{_includedir}/libassuan2/"

