# curl - URL transfer library and tool
# Critical for network operations

package: curl

rules:
  # Compat functions that may be needed
  inject_compat_functions:
    - strdup
    - strndup

  # Drop problematic dependencies
  drop_buildrequires:
    - libssh2-devel
    - libpsl-devel
    - libidn2-devel
    - krb5-devel
    - openssl-devel

  # Use cross-compiled OpenSSL from staging
  export_vars:
    PKG_CONFIG_PATH: "/opt/sgug-staging/usr/sgug/lib32/pkgconfig"
    PKG_CONFIG_LIBDIR: "/opt/sgug-staging/usr/sgug/lib32/pkgconfig"
    PKG_CONFIG_SYSROOT_DIR: "/opt/sgug-staging"
    CPPFLAGS: "-I/opt/sgug-staging/usr/sgug/include $CPPFLAGS"
    LDFLAGS: "-L/opt/sgug-staging/usr/sgug/lib32 $LDFLAGS"

  # Package-specific autoconf cache overrides
  ac_cv_overrides:
    curl_cv_func_recv_args: "int,void *,size_t,int"
    curl_cv_func_send_args: "int,const void *,size_t,int"

  # Configure flags
  configure_flags:
    add:
      - --disable-silent-rules
      - --with-ssl
      - --with-zlib
      - --enable-ipv6
      - --disable-threaded-resolver
      - --without-libssh2
      - --without-libpsl
      - --without-libidn2
      - --without-brotli
      - --without-zstd
      - --without-nghttp2
      - --without-gssapi
      - --disable-ldap
      - --disable-ldaps
    remove:
      - --with-libssh2
      - --with-brotli
      - --with-nghttp2
      - --with-gssapi

  configure_disable:
    - ldap
    - ldaps

  # Shell syntax fixes and cross-compilation adjustments
  spec_replacements:
    # Fix brace expansion - mkdir
    - pattern: "mkdir build-{full,minimal}"
      replacement: "mkdir build-full build-minimal"
    # Fix brace expansion - sed
    - pattern: "build-{full,minimal}/libtool"
      replacement: "build-full/libtool build-minimal/libtool"
    # Disable LDAP in full build (we don't have cross-compiled LDAP)
    - pattern: "--enable-ldap"
      replacement: "--disable-ldap"
    - pattern: "--enable-ldaps"
      replacement: "--disable-ldaps"
    # Disable other features we don't have for cross-compilation
    - pattern: "--with-libpsl"
      replacement: "--without-libpsl"
    - pattern: "--with-libssh"
      replacement: "--without-libssh"
    # Disable threaded resolver (pthreads issues on IRIX)
    - pattern: "--enable-threaded-resolver"
      replacement: "--disable-threaded-resolver"
    # Remove missing files from %files section (disabled features)
    # Note: man page is installed even with --disable-manual, so keep it
    - pattern: "%{_datadir}/zsh"
      replacement: "# %{_datadir}/zsh # zsh completions not built"
