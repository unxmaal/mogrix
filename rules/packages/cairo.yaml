# cairo 1.18.0 - 2D graphics library (FC40: 1.18.0-3)
# Meson build. Needs pixman, freetype, fontconfig, glib2, libpng, X11.
# Built WITHOUT xcb (not ported), tee, svg (no librsvg).

package: cairo

rules:

  prep_commands:
    # csi-trace utility links basename from libgen.h but it doesn't resolve
    # in cross-compile. We don't need it (tools subpackage removed).
    - "$MOGRIX_ROOT/tools/safepatch util/cairo-script/meson.build --old \"conf.get('HAVE_LIBGEN_H', 0) == 1\" --new 'false' --no-backup --quiet"
    # IRIX has ctime_r in libc, but meson cross-compile can't detect it.
    # The static fallback in cairo-ps-surface.c conflicts with IRIX's extern declaration.
    - "perl -0777 -pi -e 's/^#ifndef HAVE_CTIME_R\\n.*?^#endif\\n//ms' src/cairo-ps-surface.c"
    # === Disable XRender support in xlib backend ===
    # IRIX X server lacks the RENDER extension (confirmed: 31 extensions, no RENDER).
    # Cairo with XRender compiled in crashes when trying to use RENDER protocol
    # on a server that doesn't support it. Disable at build time so cairo uses
    # pure xlib (XPutImage) for blitting — slower but works everywhere.
    # Change dependency to required:false so xlib backend builds without xrender.
    - "$MOGRIX_ROOT/tools/safepatch meson.build --old \"dependency('xrender', required: get_option('xlib')\" --new \"dependency('xrender', required: false\" --no-backup --quiet"
    # Also hide xrender.pc so meson can't find it even with required:false auto-detect
    - "$MOGRIX_ROOT/tools/safepatch meson.build --old \"dependency('xrender'\" --new \"dependency('xrender-disabled'\" --no-backup --quiet"
    # === Disable MIT-SHM (X shared memory) ===
    # IRIX IPC_RMID does NOT defer segment deletion — it destroys immediately.
    # Cairo calls shmctl(IPC_RMID) before the X server finishes reading the SHM
    # segment, causing the X server to error when it tries to access destroyed memory.
    # Small segments (4KB paints) survive by luck; large ones (512KB stroke fallback) fail.
    # Fix: remove XShm header checks so HAVE_X11_EXTENSIONS_XSHM_H is never set,
    # causing all SHM functions in cairo-xlib-surface-shm.c to be stubbed out.
    # Cairo will use regular XPutImage/XGetImage instead — slower but correct on IRIX.
    - "$MOGRIX_ROOT/tools/safepatch meson.build --delete-line 'XShm.h' --no-backup --quiet"
    - "$MOGRIX_ROOT/tools/safepatch meson.build --delete-line 'shmproto.h' --no-backup --quiet"
    - "$MOGRIX_ROOT/tools/safepatch meson.build --delete-line 'shmstr.h' --no-backup --quiet"

  drop_buildrequires:
    - gtk-doc
    - "pkgconfig(librsvg-2.0)"
    - "pkgconfig(xcb-render)"

  spec_replacements:
    # Replace %meson + %meson_build with raw meson commands using cross file
    - pattern: "%meson \\\n  -Dfreetype=enabled \\\n  -Dfontconfig=enabled \\\n  -Dglib=enabled \\\n  -Dgtk_doc=true \\\n  -Dspectre=disabled \\\n  -Dsymbol-lookup=disabled \\\n  -Dtee=enabled \\\n  -Dtests=disabled \\\n  -Dxcb=enabled \\\n  -Dxlib=enabled \\\n  %{nil}\n%meson_build"
      replacement: |
        MOGRIX_CROSS=/home/edodd/projects/github/unxmaal/mogrix/cross/meson-irix-cross.ini
        /home/edodd/.local/bin/meson setup _build \
          --cross-file=$MOGRIX_CROSS \
          --prefix=%{_prefix} \
          --libdir=%{_libdir} \
          -Dfreetype=enabled \
          -Dfontconfig=enabled \
          -Dglib=enabled \
          -Dgtk_doc=false \
          -Dspectre=disabled \
          -Dsymbol-lookup=disabled \
          -Dtee=disabled \
          -Dtests=disabled \
          -Dxcb=disabled \
          -Dxlib=enabled \
          -Dc_link_args="-L$COMPAT_DIR -lmogrix-compat" \
          --wrap-mode=nodownload
        /home/edodd/.local/bin/meson compile -C _build

    # Replace %meson_install
    - pattern: "%meson_install"
      replacement: "DESTDIR=$RPM_BUILD_ROOT /home/edodd/.local/bin/meson install -C _build --no-rebuild"

    # Add explicit Provides
    - pattern: "URL:            https://cairographics.org"
      replacement: |
        URL:            https://cairographics.org
        Provides: libcairo.so.2(mips-32)
        Provides: libcairo-gobject.so.2(mips-32)
        Provides: libcairo-script-interpreter.so.2(mips-32)
        Provides: cairo(mips-32) = %{version}-%{release}

    # Fix devel Requires (remove ISA)
    - pattern: "Requires: %{name}%{?_isa} = %{version}-%{release}\n\n%description devel"
      replacement: "Requires: %{name} = %{version}-%{release}\n\n%description devel"

    # Fix gobject Requires
    - pattern: "Requires: %{name}%{?_isa} = %{version}-%{release}\n\n%description gobject\n"
      replacement: "Requires: %{name} = %{version}-%{release}\n\n%description gobject\n"

    # Fix gobject-devel Requires
    - pattern: "Requires: %{name}-devel%{?_isa} = %{version}-%{release}\nRequires: %{name}-gobject%{?_isa} = %{version}-%{release}"
      replacement: "Requires: %{name}-devel = %{version}-%{release}\nRequires: %{name}-gobject = %{version}-%{release}"

    # Remove tools subpackage description (cairo-trace is MIPS binary, can't run on host)
    - pattern: "%package tools\nSummary: Development tools for cairo\nRequires: %{name}%{?_isa} = %{version}-%{release}\n\n%description tools\nCairo is a 2D graphics library designed to provide high-quality display\nand print output.\n\nThis package contains tools for working with the cairo graphics library.\n * cairo-trace: Record cairo library calls for later playback"
      replacement: "# tools subpackage removed (MIPS binaries, not runnable on build host)"

    # Fix %files - remove xcb/tee/svg references not built
    - pattern: "%{_libdir}/libcairo-script-interpreter.so.2*"
      replacement: "%{_libdir}/libcairo-script-interpreter.so.2*\n%{_libdir}/libcairo-gobject.so.2*"

    # Fix %files devel — remove xcb/tee/svg/gtk-doc references
    - pattern: "%files devel\n%dir %{_includedir}/cairo/\n%{_includedir}/cairo/cairo-deprecated.h\n%{_includedir}/cairo/cairo-features.h\n%{_includedir}/cairo/cairo-ft.h\n%{_includedir}/cairo/cairo.h\n%{_includedir}/cairo/cairo-pdf.h\n%{_includedir}/cairo/cairo-ps.h\n%{_includedir}/cairo/cairo-script-interpreter.h\n%{_includedir}/cairo/cairo-svg.h\n%{_includedir}/cairo/cairo-tee.h\n%{_includedir}/cairo/cairo-version.h\n%{_includedir}/cairo/cairo-xlib-xrender.h\n%{_includedir}/cairo/cairo-xlib.h\n%{_includedir}/cairo/cairo-script.h\n%{_includedir}/cairo/cairo-xcb.h\n%{_libdir}/libcairo.so\n%{_libdir}/libcairo-script-interpreter.so\n%{_libdir}/pkgconfig/cairo-fc.pc\n%{_libdir}/pkgconfig/cairo-ft.pc\n%{_libdir}/pkgconfig/cairo.pc\n%{_libdir}/pkgconfig/cairo-pdf.pc\n%{_libdir}/pkgconfig/cairo-png.pc\n%{_libdir}/pkgconfig/cairo-ps.pc\n%{_libdir}/pkgconfig/cairo-script-interpreter.pc\n%{_libdir}/pkgconfig/cairo-svg.pc\n%{_libdir}/pkgconfig/cairo-tee.pc\n%{_libdir}/pkgconfig/cairo-xlib.pc\n%{_libdir}/pkgconfig/cairo-xlib-xrender.pc\n%{_libdir}/pkgconfig/cairo-script.pc\n%{_libdir}/pkgconfig/cairo-xcb-shm.pc\n%{_libdir}/pkgconfig/cairo-xcb.pc\n%{_datadir}/gtk-doc/html/cairo"
      replacement: |
        %files devel
        %dir %{_includedir}/cairo/
        %{_includedir}/cairo/
        %{_libdir}/libcairo.so
        %{_libdir}/libcairo-script-interpreter.so
        %{_libdir}/libcairo-gobject.so
        %{_libdir}/pkgconfig/cairo*.pc

    # Remove gobject %files sections (merged into main + devel above)
    - pattern: "%files gobject\n%{_libdir}/libcairo-gobject.so.2*\n\n%files gobject-devel\n%{_includedir}/cairo/cairo-gobject.h\n%{_libdir}/libcairo-gobject.so\n%{_libdir}/pkgconfig/cairo-gobject.pc"
      replacement: "# gobject files merged into main and devel packages"

    # Remove tools %files section
    - pattern: "%files tools\n%{_bindir}/cairo-trace\n%{_libdir}/cairo/"
      replacement: "# tools files removed (MIPS binaries)"
