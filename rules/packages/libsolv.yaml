package: libsolv
aliases:
- lib%{libname}
rules:
  inject_compat_functions:
  - funopen
  - strcasestr
  - timegm
  - mkdtemp
  - openat
  drop_buildrequires:
  - ninja-build
  - swig
  - perl-devel
  - rubygems
  - zchunk-devel
  export_vars:
    PKG_CONFIG_PATH: /opt/sgug-staging/usr/sgug/lib32/pkgconfig
    PKG_CONFIG_LIBDIR: /opt/sgug-staging/usr/sgug/lib32/pkgconfig
    PKG_CONFIG_SYSROOT_DIR: /opt/sgug-staging
  spec_replacements:
  - pattern: '%bcond_without python_bindings'
    replacement: '%bcond_with python_bindings'
  - pattern: '%bcond_without perl_bindings'
    replacement: '%bcond_with perl_bindings'
  - pattern: '%bcond_without ruby_bindings'
    replacement: '%bcond_with ruby_bindings'
  - pattern: '%bcond_without zchunk'
    replacement: '%bcond_with zchunk'
  - pattern: '%bcond_without zstd'
    replacement: '%bcond_with zstd'
  - pattern: '%bcond_without conda'
    replacement: '%bcond_with conda'
  - pattern: '%bcond_without helix_repo'
    replacement: '%bcond_with helix_repo'
  - pattern: '%bcond_without suse_repo'
    replacement: '%bcond_with suse_repo'
  - pattern: '%bcond_without debian_repo'
    replacement: '%bcond_with debian_repo'
  - pattern: '%bcond_without arch_repo'
    replacement: '%bcond_with arch_repo'
  - pattern: '%bcond_without multi_semantics'
    replacement: '%bcond_with multi_semantics'
  - pattern: '%bcond_without appdata'
    replacement: '%bcond_with appdata'
  - pattern: '%bcond_without comps'
    replacement: '%bcond_with comps'
  - pattern: '%cmake -GNinja'
    replacement: "export COMPAT_DIR=$(pwd)/mogrix-compat\ncmake -B _build -S . \\\n  -DCMAKE_SYSTEM_NAME=IRIX \\\n  -DCMAKE_C_COMPILER=%{__cc} \\\n  -DCMAKE_CXX_COMPILER=%{__cxx} \\\n  -DCMAKE_AR=%{__ar}\
      \ \\\n  -DCMAKE_RANLIB=%{__ranlib} \\\n  -DCMAKE_INSTALL_PREFIX=%{_prefix} \\\n  -DCMAKE_INSTALL_LIBDIR=%{_libdir} \\\n  -DCMAKE_C_FLAGS=\"-I/opt/sgug-staging/usr/sgug/include/mogrix-compat/generic\"\
      \ \\\n  -DCMAKE_EXE_LINKER_FLAGS=\"-Wl,--whole-archive $COMPAT_DIR/libmogrix-compat.a -Wl,--no-whole-archive -lgen -lpthread\" \\\n  -DCMAKE_SHARED_LINKER_FLAGS=\"-Wl,--whole-archive $COMPAT_DIR/libmogrix-compat.a\
      \ -Wl,--no-whole-archive -lgen -lpthread\" \\\n  -DCMAKE_FIND_ROOT_PATH=/opt/sgug-staging/usr/sgug \\\n  -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY \\\n  -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY \\\n\
      \  -DRPM_INCLUDE_DIR=/opt/sgug-staging/usr/sgug/include \\\n  -DRPMDB_LIBRARY=/opt/sgug-staging/usr/sgug/lib32/librpm.so \\\n  -DRPMIO_LIBRARY=/opt/sgug-staging/usr/sgug/lib32/librpmio.so \\\n  -DLIBXML2_INCLUDE_DIR=/opt/sgug-staging/usr/sgug/include/libxml2\
      \ \\\n  -DLIBXML2_LIBRARY=/opt/sgug-staging/usr/sgug/lib32/libxml2.so \\\n  -DZLIB_LIBRARY=/opt/sgug-staging/usr/sgug/lib32/libz.so \\\n  -DZLIB_INCLUDE_DIR=/opt/sgug-staging/usr/sgug/include \\\n\
      \  -DBZIP2_LIBRARIES=/opt/sgug-staging/usr/sgug/lib32/libbz2.so \\\n  -DBZIP2_INCLUDE_DIR=/opt/sgug-staging/usr/sgug/include \\\n  -DLZMA_LIBRARY=/opt/sgug-staging/usr/sgug/lib32/liblzma.so \\\n \
      \ -DLZMA_INCLUDE_DIR=/opt/sgug-staging/usr/sgug/include \\\n  -DFEDORA=1 \\\n  -DENABLE_RPMDB=ON \\\n  -DENABLE_RPMDB_BYRPMHEADER=ON \\\n  -DENABLE_RPMDB_LIBRPM=ON \\\n  -DENABLE_RPMPKG_LIBRPM=ON\
      \ \\\n  -DENABLE_RPMMD=ON \\\n  -DUSE_VENDORDIRS=ON \\\n  -DWITH_LIBXML2=ON \\\n  -DENABLE_LZMA_COMPRESSION=ON \\\n  -DENABLE_BZIP2_COMPRESSION=ON \\\n  -DENABLE_COMPLEX_DEPS=ON \\\n  -DENABLE_ZSTD_COMPRESSION=OFF\
      \ \\\n  -DENABLE_ZCHUNK_COMPRESSION=OFF \\\n  -DENABLE_COMPS=OFF \\\n  -DENABLE_APPDATA=OFF \\\n  -DENABLE_HELIXREPO=OFF \\\n  -DENABLE_SUSEREPO=OFF \\\n  -DENABLE_DEBIAN=OFF \\\n  -DENABLE_ARCHREPO=OFF\
      \ \\\n  -DMULTI_SEMANTICS=OFF \\\n  -DENABLE_CONDA=OFF \\\n  -DENABLE_PERL=OFF \\\n  -DENABLE_RUBY=OFF \\\n  -DENABLE_PYTHON=OFF \\\n  -DHAVE_FUNOPEN=1\n"
  - pattern: '  -DFEDORA=1                                              \'
    replacement: '  # -DFEDORA=1 \'
  - pattern: '  -DENABLE_RPMDB=ON                                       \'
    replacement: '  # -DENABLE_RPMDB=ON \'
  - pattern: '  -DENABLE_RPMDB_BYRPMHEADER=ON                           \'
    replacement: '  # -DENABLE_RPMDB_BYRPMHEADER=ON \'
  - pattern: '  -DENABLE_RPMDB_LIBRPM=ON                                \'
    replacement: '  # -DENABLE_RPMDB_LIBRPM=ON \'
  - pattern: '  -DENABLE_RPMPKG_LIBRPM=ON                               \'
    replacement: '  # -DENABLE_RPMPKG_LIBRPM=ON \'
  - pattern: '  -DENABLE_RPMMD=ON                                       \'
    replacement: '  # -DENABLE_RPMMD=ON \'
  - pattern: '  -DENABLE_COMPS=%{__cmake_switch -b comps}               \'
    replacement: '  # -DENABLE_COMPS (handled above) \'
  - pattern: '  -DENABLE_APPDATA=%{__cmake_switch -b appdata}           \'
    replacement: '  # -DENABLE_APPDATA (handled above) \'
  - pattern: '  -DUSE_VENDORDIRS=ON                                     \'
    replacement: '  # -DUSE_VENDORDIRS=ON \'
  - pattern: '  -DWITH_LIBXML2=ON                                       \'
    replacement: '  # -DWITH_LIBXML2=ON \'
  - pattern: '  -DENABLE_LZMA_COMPRESSION=ON                            \'
    replacement: '  # -DENABLE_LZMA_COMPRESSION=ON \'
  - pattern: '  -DENABLE_BZIP2_COMPRESSION=ON                           \'
    replacement: '  # -DENABLE_BZIP2_COMPRESSION=ON \'
  - pattern: '  -DENABLE_ZSTD_COMPRESSION=%{__cmake_switch -b zstd}     \'
    replacement: '  # -DENABLE_ZSTD_COMPRESSION (handled above) \'
  - pattern: '  -DENABLE_ZCHUNK_COMPRESSION=%{__cmake_switch -b zchunk} \'
    replacement: '  # -DENABLE_ZCHUNK_COMPRESSION (handled above) \'
  - pattern: '  -DWITH_SYSTEM_ZCHUNK=ON                                 \'
    replacement: '  # -DWITH_SYSTEM_ZCHUNK=ON \'
  - pattern: '  -DENABLE_HELIXREPO=%{__cmake_switch -b helix_repo}      \'
    replacement: '  # -DENABLE_HELIXREPO (handled above) \'
  - pattern: '  -DENABLE_SUSEREPO=%{__cmake_switch -b suse_repo}        \'
    replacement: '  # -DENABLE_SUSEREPO (handled above) \'
  - pattern: '  -DENABLE_DEBIAN=%{__cmake_switch -b debian_repo}        \'
    replacement: '  # -DENABLE_DEBIAN (handled above) \'
  - pattern: '  -DENABLE_ARCHREPO=%{__cmake_switch -b arch_repo}        \'
    replacement: '  # -DENABLE_ARCHREPO (handled above) \'
  - pattern: '  -DMULTI_SEMANTICS=%{__cmake_switch -b multi_semantics}  \'
    replacement: '  # -DMULTI_SEMANTICS (handled above) \'
  - pattern: '  -DENABLE_COMPLEX_DEPS=%{__cmake_switch -b complex_deps} \'
    replacement: '  # -DENABLE_COMPLEX_DEPS (handled above) \'
  - pattern: '  -DENABLE_CONDA=%{__cmake_switch -b conda}               \'
    replacement: '  # -DENABLE_CONDA (handled above) \'
  - pattern: '  -DENABLE_PERL=%{__cmake_switch -b perl_bindings}        \'
    replacement: '  # -DENABLE_PERL (handled above) \'
  - pattern: '  -DENABLE_RUBY=%{__cmake_switch -b ruby_bindings}        \'
    replacement: '  # -DENABLE_RUBY (handled above) \'
  - pattern: '  -DENABLE_PYTHON=%{__cmake_switch -b python_bindings}    \'
    replacement: '  # -DENABLE_PYTHON (handled above) \'
  - pattern: '  -DPYTHON_EXECUTABLE=%{python3}                          \'
    replacement: '  # -DPYTHON_EXECUTABLE (disabled) \'
  - pattern: '%autosetup -p1'
    replacement: "%autosetup -p1\n\n# Fix const mismatch with newer libxml2 (xmlCtxtGetLastError returns const xmlError*)\nsed -i 's/xmlErrorPtr err = xmlCtxtGetLastError/const xmlError *err = xmlCtxtGetLastError/'\
      \ ext/solv_xmlparser.c\n\n# Add funopen declaration for IRIX (BSD-style cookie I/O)\n# This must be added before the #ifdef HAVE_FUNOPEN block\nsed -i '/#ifdef HAVE_FUNOPEN/i\\\n/* funopen declaration\
      \ for IRIX (provided by mogrix compat) */\\\nextern FILE *funopen(const void *cookie,\\\n                     int (*readfn)(void *, char *, int),\\\n                     int (*writefn)(void *, const\
      \ char *, int),\\\n                     off_t (*seekfn)(void *, off_t, int),\\\n                     int (*closefn)(void *));\n' ext/solv_xfopen.c\n"
  - pattern: '%cmake_build'
    replacement: cd _build && make %{?_smp_mflags}
  - pattern: '%cmake_install'
    replacement: cd _build && make install DESTDIR=%{buildroot}
  - pattern: '%files -n python3-%{libname}'
    replacement: '# Disabled: %files -n python3-%{libname}'
  - pattern: '%{python3_sitearch}/*'
    replacement: ''
  - pattern: '%files -n perl-%{libname}'
    replacement: '# Disabled: %files -n perl-%{libname}'
  - pattern: '%{perl_vendorarch}/*'
    replacement: ''
  - pattern: '%files -n ruby-%{libname}'
    replacement: '# Disabled: %files -n ruby-%{libname}'
  - pattern: '%{ruby_vendorarchdir}/*'
    replacement: ''
  - pattern: '%{_libdir}/%{name}.so.*'
    replacement: '%{_libdir}/%{name}.so'
  - pattern: '%{_libdir}/%{name}ext.so.*'
    replacement: '%{_libdir}/%{name}ext.so'
  - pattern: '%files devel

      %{_libdir}/%{name}.so

      %{_libdir}/%{name}ext.so

      '
    replacement: '%files devel

      # .so files owned by main package (no versioned libs on IRIX)

      '
