# dash package rules for IRIX cross-compilation
package: dash

rules:
  # IRIX has sigsetmask in libc but no header declaration for it.
  # Force configure to say "no" so dash uses the POSIX sigprocmask fallback
  # in system.h's sigclearmask() inline function.
  ac_cv_overrides:
    ac_cv_func_sigsetmask: "no"

  # stpncpy: dash uses stpncpy in jobs.c; IRIX libc doesn't have it.
  inject_compat_functions:
    - stpncpy

  prep_commands:
    # Fix undeclared vfork: IRIX doesn't declare vfork in <unistd.h>.
    # Define vfork as fork — functionally equivalent, universally available.
    - "sed -i '1i #define vfork fork' src/jobs.c"
    # IRIX uses _sys_siglist (with leading underscore) instead of sys_siglist.
    # dash's fallback strsignal() (compiled when HAVE_STRSIGNAL is undef)
    # references sys_siglist which doesn't exist on IRIX.
    - "sed -i '1i #define sys_siglist _sys_siglist' src/system.c"
    # builtins.def is generated by preprocessing builtins.def.in with $(COMPILE) -E.
    # Cross-compilation CPPFLAGS pulls in dicl-clang-compat/stdarg.h, whose
    # 'typedef' lines leak into builtins.def. mkbuiltins then parses 'typedef' as
    # a builtin command name, generating 'int typedef(int, char **)' — a C syntax
    # error. Fix: replace the direct -o with a pipe that filters typedef lines.
    - "sed -i 's#\\$(AM_V_CC)\\$(COMPILE) -E -x c -o \\$@ \\$<#$(AM_V_CC)$(COMPILE) -E -x c $< | grep -v \"^typedef\" > $@#' src/Makefile.in"
