# autoconf package rules for IRIX cross-compilation
package: autoconf

smoke_test:
  - command: "/usr/sgug/bin/autoconf --version"
    expect: "2.71"

# Autoconf is noarch (Perl scripts + m4 macros).
# No compilation needed, just packaging fixes.

rules:
  # Autoconf's configure checks for perl by running it. The PATH includes
  # staging (/opt/sgug-staging/usr/sgug/bin) which has our cross-compiled MIPS
  # perl that can't execute on x86_64. Force configure to use host perl.
  export_vars:
    PERL: "/usr/bin/perl"
    M4: "/usr/bin/m4"

  # Disable emacs support (not needed on IRIX)
  spec_replacements:
    - pattern: "%bcond_without autoconf_enables_emacs"
      replacement: "%bcond_with autoconf_enables_emacs"
    # The _emacs_sitelispdir macro may not be defined
    - pattern: "--with-lispdir=%{_emacs_sitelispdir}/autoconf"
      replacement: ""

  # Fix shebangs and hardcoded paths baked in from the build host:
  # - /usr/bin/perl → IRIX system perl 5.004, must use /usr/sgug/bin/perl
  # - /usr/bin/m4 → IRIX system m4 (not GNU), must use /usr/sgug/bin/m4
  install_cleanup:
    - "find %{buildroot}%{_bindir} -type f -exec grep -l '/usr/bin/perl' {} \\; | xargs -r sed -i 's|/usr/bin/perl|/usr/sgug/bin/perl|g'"
    - "find %{buildroot}%{_bindir} -type f -exec grep -l '/usr/bin/m4' {} \\; | xargs -r sed -i 's|/usr/bin/m4|/usr/sgug/bin/m4|g'"
