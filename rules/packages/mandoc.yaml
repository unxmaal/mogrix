# mandoc - man page compiler / formatter
package: mandoc

rules:
  drop_buildrequires:
    - perl-interpreter
    - "perl(IPC::Open3)"

  spec_replacements:
    # Remove Requires for update-alternatives (not available on IRIX)
    - pattern: "Requires(post):   %{_sbindir}/update-alternatives\nRequires(postun): %{_sbindir}/update-alternatives\nRequires(preun):  %{_sbindir}/update-alternatives"
      replacement: "# update-alternatives not available on IRIX"

    # Gut %postun section (alternatives)
    - pattern: "%postun\nif [ $1 -ge 1 ]; then\n    if [ \"$(readlink %{_sysconfdir}/alternatives/man)\" = \"%{_bindir}/man.mandoc\" ]; then\n        %{_sbindir}/alternatives --set man %{_bindir}/man.mandoc\n    fi\n\n    if [ \"$(readlink %{_sysconfdir}/alternatives/soelim)\" = \"%{_bindir}/soelim.mandoc\" ]; then\n        %{_sbindir}/alternatives --set soelim %{_bindir}/soelim.mandoc\n    fi\n\n    if [ \"$(readlink %{_sysconfdir}/alternatives/roff.7.gz)\" = \"%{_mandir}/man7/roff.mandoc.7.gz\" ]; then\n        %{_sbindir}/alternatives --set roff.7.gz %{_mandir}/man7/roff.mandoc.7.gz\n    fi\n\n    if [ \"$(readlink %{_sysconfdir}/alternatives/man.7.gz)\" = \"%{_mandir}/man7/man.mandoc.7.gz\" ]; then\n        %{_sbindir}/alternatives --set man.7.gz %{_mandir}/man7/man.mandoc.7.gz\n    fi\nfi"
      replacement: "%postun\n# no-op for IRIX"

    # Gut %post section (alternatives setup)
    - pattern: "%post\n%{_sbindir}/update-alternatives --install %{_bindir}/man man %{_bindir}/man.mandoc 200 \\\n    --slave %{_bindir}/apropos apropos %{_bindir}/apropos.mandoc \\\n    --slave %{_bindir}/whatis whatis %{_bindir}/whatis.mandoc \\\n    --slave %{_sbindir}/makewhatis makewhatis %{_sbindir}/makewhatis.mandoc \\\n    --slave %{_mandir}/man1/apropos.1.gz apropos.1.gz %{_mandir}/man1/apropos.mandoc.1.gz \\\n    --slave %{_mandir}/man1/man.1.gz man.1.gz %{_mandir}/man1/man.mandoc.1.gz \\\n    --slave %{_mandir}/man1/whatis.1.gz whatis.1.gz %{_mandir}/man1/whatis.mandoc.1.gz \\\n    --slave %{_mandir}/man8/makewhatis.8.gz makewhatis.8.gz %{_mandir}/man8/makewhatis.mandoc.8.gz\n\n%{_sbindir}/update-alternatives --install %{_bindir}/soelim soelim %{_bindir}/soelim.mandoc 200 \\\n    --slave %{_mandir}/man1/soelim.1.gz soelim.1.gz %{_mandir}/man1/soelim.mandoc.1.gz\n\n%{_sbindir}/update-alternatives --install %{_mandir}/man7/roff.7.gz roff.7.gz %{_mandir}/man7/roff.mandoc.7.gz 200 \\\n    --slave %{_mandir}/man7/eqn.7.gz eqn.7.gz %{_mandir}/man7/eqn.mandoc.7.gz \\\n    --slave %{_mandir}/man7/tbl.7.gz tbl.7.gz %{_mandir}/man7/tbl.mandoc.7.gz\n\n%{_sbindir}/update-alternatives --install %{_mandir}/man7/man.7.gz man.7.gz %{_mandir}/man7/man.mandoc.7.gz 200"
      replacement: "%post\n# no-op for IRIX"

    # Gut %preun section (alternatives remove)
    - pattern: "%preun\nif [ $1 -eq 0 ]; then\n    %{_sbindir}/update-alternatives --remove man %{_bindir}/man.mandoc\n    %{_sbindir}/update-alternatives --remove soelim %{_bindir}/soelim.mandoc\n    %{_sbindir}/update-alternatives --remove roff.7.gz %{_mandir}/man7/roff.mandoc.7.gz\n    %{_sbindir}/update-alternatives --remove man.7.gz %{_mandir}/man7/man.mandoc.7.gz\nfi"
      replacement: "%preun\n# no-op for IRIX"

    # Remove alternatives renaming and ghost touch in %install
    - pattern: "# Rename files for alternative usage\nmv %{buildroot}%{_bindir}/man %{buildroot}%{_bindir}/man.mandoc\nmv %{buildroot}%{_bindir}/apropos %{buildroot}%{_bindir}/apropos.mandoc\nmv %{buildroot}%{_bindir}/whatis %{buildroot}%{_bindir}/whatis.mandoc\nmv %{buildroot}%{_bindir}/soelim %{buildroot}%{_bindir}/soelim.mandoc\nmv %{buildroot}%{_sbindir}/makewhatis %{buildroot}%{_sbindir}/makewhatis.mandoc\nmv %{buildroot}%{_mandir}/man1/apropos.1 %{buildroot}%{_mandir}/man1/apropos.mandoc.1\nmv %{buildroot}%{_mandir}/man1/man.1 %{buildroot}%{_mandir}/man1/man.mandoc.1\nmv %{buildroot}%{_mandir}/man1/soelim.1 %{buildroot}%{_mandir}/man1/soelim.mandoc.1\nmv %{buildroot}%{_mandir}/man1/whatis.1 %{buildroot}%{_mandir}/man1/whatis.mandoc.1\nmv %{buildroot}%{_mandir}/man7/man.7 %{buildroot}%{_mandir}/man7/man.mandoc.7\nmv %{buildroot}%{_mandir}/man7/roff.7 %{buildroot}%{_mandir}/man7/roff.mandoc.7\nmv %{buildroot}%{_mandir}/man7/eqn.7 %{buildroot}%{_mandir}/man7/eqn.mandoc.7\nmv %{buildroot}%{_mandir}/man7/tbl.7 %{buildroot}%{_mandir}/man7/tbl.mandoc.7\nmv %{buildroot}%{_mandir}/man8/makewhatis.8 %{buildroot}%{_mandir}/man8/makewhatis.mandoc.8\n\n# Touch all the locations that update-alternatives will use\ntouch %{buildroot}%{_bindir}/man\ntouch %{buildroot}%{_bindir}/apropos\ntouch %{buildroot}%{_bindir}/whatis\ntouch %{buildroot}%{_bindir}/soelim\ntouch %{buildroot}%{_sbindir}/makewhatis\ntouch %{buildroot}%{_mandir}/man1/apropos.1\ntouch %{buildroot}%{_mandir}/man1/man.1\ntouch %{buildroot}%{_mandir}/man1/soelim.1\ntouch %{buildroot}%{_mandir}/man1/whatis.1\ntouch %{buildroot}%{_mandir}/man7/man.7\ntouch %{buildroot}%{_mandir}/man7/roff.7\ntouch %{buildroot}%{_mandir}/man7/eqn.7\ntouch %{buildroot}%{_mandir}/man7/tbl.7\ntouch %{buildroot}%{_mandir}/man8/makewhatis.8"
      replacement: "# alternatives disabled for IRIX — binaries installed directly"

    # Replace %files section — remove .gz, remove ghost/alternatives entries
    - pattern: "%files\n%license LICENSE\n%{_bindir}/demandoc\n%{_bindir}/mandoc\n%{_bindir}/apropos.mandoc\n%ghost %{_bindir}/apropos\n%{_bindir}/man.mandoc\n%ghost %{_bindir}/man\n%{_bindir}/soelim.mandoc\n%ghost %{_bindir}/soelim\n%{_bindir}/whatis.mandoc\n%ghost %{_bindir}/whatis\n%{_sbindir}/makewhatis.mandoc\n%ghost %{_sbindir}/makewhatis\n%{_mandir}/man1/demandoc.1.gz\n%{_mandir}/man1/mandoc.1.gz\n%{_mandir}/man1/apropos.mandoc.1.gz\n%ghost %{_mandir}/man1/apropos.1.gz\n%{_mandir}/man1/man.mandoc.1.gz\n%ghost %{_mandir}/man1/man.1.gz\n%{_mandir}/man1/soelim.mandoc.1.gz\n%ghost %{_mandir}/man1/soelim.1.gz\n%{_mandir}/man1/whatis.mandoc.1.gz\n%ghost %{_mandir}/man1/whatis.1.gz\n%{_mandir}/man5/mandoc.conf.5.gz\n%{_mandir}/man5/mandoc.db.5.gz\n%{_mandir}/man7/eqn.mandoc.7.gz\n%ghost %{_mandir}/man7/eqn.7.gz\n%{_mandir}/man7/mandoc_char.7.gz\n%{_mandir}/man7/man.mandoc.7.gz\n%ghost %{_mandir}/man7/man.7.gz\n%{_mandir}/man7/mdoc.7.gz\n%{_mandir}/man7/roff.mandoc.7.gz\n%ghost %{_mandir}/man7/roff.7.gz\n%{_mandir}/man7/tbl.mandoc.7.gz\n%ghost %{_mandir}/man7/tbl.7.gz\n%{_mandir}/man8/makewhatis.mandoc.8.gz\n%ghost %{_mandir}/man8/makewhatis.8.gz"
      replacement: "%files\n%license LICENSE\n%{_bindir}/demandoc\n%{_bindir}/mandoc\n%{_bindir}/apropos\n%{_bindir}/man\n%{_bindir}/soelim\n%{_bindir}/whatis\n%{_sbindir}/makewhatis\n%{_mandir}/man1/demandoc.1*\n%{_mandir}/man1/mandoc.1*\n%{_mandir}/man1/apropos.1*\n%{_mandir}/man1/man.1*\n%{_mandir}/man1/soelim.1*\n%{_mandir}/man1/whatis.1*\n%{_mandir}/man5/mandoc.conf.5*\n%{_mandir}/man5/mandoc.db.5*\n%{_mandir}/man7/eqn.7*\n%{_mandir}/man7/mandoc_char.7*\n%{_mandir}/man7/man.7*\n%{_mandir}/man7/mdoc.7*\n%{_mandir}/man7/roff.7*\n%{_mandir}/man7/tbl.7*\n%{_mandir}/man8/makewhatis.8*"
