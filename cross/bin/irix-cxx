#!/bin/sh
#
# IRIX C++ cross-compiler wrapper using clang++ + GCC 9 libstdc++
#
# This wrapper handles:
# - Preprocess only (-E): uses clang++ directly
# - Compile only (-c): uses clang++ directly
# - Link only (.o files, no source): uses LLD linker wrapper
# - Compile+link (has source and no -c): compiles with clang++, links with LLD
#
# Key differences from irix-cc:
# - Uses clang++ instead of clang
# - Uses -nostdlibinc -nostdinc++ to control header search paths
# - Adds GCC 9 libstdc++ headers (from SGUG-RSE)
# - Uses -D_LANGUAGE_C_PLUS_PLUS=1 instead of -D_LANGUAGE_C=1
# - Does NOT override __SGI_LIBC_BEGIN_EXTERN_C (needs extern "C" in C++ mode)
# - Links against libstdc++ and libgcc_s
#
# Deployed by: mogrix setup-cross
#

# Configurable paths - set by mogrix setup-cross
SYSROOT="${IRIX_SYSROOT:-/opt/irix-sysroot}"
STAGING="${SGUG_STAGING:-/opt/sgug-staging/usr/sgug}"
CLANG="${IRIX_CLANG:-/opt/cross/bin/clang++}"
LD="${STAGING}/bin/irix-ld"

# Header search order:
# 1. GCC 9 libstdc++ headers (C++ standard library)
# 2. GCC 9 target-specific headers (mips-sgi-irix6.5/bits)
# 3. SGUG mogrix compat headers (fix IRIX headers for cross-build)
# 4. SGUG clang compat headers (fix IRIX headers for clang)
# 5. SGUG staging headers (cross-built packages)
# 6. IRIX sysroot headers (pristine IRIX)
CLANG_FLAGS="--target=mips-sgi-irix6.5 -mabi=n32 -march=mips3"
# Disable default C/C++ header search — we provide explicit -isystem paths
CLANG_FLAGS="$CLANG_FLAGS -nostdlibinc -nostdinc++"
# Force-include our stdarg.h BEFORE anything else to define va_list correctly
# In C++ mode, va_list = char* to match IRIX declarations
CLANG_FLAGS="$CLANG_FLAGS -include $STAGING/include/dicl-clang-compat/stdarg.h"
CLANG_FLAGS="$CLANG_FLAGS -isystem $STAGING/include/c++/9"
CLANG_FLAGS="$CLANG_FLAGS -isystem $STAGING/include/c++/9/mips-sgi-irix6.5"
CLANG_FLAGS="$CLANG_FLAGS -isystem $STAGING/include/mogrix-compat/generic"
CLANG_FLAGS="$CLANG_FLAGS -isystem $STAGING/include/dicl-clang-compat"
CLANG_FLAGS="$CLANG_FLAGS -isystem $STAGING/include"
CLANG_FLAGS="$CLANG_FLAGS -isystem $SYSROOT/usr/include"
CLANG_FLAGS="$CLANG_FLAGS -D_SGI_SOURCE -D_SGI_MP_SOURCE -D_SGI_REENTRANT_FUNCTIONS"
CLANG_FLAGS="$CLANG_FLAGS -D__sgi=1 -D_LANGUAGE_C_PLUS_PLUS=1 -D_LONGLONG=1"
# IRIX bool/wchar_t type support flags
CLANG_FLAGS="$CLANG_FLAGS -D_BOOL -D_WCHAR_T_IS_KEYWORD"
# Prevent IRIX headers from typedef-ing wchar_t (it's a C++ keyword)
CLANG_FLAGS="$CLANG_FLAGS -D_WCHAR_T"
# IRIX C++ namespace macros: keep NAMESPACE_QUALIFIER empty so libstdc++ handles namespaces,
# but let sgimacros.h define EXTERN_C properly for extern "C" linkage
CLANG_FLAGS="$CLANG_FLAGS -D__SGI_LIBC_NAMESPACE_QUALIFIER="
CLANG_FLAGS="$CLANG_FLAGS -D__SGI_LIBC_BEGIN_NAMESPACE_STD="
CLANG_FLAGS="$CLANG_FLAGS -D__SGI_LIBC_END_NAMESPACE_STD="
CLANG_FLAGS="$CLANG_FLAGS -D__SGI_LIBC_USING_FROM_STD(x)="
# IRIX libc doesn't have __cxa_atexit (Itanium C++ ABI) — use atexit() instead
CLANG_FLAGS="$CLANG_FLAGS -fno-use-cxa-atexit"
# Use .ctors/.dtors instead of .init_array/.fini_array — IRIX rld doesn't support init_array
# Our crtbeginT.o/crtendT.o (linked by irix-ld) process .ctors at startup
CLANG_FLAGS="$CLANG_FLAGS -fno-use-init-array"

# Check if this is preprocess-only (-E flag present)
preprocess_only=false
if echo " $* " | grep -q " -E "; then
    preprocess_only=true
fi

# Check if this is compile-only (-c flag present)
compile_only=false
if echo " $* " | grep -q " -c "; then
    compile_only=true
fi

# Check if there are any C++ or C source files in the arguments
has_source=false
for arg in "$@"; do
    case "$arg" in
        *.cpp|*.cxx|*.cc|*.C|*.c|*.S|*.s)
            has_source=true
            break
            ;;
    esac
done

# Check if this is just linking (.o files only)
link_only=false
if [ "$has_source" = "false" ]; then
    link_only=true
fi

if [ "$preprocess_only" = "true" ]; then
    # Preprocess only - use clang++ directly
    exec $CLANG $CLANG_FLAGS "$@"
elif [ "$compile_only" = "true" ]; then
    # Compile only - use clang++ directly
    exec $CLANG $CLANG_FLAGS "$@"
elif [ "$link_only" = "true" ]; then
    # Link only - filter out compile-only flags and pass to LLD wrapper
    link_args=""
    next_is_output=false
    for arg in "$@"; do
        if [ "$next_is_output" = "true" ]; then
            link_args="$link_args -o $arg"
            next_is_output=false
            continue
        fi
        case "$arg" in
            -o)
                next_is_output=true
                ;;
            # Translate -Wl,xxx,yyy to xxx yyy (linker passthrough flags)
            -Wl,*)
                ld_flag=$(echo "$arg" | sed 's/^-Wl,//' | tr ',' ' ')
                link_args="$link_args $ld_flag"
                ;;
            # Skip compile-only flags (but not -Wl which is handled above)
            -D*|-I*|-W*|-O*|-g|-g[0-9]|-std=*|-c|-Q*|-f*|-m*)
                ;;
            # Skip compiler flags that LLD doesn't understand
            -static|-dynamic|-Bdynamic|-Bstatic|-pedantic|-pedantic-errors)
                ;;
            -pipe|-pthread|-traditional|-ansi|-w)
                ;;
            *)
                link_args="$link_args $arg"
                ;;
        esac
    done
    # Add C++ standard library for linking
    exec $LD $link_args -lstdc++ -lgcc_s
else
    # Compile + link in one step
    # We need to compile sources to objects, then link

    # Collect source files, output file, and other args
    sources=""
    objects=""
    output=""
    other_args=""
    libs=""
    next_is_output=false

    link_args=""
    for arg in "$@"; do
        if [ "$next_is_output" = "true" ]; then
            output="$arg"
            next_is_output=false
            continue
        fi
        case "$arg" in
            -o)
                next_is_output=true
                ;;
            *.cpp|*.cxx|*.cc|*.C|*.c|*.S|*.s)
                sources="$sources $arg"
                ;;
            *.o|*.a)
                objects="$objects $arg"
                ;;
            *.so|*.so.*)
                # Direct shared library references
                libs="$libs $arg"
                ;;
            -l*|-L*)
                libs="$libs $arg"
                ;;
            # Translate -Wl,xxx,yyy to xxx yyy for linker
            -Wl,*)
                ld_flag=$(echo "$arg" | sed 's/^-Wl,//' | tr ',' ' ')
                link_args="$link_args $ld_flag"
                ;;
            -D*|-I*|-W*|-O*|-g*|-f*|-m*|-std=*|-Q*)
                other_args="$other_args $arg"
                ;;
            # Skip link-only flags during compile phase
            -static|-dynamic|-Bdynamic|-Bstatic)
                ;;
            -shared)
                # Pass -shared to the linker
                link_args="$link_args -shared"
                ;;
            *)
                # Pass through other args
                other_args="$other_args $arg"
                ;;
        esac
    done

    # Default output name
    if [ -z "$output" ]; then
        output="a.out"
    fi

    # Compile sources to temp objects
    tmpdir=$(mktemp -d)
    trap "rm -rf $tmpdir" EXIT

    compiled_objs=""
    for src in $sources; do
        base=$(basename "$src" | sed 's/\.[cCsS].*$//')
        obj="$tmpdir/${base}.o"
        $CLANG $CLANG_FLAGS $other_args -c -o "$obj" "$src" || exit $?
        compiled_objs="$compiled_objs $obj"
    done

    # Link everything — add C++ standard library
    exec $LD $link_args -o "$output" $compiled_objs $objects $libs -lstdc++ -lgcc_s
fi
