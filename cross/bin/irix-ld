#!/bin/sh
#
# IRIX linker wrapper with automatic linker selection
#
# ============================================================================
# WARNING: DO NOT CHANGE LINKER SELECTION WITHOUT TESTING ON IRIX!
#
# KNOWN BAD FIX: Using GNU ld for executables causes SIGSEGV during rld init.
# This has been tried multiple times and always fails. If you're seeing
# relocation issues, the fix is to use LLD 18 with patches, NOT GNU ld.
#
# See: rules/methods/linker-selection.md
# ============================================================================
#
# Selects the appropriate linker based on the build type:
# - Shared libraries (-shared flag): Uses GNU ld with -z separate-code
#   Forces 3 LOAD segments (R/RE/RW) so IRIX rld can handle small .so files
#   Without this, small libs get a single RWE segment that crashes rld
# - Executables: Uses LLD 18 with IRIX patches (ld.lld-irix-18)
#   LLD 18 fixes the relocation bug in LLD 14 for external data symbols
#   --image-base=0x1000000 moves binary above rld quickstart table at 0x200000
#   giving 176MB of brk heap instead of 1.8MB (see irix-address-space.md)
#
# Deployed by: mogrix setup-cross
#

# Configurable paths - set by mogrix setup-cross or environment
SYSROOT="${IRIX_SYSROOT:-/opt/irix-sysroot}"
STAGING="${SGUG_STAGING:-/opt/sgug-staging/usr/sgug}"
# LLD 18 with IRIX patches - fixes relocation bug for external data symbols
LLD="${IRIX_LLD:-/home/edodd/projects/github/unxmaal/mogrix/tools/bin/ld.lld-irix-18}"
GNULD="${IRIX_GNULD:-/opt/cross/bin/mips-sgi-irix6.5-ld.bfd}"

# Filter out GCC-specific flags that don't apply to clang/lld
# and check for -shared in a single pass
# Also convert some flag formats for GNU ld compatibility
is_shared=0
filtered_args=""
for arg in "$@"; do
    case "$arg" in
        -shared)
            is_shared=1
            filtered_args="$filtered_args $arg"
            ;;
        -static-libgcc)
            # Skip GCC-specific flag - not meaningful for clang/lld
            ;;
        -rdynamic|--export-dynamic)
            # Skip: -rdynamic exports all symbols to dynamic table.
            # IRIX rld SIGSEGV on large dynamic symbol tables (468+ entries).
            # LLD also doesn't support -rdynamic directly.
            ;;
        --no-undefined|-z,no-undefined|--no-undefined-version)
            # Skip --no-undefined for cross builds: IRIX libc has TLS
            # references (__tls_get_addr) that can't be resolved at link time.
            # Shared libraries resolve symbols at load time via rld.
            ;;
        -soname,*)
            # Convert -soname,name to -soname name (GNU ld format)
            soname_val="${arg#-soname,}"
            filtered_args="$filtered_args -soname $soname_val"
            ;;
        *)
            filtered_args="$filtered_args $arg"
            ;;
    esac
done

if [ "$is_shared" = "1" ]; then
    # Shared library: use GNU ld with -z separate-code
    # Without -z separate-code, small .so files (no .data section) get a single
    # RWE LOAD segment that crashes IRIX rld. With -z separate-code, GNU ld
    # produces 3 LOAD segments (R / RE / RW) which IRIX rld handles correctly.
    # SGUG-RSE avoided this via patched binutils; we use the linker flag instead.
    exec $GNULD \
      -z separate-code \
      -L$STAGING/lib32 \
      -L$SYSROOT/lib32 \
      -L$SYSROOT/usr/lib32 \
      $filtered_args
else
    # Executable: use LLD with CRT files and soft float stubs
    # Use fixed CRT files (with .MIPS.events sections stripped)
    CRT1=$SYSROOT/usr/lib32/mips3/fixed/crt1.o
    CRTN=$SYSROOT/usr/lib32/mips3/fixed/crtn.o

    # --image-base=0x1000000: Move binary above rld quickstart table (0x200000)
    # Default base 0x10000 gives only 1.8MB of brk heap; 0x1000000 gives 176MB
    # See rules/methods/irix-address-space.md for full address map
    exec $LLD \
      --allow-shlib-undefined \
      --image-base=0x1000000 \
      -dynamic-linker /lib32/rld \
      $CRT1 \
      $filtered_args \
      -L$STAGING/lib32 \
      -L$SYSROOT/lib32 \
      -L$SYSROOT/usr/lib32 \
      -lsoft_float_stubs \
      -lc \
      $CRTN
fi
