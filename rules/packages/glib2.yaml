package: glib2
add_patch:
- glib2.sgifixes.patch
rules:
  drop_buildrequires:
  - libmount-devel
  - pkgconfig(mount)
  - pkgconfig(sysprof-capture-4)
  - pkgconfig(gi-docgen)
  - pkgconfig(libelf)
  - /usr/bin/g-ir-scanner
  - /usr/bin/marshalparser
  - /usr/bin/rst2man
  - meson
  drop_requires:
  - libgnutls.so.30()(64bit)
  - libgnutls.so.30
  - python3-packaging
  drop_subpackages:
  - doc
  - static
  - tests
  spec_replacements:
  - pattern: "%meson \\\n    -Dman=true \\\n    -Ddtrace=true \\\n    -Dsystemtap=true \\\n    -Dsysprof=enabled \\\n    -Dglib_debug=disabled \\\n    -Dgtk_doc=true \\\n    -Dinstalled_tests=true \\\n\
      \    -Dgnutls=true \\\n    --default-library=both \\\n    %{nil}\n\n%meson_build"
    replacement: "MOGRIX_CROSS=/home/edodd/projects/github/unxmaal/mogrix/cross/meson-irix-cross.ini\n/home/edodd/.local/bin/meson setup _build \\\n  --cross-file=$MOGRIX_CROSS \\\n  --prefix=%{_prefix}\
      \ \\\n  --libdir=%{_libdir} \\\n  -Dman=false \\\n  -Ddtrace=false \\\n  -Dsystemtap=false \\\n  -Dsysprof=disabled \\\n  -Dglib_debug=disabled \\\n  -Dgtk_doc=false \\\n  -Dinstalled_tests=false\
      \ \\\n  -Dgnutls=true \\\n  -Dlibmount=disabled \\\n  -Dselinux=disabled \\\n  -Dlibelf=disabled \\\n  -Dintrospection=disabled \\\n  -Dnls=disabled \\\n  -Dxattr=false \\\n  -Dtests=false \\\n  --default-library=shared\
      \ \\\n  -Dc_link_args=\"-L$COMPAT_DIR -lmogrix-compat\"\n/home/edodd/.local/bin/meson compile -C _build\n"
  - pattern: '%meson_install


      # We need reproducible .pyc files across architectures to support multilib installations

      # https://bugzilla.redhat.com/show_bug.cgi?id=2008912

      # https://docs.fedoraproject.org/en-US/packaging-guidelines/Python_Appendix/#_byte_compilation_reproducibility

      %global py_reproducible_pyc_path %{buildroot}%{_datadir}


      # Since this is a generated .py file, set it to a known timestamp

      # because the source timestamp is baked into the .pyc file

      # Also copy the timestamp for other .py files, because meson doesn''t

      # do this, see https://github.com/mesonbuild/meson/issues/5027.

      touch -r gio/gdbus-2.0/codegen/config.py.in %{buildroot}%{_datadir}/glib-2.0/codegen/*.py


      # Perform byte compilation manually to avoid issues with

      # irreproducibility of the default invalidation mode, see

      # https://www.python.org/dev/peps/pep-0552/ and

      # https://bugzilla.redhat.com/show_bug.cgi?id=1686078

      %py_byte_compile %{python3} %{buildroot}%{_datadir}


      mv %{buildroot}%{_bindir}/gio-querymodules %{buildroot}%{_bindir}/gio-querymodules-%{__isa_bits}

      sed -i -e "/^gio_querymodules=/s/gio-querymodules/gio-querymodules-%{__isa_bits}/" %{buildroot}%{_libdir}/pkgconfig/gio-2.0.pc


      mkdir -p %{buildroot}%{_libdir}/gio/modules

      touch %{buildroot}%{_libdir}/gio/modules/giomodule.cache


      %find_lang glib20'
    replacement: 'DESTDIR=$RPM_BUILD_ROOT /home/edodd/.local/bin/meson install -C _build --no-rebuild

      # Create gio modules directory

      mkdir -p %{buildroot}%{_libdir}/gio/modules

      # Remove Python bytecode (no python on IRIX)

      find %{buildroot} -name ''*.pyc'' -delete

      find %{buildroot} -name ''__pycache__'' -type d -exec rm -rf {} + 2>/dev/null || :

      '
  - pattern: '%transfiletriggerin -- %{_libdir}/gio/modules

      gio-querymodules-%{__isa_bits} %{_libdir}/gio/modules &> /dev/null || :


      %transfiletriggerpostun -- %{_libdir}/gio/modules

      gio-querymodules-%{__isa_bits} %{_libdir}/gio/modules &> /dev/null || :


      %transfiletriggerin -- %{_datadir}/glib-2.0/schemas

      glib-compile-schemas %{_datadir}/glib-2.0/schemas &> /dev/null || :


      %transfiletriggerpostun -- %{_datadir}/glib-2.0/schemas

      glib-compile-schemas %{_datadir}/glib-2.0/schemas &> /dev/null || :'
    replacement: '# File triggers removed for cross-compilation (cannot run MIPS binaries on build host)'
  - pattern: '%files -f glib20.lang'
    replacement: '%files'
  - pattern: '%{_libdir}/libgirepository-2.0.so.0*

      %dir %{_libdir}/girepository-1.0

      %{_libdir}/girepository-1.0/GIRepository-3.0.typelib

      %{_libdir}/girepository-1.0/GLib-2.0.typelib

      %{_libdir}/girepository-1.0/GLibUnix-2.0.typelib

      %{_libdir}/girepository-1.0/GModule-2.0.typelib

      %{_libdir}/girepository-1.0/GObject-2.0.typelib

      %{_libdir}/girepository-1.0/Gio-2.0.typelib

      %{_libdir}/girepository-1.0/GioUnix-2.0.typelib'
    replacement: '# girepository disabled for cross-compilation'
  - pattern: '%{_bindir}/gio-querymodules*'
    replacement: '%{_bindir}/gio-querymodules'
  - pattern: '%ghost %{_libdir}/gio/modules/giomodule.cache'
    replacement: '# giomodule.cache not generated during cross-build'
  - pattern: '%{_libexecdir}/gio-launch-desktop'
    replacement: '# gio-launch-desktop removed for cross-build'
  - pattern: '%{_mandir}/man1/gio.1*

      %{_mandir}/man1/gio-querymodules.1*

      %{_mandir}/man1/glib-compile-schemas.1*

      %{_mandir}/man1/gsettings.1*

      %{_mandir}/man1/gdbus.1*

      %{_mandir}/man1/gapplication.1*'
    replacement: '# man pages disabled for cross-build'
  - pattern: '%{_mandir}/man1/glib-genmarshal.1*

      %{_mandir}/man1/glib-gettextize.1*

      %{_mandir}/man1/glib-mkenums.1*

      %{_mandir}/man1/gi-compile-repository.1*

      %{_mandir}/man1/gi-decompile-typelib.1*

      %{_mandir}/man1/gi-inspect-typelib.1*

      %{_mandir}/man1/gobject-query.1*

      %{_mandir}/man1/gtester-report.1*

      %{_mandir}/man1/gtester.1*

      %{_mandir}/man1/gdbus-codegen.1*

      %{_mandir}/man1/glib-compile-resources.1*

      %{_mandir}/man1/gresource.1*'
    replacement: '# devel man pages disabled for cross-build'
  - pattern: '%dir %{_datadir}/gir-1.0

      %{_datadir}/gir-1.0/GIRepository-3.0.gir

      %{_datadir}/gir-1.0/GLib-2.0.gir

      %{_datadir}/gir-1.0/GLibUnix-2.0.gir

      %{_datadir}/gir-1.0/GModule-2.0.gir

      %{_datadir}/gir-1.0/GObject-2.0.gir

      %{_datadir}/gir-1.0/Gio-2.0.gir

      %{_datadir}/gir-1.0/GioUnix-2.0.gir'
    replacement: '# gir files disabled for cross-build'
  - pattern: '%{_datadir}/systemtap/'
    replacement: '# systemtap disabled for cross-build'
  - pattern: '%{_bindir}/gi-compile-repository

      %{_bindir}/gi-decompile-typelib

      %{_bindir}/gi-inspect-typelib'
    replacement: '# gi tools disabled (introspection off)'
  - pattern: '%{_datadir}/gdb/'
    replacement: '# gdb support files removed for cross-build'
  - pattern: '%{_datadir}/glib-2.0/gettext'
    replacement: '# glib-2.0/gettext removed (NLS disabled)'
  - pattern: '%{_bindir}/glib-gettextize'
    replacement: '# glib-gettextize removed (NLS disabled)'
  - pattern: '%{_datadir}/gettext/'
    replacement: '# gettext data removed (NLS disabled)'
  - pattern: 'Conflicts: gobject-introspection < 1.79.1'
    replacement: '# Conflicts removed for cross-build'
  - pattern: 'Conflicts: gobject-introspection-devel < 1.79.1'
    replacement: '# Conflicts removed for cross-build'
  - pattern: 'Requires: python3-packaging'
    replacement: '# python3-packaging not needed on IRIX'
  - pattern: 'Requires: pcre2-static

      Requires: sysprof-capture-static'
    replacement: '# static deps removed'
  - pattern: 'Provides: bundled(gvdb)

      Provides: bundled(libcharset)

      Provides: bundled(xdgmime)'
    replacement: 'Provides: bundled(gvdb)

      Provides: bundled(libcharset)

      Provides: bundled(xdgmime)

      Provides: glib2(mips-32) = %{version}-%{release}

      Provides: libglib-2.0.so.0

      Provides: libgobject-2.0.so.0

      Provides: libgio-2.0.so.0

      Provides: libgmodule-2.0.so.0

      Provides: libgthread-2.0.so.0

      '
  - pattern: '# For gnutls-hmac.patch. We now dlopen libgnutls.so.30 so that we can build a

      # static glib2 without depending on a static build of GnuTLS as well. This will

      # ensure we notice if the GnuTLS soname bumps, so that we can update our patch.

      %if 0%{?__isa_bits} == 64

      Requires: libgnutls.so.30()(64bit)

      %else

      Requires: libgnutls.so.30

      %endif'
    replacement: '# gnutls dlopen requirement handled by bundling'
  install_cleanup:
  - rm -rf %{buildroot}%{_datadir}/locale
  - rm -rf %{buildroot}%{_datadir}/gettext
  - rm -f %{buildroot}%{_bindir}/glib-gettextize
  - rm -rf %{buildroot}%{_datadir}/gdb
  - rm -rf %{buildroot}%{_libdir}/girepository-1.0
  - rm -rf %{buildroot}%{_datadir}/gir-1.0
  - rm -f %{buildroot}%{_libdir}/libgirepository-2.0.so*
  - rm -f %{buildroot}%{_bindir}/gi-compile-repository
  - rm -f %{buildroot}%{_bindir}/gi-decompile-typelib
  - rm -f %{buildroot}%{_bindir}/gi-inspect-typelib
  - rm -f %{buildroot}%{_libexecdir}/gio-launch-desktop
  - rm -rf %{buildroot}%{_datadir}/systemtap
