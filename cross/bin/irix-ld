#!/bin/sh
#
# IRIX linker wrapper with automatic linker selection
#
# ============================================================================
# WARNING: DO NOT CHANGE LINKER SELECTION WITHOUT TESTING ON IRIX!
#
# KNOWN BAD FIX: Using GNU ld for executables causes SIGSEGV during rld init.
# This has been tried multiple times and always fails. If you're seeing
# relocation issues, the fix is to use LLD 18 with patches, NOT GNU ld.
#
# See: rules/methods/linker-selection.md
# ============================================================================
#
# Selects the appropriate linker based on the build type:
# - Shared libraries (-shared flag): Uses GNU ld (mips-sgi-irix6.5-ld.bfd)
#   GNU ld produces the correct 2-LOAD-segment layout that IRIX expects
# - Executables: Uses LLD 18 with IRIX patches (ld.lld-irix-18)
#   LLD 18 fixes the relocation bug in LLD 14 for external data symbols
#
# Deployed by: mogrix setup-cross
#

# Configurable paths - set by mogrix setup-cross or environment
SYSROOT="${IRIX_SYSROOT:-/opt/irix-sysroot}"
STAGING="${SGUG_STAGING:-/opt/sgug-staging/usr/sgug}"
# LLD 18 with IRIX patches - fixes relocation bug for external data symbols
LLD="${IRIX_LLD:-/home/edodd/projects/github/unxmaal/mogrix/tools/bin/ld.lld-irix-18}"
GNULD="${IRIX_GNULD:-/opt/cross/bin/mips-sgi-irix6.5-ld.bfd}"

# Filter out GCC-specific flags that don't apply to clang/lld
# and check for -shared in a single pass
# Also convert some flag formats for GNU ld compatibility
is_shared=0
filtered_args=""
for arg in "$@"; do
    case "$arg" in
        -shared)
            is_shared=1
            filtered_args="$filtered_args $arg"
            ;;
        -static-libgcc)
            # Skip GCC-specific flag - not meaningful for clang/lld
            ;;
        -soname,*)
            # Convert -soname,name to -soname name (GNU ld format)
            soname_val="${arg#-soname,}"
            filtered_args="$filtered_args -soname $soname_val"
            ;;
        *)
            filtered_args="$filtered_args $arg"
            ;;
    esac
done

if [ "$is_shared" = "1" ]; then
    # Shared library: use GNU ld (produces correct IRIX segment layout)
    # GNU ld creates 2 LOAD segments; LLD creates 3 which crashes IRIX rld
    exec $GNULD \
      -L$SYSROOT/lib32 \
      -L$SYSROOT/usr/lib32 \
      -L$STAGING/lib32 \
      $filtered_args
else
    # Executable: use LLD with CRT files and soft float stubs
    # Use fixed CRT files (with .MIPS.events sections stripped)
    CRT1=$SYSROOT/usr/lib32/mips3/fixed/crt1.o
    CRTN=$SYSROOT/usr/lib32/mips3/fixed/crtn.o

    exec $LLD \
      --allow-shlib-undefined \
      -dynamic-linker /lib32/rld \
      $CRT1 \
      $filtered_args \
      -L$SYSROOT/lib32 \
      -L$SYSROOT/usr/lib32 \
      -L$STAGING/lib32 \
      -lsoft_float_stubs \
      -lc \
      $CRTN
fi
