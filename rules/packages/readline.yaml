# readline - Command line editing library
# Build system: autoconf (custom shlib build, no libtool)
# SGUG-RSE reference: packages/readline/
#
# Key fixes:
# 1. shobj-conf IRIX case uses MIPSpro flags (-K PIC, -no_unresolved)
#    which don't work with clang. Patch uses GCC-compatible flags and
#    adds -ltinfo for termcap symbols.
# 2. shlib-install doesn't recognize 'irix' (without version number) —
#    configure normalizes mips-sgi-irix6.5 to mips-unknown-irix. So
#    .so symlinks must be created manually after install.
#
# Note: Do NOT use SGUG-RSE's readline-8.2-shlib.sgi.patch — it conflicts
# with Fedora's readline-8.0-shlib.patch (both modify same Makefile.in line).
# Fedora's patch already handles that fix.
package: readline

add_patch:
  - readline-8.2-shobj-irix-clang.patch

rules:
  spec_replacements:
    # After make_install: create .so symlinks and fix pkg-config
    # shlib-install doesn't create symlinks because host_os='irix' doesn't
    # match the 'irix[56]*' pattern in the symlink creation case.
    - pattern: "%make_install"
      replacement: "%make_install\n\n# Create .so symlinks (shlib-install doesn't recognize 'irix' without version)\nln -sf libreadline.so.8 $RPM_BUILD_ROOT%{_libdir}/libreadline.so\nln -sf libhistory.so.8 $RPM_BUILD_ROOT%{_libdir}/libhistory.so\n\n# Add tinfo to pkg-config (termcap symbols in libtinfo.so)\nperl -pi -e \"s|: ncurses|: ncurses tinfo|g\" $RPM_BUILD_ROOT%{_libdir}/pkgconfig/readline.pc"

    # IRIX shared libs use major-only versioning (libreadline.so.8 not .so.8.2)
    # Fix %files to match what actually gets installed
    - pattern: "%{_libdir}/libreadline.so.*\n%{_libdir}/libhistory.so.*"
      replacement: "%{_libdir}/libreadline.so.8\n%{_libdir}/libhistory.so.8"
