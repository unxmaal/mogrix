# popt - command line option parsing library
# Requires compat functions previously provided by libdicl
# Successfully cross-compiled for IRIX N32

package: popt

rules:
  # Compat functions needed (replaces libdicl-devel dependency)
  inject_compat_functions:
    - strdup
    - strndup

  # Fix stpcpy conflict - popt's system.h defines static inline stpcpy which
  # conflicts with our mogrix-compat/generic/string.h declaration
  # Comment out the entire function (lines 31-38 in src/system.h)
  prep_commands:
    - "sed -i '/^static inline char \\* stpcpy/,/^}$/s/^/\\/\\/ /' src/system.h"

  # Configure options for cross-compilation
  configure_opts:
    - --disable-nls

  # Export LD for libtool - use GNU ld for IRIX-compatible shared libraries
  # GNU ld produces correct 2-LOAD-segment layout; LLD's 3-segment layout crashes IRIX
  export_vars:
    LD: "/opt/cross/bin/mips-sgi-irix6.5-ld.bfd"

  # Remove .la files (not needed)
  install_cleanup:
    - "find $RPM_BUILD_ROOT -name '*.la' -delete"

  # Skip find_lang (no NLS)
  skip_find_lang: true

  # Remove %files -f lang reference
  files_no_lang: true

  # Package-specific autoconf cache overrides
  ac_cv_overrides:
    ac_cv_func_strerror_r_char_p: "no"
    # IRIX doesn't have these wide character functions
    ac_cv_func_mbsnrtowcs: "no"
    ac_cv_func_mbsrtowcs: "no"

  # Libtool needs help finding the right linker - the wrapper handles this
  spec_replacements:
    # Fix libtool linker detection - use irix-cc which internally uses correct linker
    - pattern: "export LD=\"/opt/cross/bin/mips-sgi-irix6.5-ld.bfd\""
      replacement: |
        export LD="/opt/cross/bin/mips-sgi-irix6.5-ld.bfd"
        # Tell libtool to use our CC for linking (handles linker selection internally)
        export lt_cv_prog_compiler_static_works=no
