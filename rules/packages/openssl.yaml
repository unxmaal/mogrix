package: openssl
rules:
  drop_buildrequires:
  - lksctp-tools-devel
  drop_requires:
  - ca-certificates
  - crypto-policies
  inject_compat_functions:
  - secure_getenv
  - _rld_new_interface
  prep_commands:
  - sed -i '/internal\/numbers.h/a\extern char *strerror_r(int errnum, char *buf, size_t buflen);' include/internal/e_os.h
  export_vars:
    CC: /opt/sgug-staging/usr/sgug/bin/irix-cc
    AR: /opt/cross/bin/llvm-ar
    RANLIB: /opt/cross/bin/llvm-ranlib
  spec_replacements:
  - pattern: sslarch=%{_os}-%{_target_cpu}
    replacement: 'sslarch=irix-mips3-gcc

      sslflags="no-asm no-async no-dgram no-afalgeng no-tests -mabi=n32"'
  - pattern: sslarch="linux-mips32 -mips32r2"
    replacement: '# sslarch="linux-mips32 -mips32r2" # disabled for IRIX'
  - pattern: enable-fips
    replacement: no-fips
  - pattern: enable-ktls
    replacement: no-ktls
  - pattern: sslflags=enable-ec_nistp_64_gcc_128
    replacement: '# sslflags=enable-ec_nistp_64_gcc_128 # disabled for IRIX'
  - pattern: enable-sctp
    replacement: no-sctp
  - pattern: -Wa,--generate-missing-build-notes=yes
    replacement: ''
  - pattern: make -s %{?_smp_mflags} all
    replacement: make -s %{?_smp_mflags} EX_LIBS="-L$COMPAT_DIR -lmogrix-compat" all
  - pattern: 'Patch42: openssl-1.1.1-fips.patch'
    replacement: '# Patch42: openssl-1.1.1-fips.patch # disabled for IRIX'
  - pattern: 'Patch48: openssl-1.1.1-fips-post-rand.patch'
    replacement: '# Patch48: openssl-1.1.1-fips-post-rand.patch # disabled for IRIX'
  - pattern: 'Patch62: openssl-1.1.1-fips-curves.patch'
    replacement: '# Patch62: openssl-1.1.1-fips-curves.patch # disabled for IRIX'
  - pattern: 'Patch65: openssl-1.1.1-fips-drbg-selftest.patch'
    replacement: '# Patch65: openssl-1.1.1-fips-drbg-selftest.patch # disabled for IRIX'
  - pattern: 'Patch66: openssl-1.1.1-fips-dh.patch'
    replacement: '# Patch66: openssl-1.1.1-fips-dh.patch # disabled for IRIX'
  - pattern: 'Patch70: openssl-1.1.1-rewire-fips-drbg.patch'
    replacement: '# Patch70: openssl-1.1.1-rewire-fips-drbg.patch # disabled for IRIX'
  - pattern: 'Patch53: openssl-1.1.1-fips-crng-test.patch'
    replacement: '# Patch53: openssl-1.1.1-fips-crng-test.patch # disabled for IRIX'
  - pattern: '%patch42 -p1 -b .fips'
    replacement: '# %patch42 -p1 -b .fips # disabled for IRIX'
  - pattern: '%patch48 -p1 -b .fips-post-rand'
    replacement: '# %patch48 -p1 -b .fips-post-rand # disabled for IRIX'
  - pattern: '%patch62 -p1 -b .fips-curves'
    replacement: '# %patch62 -p1 -b .fips-curves # disabled for IRIX'
  - pattern: '%patch65 -p1 -b .fips-drbg-selftest'
    replacement: '# %patch65 -p1 -b .fips-drbg-selftest # disabled for IRIX'
  - pattern: '%patch66 -p1 -b .fips-dh'
    replacement: '# %patch66 -p1 -b .fips-dh # disabled for IRIX'
  - pattern: '%patch70 -p1 -b .rewire-fips-drbg'
    replacement: '# %patch70 -p1 -b .rewire-fips-drbg # disabled for IRIX'
  - pattern: '%patch53 -p1 -b .fips-crng-test'
    replacement: '# %patch53 -p1 -b .fips-crng-test # disabled for IRIX'
  - pattern: '#embed HMAC into fips provider for test run

      OPENSSL_CONF=/dev/null LD_LIBRARY_PATH=. apps/openssl dgst -binary -sha256 -mac HMAC -macopt hexkey:f4556650ac31d35461610bac4ed81b1a181b2d8a43ea2854cbae22ca74560813 < providers/fips.so > providers/fips.so.hmac

      objcopy --update-section .rodata1=providers/fips.so.hmac providers/fips.so providers/fips.so.mac

      mv providers/fips.so.mac providers/fips.so'
    replacement: '# FIPS HMAC embedding disabled for IRIX (no-fips build)'
  - pattern: "OPENSSL_CONF=/dev/null LD_LIBRARY_PATH=. apps/openssl dgst -binary -sha256 -mac HMAC -macopt hexkey:f4556650ac31d35461610bac4ed81b1a181b2d8a43ea2854cbae22ca74560813 < $RPM_BUILD_ROOT%{_libdir}/ossl-modules/fips.so\
      \ > $RPM_BUILD_ROOT%{_libdir}/ossl-modules/fips.so.hmac \\\n    objcopy --update-section .rodata1=$RPM_BUILD_ROOT%{_libdir}/ossl-modules/fips.so.hmac $RPM_BUILD_ROOT%{_libdir}/ossl-modules/fips.so\
      \ $RPM_BUILD_ROOT%{_libdir}/ossl-modules/fips.so.mac \\\n    mv $RPM_BUILD_ROOT%{_libdir}/ossl-modules/fips.so.mac $RPM_BUILD_ROOT%{_libdir}/ossl-modules/fips.so \\\n    rm $RPM_BUILD_ROOT%{_libdir}/ossl-modules/fips.so.hmac\
      \ \\"
    replacement: '# FIPS spec_install_post disabled for IRIX (no-fips build) \'
  - pattern: rename so.%{soversion} so.%{version} $RPM_BUILD_ROOT%{_libdir}/*.so.%{soversion}
    replacement: for f in $RPM_BUILD_ROOT%{_libdir}/*.so.%{soversion}; do mv "$f" "${f%.%{soversion}}.%{version}"; done
  - pattern: install -d $RPM_BUILD_ROOT{%{_bindir},%{_includedir},%{_libdir},%{_mandir},%{_libdir}/openssl,%{_pkgdocdir}}
    replacement: install -d $RPM_BUILD_ROOT%{_bindir} $RPM_BUILD_ROOT%{_includedir} $RPM_BUILD_ROOT%{_libdir} $RPM_BUILD_ROOT%{_mandir} $RPM_BUILD_ROOT%{_libdir}/openssl $RPM_BUILD_ROOT%{_pkgdocdir}
  - pattern: 'pushd $RPM_BUILD_ROOT%{_mandir}

      mv man5/config.5ossl man5/openssl.cnf.5

      popd'
    replacement: (cd $RPM_BUILD_ROOT%{_mandir} && mv man5/config.5ossl man5/openssl.cnf.5)
  install_cleanup:
  - ln -sf configuration-mips.h $RPM_BUILD_ROOT%{_includedir}/openssl/configuration-mips64.h
  - sed -i 's|^ssl_conf = ssl_module|# ssl_conf = ssl_module
  - sed -i 's|^\.include = /etc/crypto-policies|# .include = /etc/crypto-policies
  - sed -i 's|= /etc/pki/|= /usr/sgug/etc/pki/|g' $RPM_BUILD_ROOT%{_sysconfdir}/pki/tls/openssl.cnf
