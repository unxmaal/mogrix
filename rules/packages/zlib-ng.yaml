# zlib-ng - zlib replacement with optimizations
# FC40 replacement for classic zlib
# Use zlib-ng-compat subpackage for libz.so.1 compatibility

package: zlib-ng

rules:
  # Export CC for CMake cross-compilation
  export_vars:
    CC: "/opt/sgug-staging/usr/sgug/bin/irix-cc"
    CXX: "/opt/sgug-staging/usr/sgug/bin/irix-cc"
    LD: "/opt/cross/bin/mips-sgi-irix6.5-ld.bfd"
    AR: "/opt/cross/bin/llvm-ar"
    RANLIB: "/opt/cross/bin/llvm-ranlib"

  spec_replacements:
    # Disable sanitizers build option
    - pattern: "%{?with_sanitizers:-DWITH_SANITIZER=ON}"
      replacement: "-DWITH_SANITIZER=OFF"

    # Replace %cmake macro with explicit cmake command for cross-compilation
    # First occurrence: main zlib-ng build
    - pattern: "%cmake %{cmake_param}\n%cmake_build"
      replacement: |
        mkdir -p %{_vpath_builddir}
        cd %{_vpath_builddir}
        cmake \
          -DCMAKE_INSTALL_PREFIX=%{_prefix} \
          -DCMAKE_INSTALL_LIBDIR=%{_libdir} \
          -DCMAKE_INSTALL_INCLUDEDIR=%{_includedir} \
          -DCMAKE_C_COMPILER=$CC \
          -DCMAKE_C_FLAGS="-I/usr/sgug/include/mogrix-compat/generic -D_SGI_SOURCE -D__EXTENSIONS__ -D_XOPEN_SOURCE=600" \
          -DCMAKE_SYSTEM_NAME=IRIX \
          -DCMAKE_CROSSCOMPILING=TRUE \
          -DWITH_SANITIZER=OFF \
          -DBUILD_SHARED_LIBS=ON \
          -DZLIB_ENABLE_TESTS=OFF \
          -DWITH_OPTIM=OFF \
          -DWITH_NATIVE_INSTRUCTIONS=OFF \
          ..
        cmake --build . -j$(nproc)
        cd ..

    # Second occurrence: compat build
    - pattern: "%cmake %{cmake_param} -DZLIB_COMPAT=ON -DWITH_NEW_STRATEGIES=OFF\n%cmake_build"
      replacement: |
        mkdir -p %{_vpath_builddir}-compat
        cd %{_vpath_builddir}-compat
        cmake \
          -DCMAKE_INSTALL_PREFIX=%{_prefix} \
          -DCMAKE_INSTALL_LIBDIR=%{_libdir} \
          -DCMAKE_INSTALL_INCLUDEDIR=%{_includedir} \
          -DCMAKE_C_COMPILER=$CC \
          -DCMAKE_C_FLAGS="-I/usr/sgug/include/mogrix-compat/generic -D_SGI_SOURCE -D__EXTENSIONS__ -D_XOPEN_SOURCE=600" \
          -DCMAKE_SYSTEM_NAME=IRIX \
          -DCMAKE_CROSSCOMPILING=TRUE \
          -DWITH_SANITIZER=OFF \
          -DZLIB_COMPAT=ON \
          -DWITH_NEW_STRATEGIES=OFF \
          -DZLIB_ENABLE_TESTS=OFF \
          -DWITH_OPTIM=OFF \
          -DWITH_NATIVE_INSTRUCTIONS=OFF \
          ..
        cmake --build . -j$(nproc)
        cd ..

    # Replace %cmake_install for main build
    - pattern: "%global __cmake_builddir %{_vpath_builddir}\n%cmake_install"
      replacement: |
        cd %{_vpath_builddir}
        DESTDIR=%{buildroot} cmake --install .
        # Create versioned library symlinks (cmake doesn't do this for IRIX)
        cd %{buildroot}%{_libdir}
        mv libz-ng.so libz-ng.so.%{version}
        ln -s libz-ng.so.%{version} %{soname}
        ln -s %{soname} libz-ng.so
        cd -
        cd ..

    # Replace %cmake_install for compat build
    - pattern: "%global __cmake_builddir %{_vpath_builddir}-compat\n%cmake_install"
      replacement: |
        cd %{_vpath_builddir}-compat
        DESTDIR=%{buildroot} cmake --install .
        # Create versioned library symlinks for compat build
        cd %{buildroot}%{_libdir}
        mv libz.so libz.so.%{zlib_ver}.zlib-ng
        ln -s libz.so.%{zlib_ver}.zlib-ng %{compat_soname}
        ln -s %{compat_soname} libz.so
        cd -
        cd ..
