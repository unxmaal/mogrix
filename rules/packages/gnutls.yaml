package: gnutls
rules:
  drop_requires:
  - crypto-policies
  - crypto-policies-scripts
  - p11-kit-trust
  drop_buildrequires:
  - trousers-devel
  - mingw*
  prep_commands:
  - sed -i 's/#define _Thread_local __thread/#define _Thread_local/' lib/gthreads.h
  ac_cv_overrides:
    gl_cv_func_working_getdelim: 'yes'
  configure_flags:
    add:
    - --disable-doc
    - --disable-gtk-doc
    - --disable-guile
    - --disable-dane
    - --disable-hardware-acceleration
    - --without-tpm
    - --without-tpm2
    - --without-idn
    - --disable-libdane
    - --disable-valgrind-tests
    - --without-p11-kit
    - --with-default-trust-store-file=%{_sysconfdir}/pki/tls/certs/ca-bundle.crt
  configure_disable:
  - seccomp-tests
  spec_replacements:
  - pattern: '%bcond_without dane'
    replacement: '%bcond_with dane'
  - pattern: '%bcond_without fips'
    replacement: '%bcond_with fips'
  - pattern: '%bcond_without tpm2'
    replacement: '%bcond_with tpm2'
  - pattern: '%bcond_without gost'
    replacement: '%bcond_with gost'
  - pattern: '%bcond_without mingw'
    replacement: '%bcond_with mingw'
  - pattern: '%bcond_without bootstrap'
    replacement: '%bcond_with bootstrap'
  - pattern: '           --enable-ktls \

      '
    replacement: ''
  - pattern: '           --with-default-trust-store-pkcs11="pkcs11:" \

      '
    replacement: ''
  - pattern: '           --with-system-priority-file=%{_sysconfdir}/crypto-policies/back-ends/gnutls.config \

      '
    replacement: ''
  - pattern: --with-default-priority-string="@SYSTEM"
    replacement: --with-default-priority-string="NORMAL"
  - pattern: pushd native_build
    replacement: cd native_build
  - pattern: popd
    replacement: cd ..
  - pattern: '%{_mandir}/man3/*

      '
    replacement: ''
  - pattern: '%{_infodir}/gnutls*

      '
    replacement: ''
  - pattern: '%{_infodir}/pkcs11-vision*

      '
    replacement: ''
  - pattern: '%{_bindir}/p11tool

      '
    replacement: ''
  - pattern: '%{_mandir}/man1/*

      '
    replacement: ''
  - pattern: '%{_docdir}/manual/*

      '
    replacement: ''
  - pattern: '%files -f native_build/gnutls.lang'
    replacement: '%files'
  install_cleanup:
  - rm -rf %{buildroot}%{_docdir}/manual
