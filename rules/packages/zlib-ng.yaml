# zlib-ng - zlib replacement with optimizations
# FC40 replacement for classic zlib
# Use zlib-ng-compat subpackage for libz.so.1 compatibility
#
# ---metadata---
# complexity: medium
# build_system: cmake
# key_fixes: [_XOPEN_SOURCE_600, cmake_cross, static_and_shared]
# similar_to: [rpm, libsolv]
# depends: []
# status: WORKING
# warning: Installing to /usr/sgug can break sshd (uses libz)
# ---

package: zlib-ng

rules:
  # Add IRIX-specific patch for UINT64_C macro
  add_patch:
    - "zlib-ng-inttypes.patch"

  spec_replacements:
    # Disable sanitizers build option
    - pattern: "%{?with_sanitizers:-DWITH_SANITIZER=ON}"
      replacement: "-DWITH_SANITIZER=OFF"

    # Replace main build cmake+cmake_build
    - pattern: |
        %cmake %{cmake_param}
        %cmake_build
      replacement: |
        mkdir -p %{_vpath_builddir}
        cd %{_vpath_builddir}
        export CFLAGS="-D_SGI_SOURCE -D__EXTENSIONS__ -D_XOPEN_SOURCE=600"
        cmake \
          -DCMAKE_INSTALL_PREFIX=%{_prefix} \
          -DCMAKE_INSTALL_LIBDIR=%{_libdir} \
          -DCMAKE_INSTALL_INCLUDEDIR=%{_includedir} \
          -DCMAKE_C_COMPILER=$CC \
          -DCMAKE_SYSTEM_NAME=IRIX \
          -DCMAKE_CROSSCOMPILING=TRUE \
          -DWITH_SANITIZER=OFF \
          -DBUILD_SHARED_LIBS=ON \
          -DZLIB_ENABLE_TESTS=OFF \
          -DWITH_OPTIM=OFF \
          -DWITH_NATIVE_INSTRUCTIONS=OFF \
          ..
        cmake --build . -j$(nproc)
        cd ..

    # Replace compat build cmake+cmake_build
    - pattern: |
        %cmake %{cmake_param} -DZLIB_COMPAT=ON -DWITH_NEW_STRATEGIES=OFF
        %cmake_build
      replacement: |
        mkdir -p %{_vpath_builddir}-compat
        cd %{_vpath_builddir}-compat
        export CFLAGS="-D_SGI_SOURCE -D__EXTENSIONS__ -D_XOPEN_SOURCE=600"
        cmake \
          -DCMAKE_INSTALL_PREFIX=%{_prefix} \
          -DCMAKE_INSTALL_LIBDIR=%{_libdir} \
          -DCMAKE_INSTALL_INCLUDEDIR=%{_includedir} \
          -DCMAKE_C_COMPILER=$CC \
          -DCMAKE_SYSTEM_NAME=IRIX \
          -DCMAKE_CROSSCOMPILING=TRUE \
          -DWITH_SANITIZER=OFF \
          -DZLIB_COMPAT=ON \
          -DWITH_NEW_STRATEGIES=OFF \
          -DZLIB_ENABLE_TESTS=OFF \
          -DWITH_OPTIM=OFF \
          -DWITH_NATIVE_INSTRUCTIONS=OFF \
          ..
        cmake --build . -j$(nproc)
        cd ..

    # Replace main install
    - pattern: |
        %global __cmake_builddir %{_vpath_builddir}
        %cmake_install
      replacement: |
        cd %{_vpath_builddir}
        DESTDIR=%{buildroot} cmake --install .
        # Create versioned library symlinks (cmake doesn't do this for IRIX)
        cd %{buildroot}%{_libdir}
        mv libz-ng.so libz-ng.so.%{version}
        ln -s libz-ng.so.%{version} %{soname}
        ln -s %{soname} libz-ng.so
        cd -
        cd ..

    # Replace compat install
    - pattern: |
        %global __cmake_builddir %{_vpath_builddir}-compat
        %cmake_install
      replacement: |
        cd %{_vpath_builddir}-compat
        DESTDIR=%{buildroot} cmake --install .
        # Create versioned library symlinks for compat build
        cd %{buildroot}%{_libdir}
        mv libz.so libz.so.%{zlib_ver}.zlib-ng
        ln -s libz.so.%{zlib_ver}.zlib-ng %{compat_soname}
        ln -s %{compat_soname} libz.so
        cd -
        cd ..

  export_vars:
    CC: "/opt/sgug-staging/usr/sgug/bin/irix-cc"
    CXX: "/opt/sgug-staging/usr/sgug/bin/irix-cc"
    LD: "/opt/cross/bin/mips-sgi-irix6.5-ld.bfd"
    AR: "/opt/cross/bin/llvm-ar"
    RANLIB: "/opt/cross/bin/llvm-ranlib"
