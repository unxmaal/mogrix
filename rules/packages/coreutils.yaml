package: coreutils
classes:
- nls-disabled
smoke_test:
- command: /usr/sgug/bin/ls --version
  expect: '9.4'
- command: /usr/sgug/bin/cat --version
  expect: '9.4'
- command: echo hello | /usr/sgug/bin/head -1
  expect: hello
rules:
  inject_compat_functions:
  - strcasestr
  drop_buildrequires:
  - attr
  - hostname
  - libselinux-utils
  - strace
  - glibc-langpack-fr
  - glibc-langpack-ko
  - perl-interpreter
  - perl(FileHandle)
  drop_requires:
  - '%{name}-common = %{version}-%{release}'
  drop_subpackages:
  - single
  - common
  ac_cv_overrides:
    ac_cv_func_lchmod: 'no'
    gl_cv_func_closefrom: 'yes'
    ac_cv_func_posix_memalign: 'no'
    gl_cv_func_posix_memalign_works: 'no'
    ac_cv_func_strcasestr: 'no'
    gl_cv_func_strcasestr_linear: 'no'
    ac_cv_func_pthread_sigmask: 'yes'
    gl_cv_func_pthread_sigmask_macro: 'no'
    gl_cv_func_pthread_sigmask_in_libc_works: 'yes'
    gl_cv_func_pthread_sigmask_in_LIBMULTITHREAD: 'yes'
  spec_replacements:
  - pattern: 'Source105:  coreutils-colorls.sh'
    replacement: 'Source51:   coreutils-colorls.sh'
  - pattern: 'Source106:  coreutils-colorls.csh'
    replacement: 'Source52:   coreutils-colorls.csh'
  - pattern: '%SOURCE105'
    replacement: '%{SOURCE51}'
  - pattern: '%SOURCE106'
    replacement: '%{SOURCE52}'
  - pattern: autoreconf -fiv
    replacement: 'AUTOPOINT=true autoreconf -fiv

      sed -i ''s/gnulib-tests//'' Makefile.in || true

      sed -i ''s/gnulib-tests//'' Makefile.am || true'
  - pattern: '%configure $config_single'
    replacement: LIBS="$LIBS -lpthread" %configure --disable-year2038 --disable-xattr --without-selinux --without-openssl --without-libgmp $config_single
  - pattern: --enable-no-install-program=kill,uptime
    replacement: --enable-no-install-program=kill,uptime,stdbuf,pinky,who,users,seq
  - pattern: ln -fv ../lib/parse-datetime.{c,y} .
    replacement: ln -fv ../lib/parse-datetime.c ../lib/parse-datetime.y .
  - pattern: --enable-systemd
    replacement: --disable-systemd
  - pattern: mkdir -p $RPM_BUILD_ROOT/$subdir/{%{_bindir},%{_sbindir}}
    replacement: mkdir -p $RPM_BUILD_ROOT/$subdir/%{_bindir} $RPM_BUILD_ROOT/$subdir/%{_sbindir}
  - pattern: mv $RPM_BUILD_ROOT/$subdir/{%_bindir,%_sbindir}/chroot
    replacement: mv $RPM_BUILD_ROOT/$subdir/%{_bindir}/chroot $RPM_BUILD_ROOT/$subdir/%{_sbindir}/chroot
  - pattern: install -p -c -m644 DIR_COLORS{,.lightbgcolor}
    replacement: install -p -c -m644 DIR_COLORS DIR_COLORS.lightbgcolor
  - pattern: rm -f $RPM_BUILD_ROOT%{_infodir}/dir
    replacement: rm -rf $RPM_BUILD_ROOT%{_infodir}
  - pattern: for type in separate single; do
    replacement: for type in separate; do
  - pattern: '%exclude %{_bindir}/*.single'
    replacement: '# (removed — no single/multicall build)'
  - pattern: '%dir %{_libexecdir}/coreutils'
    replacement: '# (removed — no multicall libexec)'
  - pattern: '%{_libexecdir}/coreutils/*.so'
    replacement: '# (removed — no multicall .so files)'
  - pattern: cp %SOURCE50 .
    replacement: 'cp %SOURCE50 .

      sed -i ''/pinky/d; /stdbuf/d; /\/users$/d; /\/who$/d; /\/seq$/d'' supported_utils'
  prep_commands:
  - "$MOGRIX_ROOT/tools/safepatch lib/malloc/dynarray_at_failure.c --old '%zu' --new '%u' --count 0 --no-backup --quiet || true; $MOGRIX_ROOT/tools/safepatch lib/malloc/dynarray_at_failure.c --old '%zd' --new '%d' --count 0 --no-backup --quiet || true; $MOGRIX_ROOT/tools/safepatch lib/malloc/dynarray_at_failure.c --old '%zx' --new '%x' --count 0 --no-backup --quiet || true"
  install_cleanup:
  - rm -rf %{buildroot}%{_infodir}
  - rm -rf %{buildroot}%{_mandir}
  - rm -rf %{buildroot}%{_sysconfdir}/DIR_COLORS*
  - rm -rf %{buildroot}%{_sysconfdir}/profile.d
  - rm -f %{buildroot}%{_libdir}/charset.alias
