# xz - LZMA compression utilities and library
# Provides liblzma needed by rpm and libsolv
#
# ---metadata---
# complexity: high
# build_system: autoconf
# key_fixes: [libtool_shared, doc_generation_disable, doxygen_disable]
# similar_to: [popt, libxml2]
# depends: []
# status: WORKING
# ---

package: xz

rules:
  # NOTE: skip_check is inherited from generic.yaml

  # Compat functions that may be needed

  # gnupg2 drop_buildrequires handled by generic.yaml

  # Configure flags
  configure_flags:
    add:
      - --disable-silent-rules
      - --disable-doc         # Don't build documentation
      - --disable-nls         # Don't install locale files
      - --disable-scripts     # Don't install shell scripts (they need grep)
      - --disable-xz          # Don't build xz binary (saves complexity)
      - --disable-xzdec       # Don't build xzdec binary
      - --disable-lzmadec     # Don't build lzmadec binary
      - --disable-lzmainfo    # Don't build lzmainfo binary
      - --enable-shared
      - --enable-static

  spec_replacements:
    # Skip autoreconf - the tarball has pre-generated configure
    - pattern: "autoreconf -fi"
      replacement: "# autoreconf -fi - skipped (pre-generated configure available)"
    # Fix libtool for IRIX using generic script
    - pattern: "sed -i 's|^runpath_var=LD_RUN_PATH|runpath_var=DIE_RPATH_DIE|g' libtool"
      replacement: |
        sed -i 's|^runpath_var=LD_RUN_PATH|runpath_var=DIE_RPATH_DIE|g' libtool
        # Fix libtool for IRIX
        $MOGRIX_ROOT/tools/fix-libtool-irix.sh libtool || exit 1
    # Remove Source100/101 since they conflict with mogrix compat sources
    - pattern: "Source100:	colorxzgrep.sh"
      replacement: "# Source100: colorxzgrep.sh - removed (conflict with mogrix compat)"
    - pattern: "Source101:	colorxzgrep.csh"
      replacement: "# Source101: colorxzgrep.csh - removed (conflict with mogrix compat)"
    # Remove grep dependency (not needed when scripts are disabled)
    - pattern: "Requires:	grep >= 2.20-5"
      replacement: "# Requires: grep >= 2.20-5 - not needed (scripts disabled)"
    # Skip find_lang since we build minimal
    - pattern: "%find_lang %name"
      replacement: "# %find_lang %name - skipped (minimal build)"
    # Skip profile.d installation since scripts are disabled
    - pattern: "mkdir -p %{buildroot}%{profiledir}"
      replacement: "# mkdir -p %{buildroot}%{profiledir} - skipped (scripts disabled)"
    - pattern: "install -p -m 644 %{SOURCE100} %{buildroot}%{profiledir}"
      replacement: "# install colorxzgrep.sh - skipped"
    - pattern: "install -p -m 644 %{SOURCE101} %{buildroot}%{profiledir}"
      replacement: "# install colorxzgrep.csh - skipped"
    # Simplify %files section - we're only building the library
    - pattern: "%files -f %{name}.lang"
      replacement: "%files"
    # Remove bindir entries (disabled)
    - pattern: "%{_bindir}/*xz*"
      replacement: "# %{_bindir}/*xz* - binaries disabled"
    # Remove manpages for binaries
    - pattern: "%{_mandir}/man1/*xz*"
      replacement: "# %{_mandir}/man1/*xz* - binaries disabled"
    # Remove language-specific manpages
    - pattern: "%lang(de) %{_mandir}/de/man1/*xz*"
      replacement: ""
    - pattern: "%lang(fr) %{_mandir}/fr/man1/*xz*"
      replacement: ""
    - pattern: "%lang(ko) %{_mandir}/ko/man1/*xz*"
      replacement: ""
    - pattern: "%lang(ro) %{_mandir}/ro/man1/*xz*"
      replacement: ""
    - pattern: "%lang(uk) %{_mandir}/uk/man1/*xz*"
      replacement: ""
    - pattern: "%lang(pt_BR) %{_mandir}/pt_BR/man1/*xz*"
      replacement: ""
    # Remove profiledir
    - pattern: "%{profiledir}/*"
      replacement: ""
    # Remove lzma-compat files
    - pattern: "%{_bindir}/*lz*"
      replacement: "# %{_bindir}/*lz* - binaries disabled"
    - pattern: "%{_mandir}/man1/*lz*"
      replacement: "# %{_mandir}/man1/*lz* - binaries disabled"
    - pattern: "%lang(de) %{_mandir}/de/man1/*lz*"
      replacement: ""
    - pattern: "%lang(fr) %{_mandir}/fr/man1/*lz*"
      replacement: ""
    - pattern: "%lang(ko) %{_mandir}/ko/man1/*lz*"
      replacement: ""
    - pattern: "%lang(ro) %{_mandir}/ro/man1/*lz*"
      replacement: ""
    - pattern: "%lang(uk) %{_mandir}/uk/man1/*lz*"
      replacement: ""
    - pattern: "%lang(pt_BR) %{_mandir}/pt_BR/man1/*lz*"
      replacement: ""
    # Include all library files (versioned and unversioned)
    - pattern: "%{_libdir}/lib*.so.5*"
      replacement: "%{_libdir}/liblzma.so*"
    # Remove doc directory entries (--disable-doc)
    - pattern: "%doc %{_pkgdocdir}"
      replacement: "# %doc %{_pkgdocdir} - docs disabled"
    - pattern: "%exclude %_pkgdocdir/examples*"
      replacement: ""
    - pattern: "%doc %_pkgdocdir/examples*"
      replacement: "# %doc examples* - docs disabled"

