package: libretls

add_source:
  - arc4random_irix.h
  - getentropy_irix.c

upstream:
  url: https://git.causal.agency/libretls
  version: "3.8.1"
  ref: "3.8.1"
  type: git
  build_system: autoconf
  license: ISC
  summary: "Port of libtls from LibreSSL to OpenSSL"
  source_dir: libretls-3.8.1
rules:
  inject_compat_functions:
    - err
  explicit_provides:
    - "libtls.so.28"
    - "pkgconfig(libtls)"
  export_vars:
    CFLAGS: "-Wno-deprecated-declarations"
  prep_commands:
    # --- IRIX platform support for arc4random/getentropy ---
    #
    # libretls bundles arc4random + getentropy with per-OS variants.
    # IRIX needs: (a) arc4random locking via pthreads + /dev/zero mmap,
    # (b) getentropy via /dev/urandom, (c) MAP_ANON definition.

    # 1. Install IRIX arc4random platform header
    - "cp %{_sourcedir}/arc4random_irix.h compat/arc4random_irix.h"

    # 2. Add __sgi case to arc4random.h before the #else fallback
    - "sed -i 's/^#else$/#elif defined(__sgi)\\n#include \"arc4random_irix.h\"\\n#else/' compat/arc4random.h"

    # 3. Install IRIX getentropy (reads /dev/urandom)
    - "cp %{_sourcedir}/getentropy_irix.c compat/getentropy_irix.c"

    # 4. Replace Linux getentropy with IRIX version in Makefile.am.
    # Also strip the HOST_LINUX conditional around it â€” IRIX doesn't match
    # any HOST_* guard, so the file would never be compiled otherwise.
    - "sed -i 's|compat/getentropy_linux\\.c|compat/getentropy_irix.c|g' Makefile.am"
    - |
      perl -0777 -pi -e '
        s/if HOST_LINUX\nlibcompat_la_SOURCES \+= compat\/getentropy_irix\.c\nendif/libcompat_la_SOURCES += compat\/getentropy_irix.c/s
      ' Makefile.am

    # 5. Fix MAP_ANON: IRIX has no MAP_ANON or MAP_ANONYMOUS
    # Define MAP_ANON as 0 (our arc4random_irix.h uses /dev/zero instead)
    - "sed -i 's/#error \"System does not support mapping anonymous pages?\"/#define MAP_ANON 0/' include/compat/sys/mman.h"
