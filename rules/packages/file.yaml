# file - File type identification utility
# Needs compat functions
#
# ---metadata---
# complexity: medium
# build_system: autoconf
# key_fixes: [posix_spawn_file_actions, mogrix_compat_linking, getopt_long]
# similar_to: [elfutils]
# depends: [zlib]
# status: WORKING
# ---

package: file

rules:
  # Compat functions needed
  inject_compat_functions:
    - strdup
    - strndup
    - getline
    - asprintf
    - getopt_long

  # Drop libdicl dependency
  drop_buildrequires:
    - libdicl-devel
    - libdicl

  drop_requires:
    - libdicl
    - libdicl-devel

  # Autoconf cache overrides
  ac_cv_overrides:
    ac_cv_func_malloc_0_nonnull: "yes"
    ac_cv_func_realloc_0_nonnull: "yes"
    ac_cv_func_getopt_long: "yes"

  # Add staging library path for cross-compiled shared libs
  export_vars:
    LDFLAGS: "-L/opt/sgug-staging/usr/sgug/lib32"

  # Configure flags
  configure_flags:
    add:
      - --disable-silent-rules
      - --enable-fsect-man5
      - --enable-shared

  # Remove libdicl setup lines
  remove_lines:
    - 'export CPPFLAGS="-I%{_includedir}/libdicl-0.1"'
    - 'export LIBS="-ldicl-0.1"'

  # Disable Python bindings (no Python in cross-compile environment)
  spec_replacements:
    - pattern: "%bcond_without python2"
      replacement: "%bcond_with python2"
    - pattern: "%bcond_without python3"
      replacement: "%bcond_with python3"
    # Force libtool to build shared libraries for cross-compilation
    - pattern: "# remove hardcoded library paths from local libtool"
      replacement: |
        # Fix libtool to build shared libs for cross-compilation
        sed -i 's|^build_libtool_libs=no|build_libtool_libs=yes|g' libtool
        sed -i 's|^deplibs_check_method=.*|deplibs_check_method=pass_all|g' libtool
        sed -i 's|^soname_spec=.*|soname_spec="\\$libname\\$release\\$shared_ext.\\$major"|g' libtool
        sed -i 's|^library_names_spec=.*|library_names_spec="\\$libname\\$release\\$shared_ext.\\$versuffix \\$libname\\$release\\$shared_ext.\\$major \\$libname\\$shared_ext"|g' libtool
        # Add mogrix-compat library to src/Makefile LIBS
        sed -i "s|^LIBS = |LIBS = -L$(pwd)/mogrix-compat -lmogrix-compat |g" src/Makefile
        # remove hardcoded library paths from local libtool
    # Change file-libs %files to handle both .so and .so.* patterns
    - pattern: "%{_libdir}/*so.*"
      replacement: "%{_libdir}/*.so*"
