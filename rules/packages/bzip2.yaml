# bzip2 - file compression utility
# Uses Makefile-based build (not autotools)
#
# ---metadata---
# complexity: low
# build_system: make
# key_fixes: [test_target_removal, bash_brace_expansion]
# similar_to: [lua]
# depends: []
# status: WORKING
# ---
#
# Cross-compilation notes:
# - gpgverify and gnupg2 removal handled by generic rules
# - The Makefile has "all: ... test" which tries to run the binary
# - This fails during cross-compilation since MIPS binaries can't run on x86
# - We use prep_commands to remove the test dependency from the all target
#
package: bzip2

# Use existing patch file instead of sed
add_patch:
  - disable-test.patch

rules:
  # Export CC for cross-compilation (bzip2 uses Makefile, not autotools)
  export_vars:
    CC: "/opt/sgug-staging/usr/sgug/bin/irix-cc"
    AR: "/opt/cross/bin/llvm-ar"
    RANLIB: "/opt/cross/bin/llvm-ranlib"

  # Replace undefined %{__global_ldflags} with empty string
  # Fedora spec uses this macro but we don't define it in cross-compilation
  spec_replacements:
    - pattern: "%{__global_ldflags}"
      replacement: ""
    # Fix bash brace expansion in mkdir (sh doesn't support it)
    # Original: mkdir -p $RPM_BUILD_ROOT{%{_bindir},%{_mandir}/man1,%{_libdir}/pkgconfig,%{_includedir}}
    - pattern: "mkdir -p $RPM_BUILD_ROOT{%{_bindir},%{_mandir}/man1,%{_libdir}/pkgconfig,%{_includedir}}"
      replacement: "mkdir -p $RPM_BUILD_ROOT%{_bindir} $RPM_BUILD_ROOT%{_mandir}/man1 $RPM_BUILD_ROOT%{_libdir}/pkgconfig $RPM_BUILD_ROOT%{_includedir}"
