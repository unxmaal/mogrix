# gdbm - GNU database routines (FC40: 1.23)
# Simple autoconf build. Deps: readline (staged). Required by man-db.
# IRIX fixes: iswblank() compat, disable TLS (__tls_get_addr unsupported by IRIX rld).
package: gdbm

rules:
  drop_buildrequires:
    - libtool

  prep_commands:
    # IRIX has isblank() but not iswblank() — provide compat
    - "$MOGRIX_ROOT/tools/safepatch tools/wordwrap.c --insert-top $'#include <ctype.h>\\n#ifndef iswblank\\n#define iswblank(c) isblank((unsigned char)(c))\\n#endif' --no-backup --quiet"
    # IRIX rld doesn't support TLS (__tls_get_addr). gdbm uses __thread for
    # gdbm_errno — cross-compile test passes but runtime crashes on IRIX.
    # The configure test unconditionally overwrites the variable (not AC_CACHE_VAL),
    # so we must patch configure directly.
    - "$MOGRIX_ROOT/tools/safepatch configure --old 'gdbm_cv__thread=__thread' --new 'gdbm_cv__thread=' --no-backup --quiet"

  spec_replacements:
    # Fix devel Requires — remove %{?_isa} and Requires(post/preun) info
    - pattern: "Requires: %{name}%{?_isa} = %{epoch}:%{version}-%{release}\nRequires(post): info\nRequires(preun): info"
      replacement: "Requires: %{name} = %{epoch}:%{version}-%{release}"
    # Fix main Requires — remove %{?_isa}
    - pattern: "Requires: %{name}-libs%{?_isa} = %{epoch}:%{version}-%{release}"
      replacement: "Requires: %{name}-libs = %{epoch}:%{version}-%{release}"
