# popt - command line option parsing library
# Requires compat functions previously provided by libdicl
# Successfully cross-compiled for IRIX N32

package: popt

rules:
  # Compat functions needed (replaces libdicl-devel dependency)
  # Build as static archive for subdirectory builds (tests/)
  inject_compat_functions:
    - strdup
    - strndup

  # Drop libdicl dependency (we inject compat sources instead)
  drop_buildrequires:
    - libdicl-devel
    - libdicl

  # Drop runtime Requires on libdicl
  drop_requires:
    - libdicl
    - libdicl-devel

  # Lines to remove (libdicl CPPFLAGS setup)
  remove_lines:
    - 'export CPPFLAGS="-I%{_includedir}/libdicl-0.1"'
    - 'export LIBS="-ldicl-0.1"'

  # Configure options for cross-compilation
  configure_opts:
    - --disable-nls

  # Export LD for libtool - use GNU ld for IRIX-compatible shared libraries
  # GNU ld produces correct 2-LOAD-segment layout; LLD's 3-segment layout crashes IRIX
  export_vars:
    LD: "/opt/cross/bin/mips-sgi-irix6.5-ld.bfd"

  # Remove .la files (not needed)
  install_cleanup:
    - "find $RPM_BUILD_ROOT -name '*.la' -delete"

  # Skip find_lang (no NLS)
  skip_find_lang: true

  # Remove %files -f lang reference
  files_no_lang: true

  # Autoconf cache overrides for cross-compilation
  ac_cv_overrides:
    ac_cv_func_malloc_0_nonnull: "yes"
    ac_cv_func_realloc_0_nonnull: "yes"
    ac_cv_func_strerror_r_char_p: "no"
