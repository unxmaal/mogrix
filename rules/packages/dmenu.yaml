# dmenu - suckless dynamic menu for X (FC40: 5.2)
# Plain Makefile build. Uses X11, Xft, fontconfig from IRIX/staging.
package: dmenu

rules:

  prep_commands:
    # Disable Xinerama (not available on IRIX)
    - "sed -i 's/^XINERAMALIBS.*/#XINERAMALIBS =/' config.mk"
    - "sed -i 's/^XINERAMAFLAGS.*/#XINERAMAFLAGS =/' config.mk"
    # Fix %zu format — IRIX libc doesn't support it (size_t is 4 bytes on n32)
    - "sed -i 's/%zu/%u/g' dmenu.c"
    # Remove _XOPEN_SOURCE=700 and _POSIX_C_SOURCE — they hide IRIX functions.
    # _SGI_SOURCE (default) provides all POSIX/XSI/BSD.
    - "sed -i 's/-D_XOPEN_SOURCE=700//; s/-D_POSIX_C_SOURCE=200809L//' config.mk"
    # Fix paths in config.mk for cross-compilation against staging sysroot.
    # X11INC/X11LIB use target paths (/usr/sgug/...) — these are already on the
    # search path via irix-cc's -isystem. FREETYPEINC needs the FULL staging path
    # because /usr/sgug/include/freetype2 is a subdirectory not on the default
    # -isystem list, and -I target-paths don't exist on the build host.
    - "sed -i 's|X11INC = /usr/X11R6/include|X11INC = /usr/sgug/include|' config.mk"
    - "sed -i 's|X11LIB = /usr/X11R6/lib|X11LIB = /usr/sgug/lib32|' config.mk"
    - "sed -i 's|FREETYPEINC = /usr/include/freetype2|FREETYPEINC = /opt/sgug-staging/usr/sgug/include/freetype2|' config.mk"
    # IRIX X11R6.3 Xutil.h doesn't transitively include keysym.h like modern X11.
    # dmenu uses XK_Escape, XK_BackSpace etc. without including it directly.
    - "sed -i '/#include <X11\\/Xft\\/Xft.h>/a\\#include <X11/keysym.h>' dmenu.c"

  spec_replacements:
    # Replace the Fedora make invocation with cross-compile flags.
    # Paths are fixed in config.mk via prep_commands.
    # Must pass LDFLAGS with compat library — plain Makefile doesn't pick up
    # shell env $LIBS like autotools does.
    - pattern: "%make_build \\\n  X11INC=%{_includedir} \\\n  X11LIB=%{_libdir} \\\n  CFLAGS='-std=c99 -pedantic -Wall $(INCS) $(CPPFLAGS) %{build_cflags}' \\\n  LDFLAGS='%{build_ldflags} $(LIBS)'"
      replacement: |
        COMPAT_DIR=$(pwd)/mogrix-compat
        %make_build CC="%{__cc}" LDFLAGS="-L$COMPAT_DIR -lmogrix-compat -L/usr/sgug/lib32 -lX11 -lfontconfig -lXft"
