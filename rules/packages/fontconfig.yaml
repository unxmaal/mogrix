# fontconfig - Font configuration and customization library (FC40: 2.15.0)
# Unblocks cairo, pango, gd, emacs
package: fontconfig

rules:
  inject_compat_functions:
    - strdup
    - strndup

  drop_subpackages:
    - "devel-doc"

  drop_requires:
    - "fonts-filesystem"
    - "xml-common"
    - "font"
    - "freetype"

  skip_check: true

  ac_cv_overrides:
    gl_cv_header_working_stdint_h: "yes"
    # Use __sync builtins (not C11 stdatomic.h which pulls in bits/wordsize.h)
    fc_cv_have_stdatomic_atomic_primitives: "false"
    fc_cv_have_intel_atomic_primitives: "true"

  spec_replacements:
    # Remove dependencies not available on IRIX (original line is multi-dep with tab)
    - pattern: "Requires:\tfonts-filesystem freetype"
      replacement: "# fonts-filesystem and freetype handled by sysroot"
    - pattern: "PreReq:\t\tfreetype >= 2.9.1-6"
      replacement: "# PreReq freetype handled by sysroot"
    # Add explicit Provides (AutoProv disabled for cross-compilation)
    - pattern: "Suggests:\tfont(notosans)"
      replacement: "Provides: fontconfig(mips-32) = %{version}-%{release}\nProvides: libfontconfig.so.1\nSuggests:\tfont(notosans)"
    # Drop unavailable BuildRequires
    - pattern: "BuildRequires:\tfontpackages-devel"
      replacement: "# fontpackages-devel not available — define macros inline"
    - pattern: "BuildRequires:  docbook-utils docbook-utils-pdf"
      replacement: "# docbook-utils not available"
    # Define fontconfig macros (normally from fontpackages-devel)
    - pattern: "%global freetype_version 2.9.1"
      replacement: "%global freetype_version 2.9.1\n%global _fontconfig_templatedir %{_datadir}/fontconfig/conf.avail\n%global _fontconfig_confdir %{_sysconfdir}/fonts/conf.d\n%global _fontconfig_masterdir %{_sysconfdir}/fonts"
    # Fix bash-ism: ${i//.fncs/.sgml} → use sh-compatible sed
    - pattern: "for i in doc/*.fncs; do\n  touch -r $i ${i//.fncs/.sgml}\ndone"
      replacement: "for i in doc/*.fncs; do\n  j=$(echo $i | sed 's/\\.fncs$/.sgml/')\n  touch -r $i $j\ndone"
    # Run autoreconf with AUTOPOINT=true (gettext binaries are for IRIX, not host)
    # Remove test from SUBDIRS — tests use setenv() which IRIX lacks, and they
    # compile during 'make all' not just 'make check'
    - pattern: "autoreconf"
      replacement: "sed -i 's/ test$//' Makefile.am\nAUTOPOINT=true autoreconf -fi"
    # Pre-generate gperf hash table using HOST cpp+gperf before make runs.
    # The tarball does NOT ship fcobjshash.gperf or fcobjshash.h — they're generated
    # during build. The Makefile uses $(CPP) which is the cross-compiler preprocessor,
    # and it injects 'typedef __builtin_va_list va_list;' corrupting the gperf input.
    # Using /usr/bin/cpp (host) avoids this. Touch files so make doesn't regenerate.
    - pattern: "make %{?_smp_mflags}"
      replacement: "/usr/bin/cpp -I. src/fcobjshash.gperf.h 2>/dev/null | sed 's/^ *//;s/ *, */,/' | awk 'BEGIN{nw=0}/CUT_OUT_BEGIN/{nw=1;next}/CUT_OUT_END/{nw=0;next}/^$/||/^#/{next}{if(nw==0)print}' > src/fcobjshash.gperf\n/usr/bin/gperf --pic -m 100 src/fcobjshash.gperf > src/fcobjshash.h\ntouch src/stamp-fcobjshash.gperf src/fcobjshash.gperf src/fcobjshash.h\nmake %{?_smp_mflags}"
    # Use expat instead of libxml2 (SAX1 detection fails in cross-compile)
    - pattern: "--enable-libxml2"
      replacement: "--disable-libxml2"
    # Fix configure paths for IRIX
    - pattern: "--with-add-fonts=/usr/share/X11/fonts/Type1,/usr/share/X11/fonts/TTF,/usr/local/share/fonts"
      replacement: "--with-add-fonts=%{_datadir}/fonts"
    - pattern: "--with-cache-dir=/usr/lib/fontconfig/cache"
      replacement: "--with-cache-dir=%{_localstatedir}/cache/fontconfig"
    # Fix bash-ism in %post: [[ ]] → [ ]
    - pattern: "[[ -d %{_localstatedir}/cache/fontconfig ]]"
      replacement: "[ -d %{_localstatedir}/cache/fontconfig ]"
    # Fix hardcoded paths in %post
    - pattern: "mkdir -p /usr/lib/fontconfig/cache"
      replacement: "mkdir -p %{_localstatedir}/cache/fontconfig"
    - pattern: "%dir /usr/lib/fontconfig/cache"
      replacement: "%dir %{_localstatedir}/cache/fontconfig"
    # fc-cache rename uses __isa_bits — set to 32 for IRIX n32
    - pattern: "fc-cache-%{__isa_bits}"
      replacement: "fc-cache-32"
      replace_all: true
    # Remove transfiletriggers (not supported in rpm < 4.14 or missing on IRIX)
    - pattern: "%transfiletriggerin -- /usr/share/fonts /usr/share/X11/fonts/Type1 /usr/share/X11/fonts/TTF /usr/local/share/fonts\nHOME=/root /usr/bin/fc-cache -s"
      replacement: "# transfiletriggerin disabled for IRIX"
    - pattern: "%transfiletriggerpostun -- /usr/share/fonts /usr/share/X11/fonts/Type1 /usr/share/X11/fonts/TTF /usr/local/share/fonts\nHOME=/root /usr/bin/fc-cache -s"
      replacement: "# transfiletriggerpostun disabled for IRIX"
    # Skip xml catalog registration (xml-common not available)
    - pattern: "%posttrans"
      replacement: "%posttrans\n# xml catalog registration disabled for IRIX\nexit 0"
    - pattern: "%postun"
      replacement: "%postun\n# xml catalog cleanup disabled for IRIX\nexit 0"
    # Fix %post to use sgug paths
    - pattern: "if [ -x /usr/bin/fc-cache ] && /usr/bin/fc-cache --version"
      replacement: "if [ -x %{_bindir}/fc-cache ] && %{_bindir}/fc-cache --version"
    - pattern: "HOME=/root /usr/bin/fc-cache -f"
      replacement: "HOME=/root %{_bindir}/fc-cache -f"

  install_cleanup:
    - "rm -f %{buildroot}%{_libdir}/*.la"
    - "rm -f %{buildroot}%{_infodir}/dir"
