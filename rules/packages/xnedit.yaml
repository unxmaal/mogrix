package: xnedit
upstream:
  url: https://github.com/unixwork/xnedit/archive/refs/tags/v1.6.1.tar.gz
  version: "1.6.1"
  type: tarball
  build_system: makefile
  license: "GPL-2.0-only"
  summary: "Fast X11 text editor based on NEdit with Unicode support"
  source_dir: xnedit-1.6.1
add_source:
  - fix_class_recs.c
rules:
  export_vars:
    PKG_CONFIG_PATH: /opt/sgug-staging/usr/sgug/lib32/pkgconfig
    PKG_CONFIG_LIBDIR: /opt/sgug-staging/usr/sgug/lib32/pkgconfig
    PKG_CONFIG_SYSROOT_DIR: /opt/sgug-staging
    MOGRIX_NO_DLMALLOC: "1"
  prep_commands:
    # Fix hardcoded Linux paths in Makefile.linux for cross-compilation
    - "sed -i 's|-I/usr/X11R6/include|-I/opt/sgug-staging/usr/sgug/include|g' makefiles/Makefile.linux"
    - "sed -i 's|-I/usr/include/X11|-I/opt/sgug-staging/usr/sgug/include/X11|g' makefiles/Makefile.linux"
    - "sed -i 's|-L/usr/X11R6/lib|-L/opt/sgug-staging/usr/sgug/lib32|g' makefiles/Makefile.linux"
    # Add compat include path and EDITRES support
    - "sed -i 's|$(C_OPT_FLAGS)|$(C_OPT_FLAGS) -I/opt/sgug-staging/usr/sgug/include/mogrix-compat/generic -DEDITRES|' makefiles/Makefile.linux"
    # Add -lXmu for EDITRES and -lgen for IRIX, add compat library
    - "sed -i 's|-lXrender|-lXmu -lXrender|' makefiles/Makefile.linux"
    # Replace DropDown.h with ComboBox.h (IRIX Motif has ComboBox, not DropDown)
    - "sed -i 's|#include <Xm/DropDown.h>|#include <Xm/ComboBox.h>|' source/window.c"
    # === IRIX BadMatch fix: force default visual ===
    # SGI IRIX offers 30-bit TrueColor visuals. FindBestVisual picks these
    # as the "best" visual, but creating child windows at depth 30 causes
    # BadMatch (X_CreateWindow) on the IRIX X server when Xft/Xrender
    # libraries are loaded. The exact interaction is unclear, but the fix
    # is confirmed: force the default 24-bit visual. nedit (no Xft) works
    # with 30-bit; xnedit (has Xft) does not. Both use the same FindBestVisual.
    - "perl -i -0pe 's/\\/\\* If results have already been computed.*?if \\(cachedVisual != NULL\\).*?\\}/\\/\\* IRIX: force default visual — 30-bit TrueColor causes BadMatch *\\/\\n    {\\n\\t*visual = cachedVisual = DefaultVisual(display, DefaultScreen(display));\\n\\t*depth = cachedDepth = DefaultDepth(display, DefaultScreen(display));\\n\\t*colormap = cachedColormap = DefaultColormap(display, DefaultScreen(display));\\n\\treturn True;\\n    }/s' util/misc.c"
    # Fix SIGBUS in create_image: icon data is const char* cast to uint32_t*,
    # causing misaligned access on MIPS. Use memcpy for safe aligned read.
    - "sed -i 's|uint32_t pixel = src\\[i\\];|uint32_t pixel; memcpy(\\&pixel, data + i*4, 4);|' util/filedialog.c"
    # MIPS/IRIX is big-endian like SPARC — add to endianness check
    - "sed -i 's#defined(__sparc) || defined(__sparc__)#defined(__sparc) || defined(__sparc__) || defined(__mips) || defined(_MIPS_ARCH)#' util/filedialog.c"
    # Remove post-build binary execution (can't run MIPS on x86)
    - "sed -i '/@source\\/xnedit -V/d' Makefile"
    # Copy fix_class_recs.c and add to OBJS (R_MIPS_REL32 workaround for widget ClassRec)
    - "cp %{_sourcedir}/fix_class_recs.c source/fix_class_recs.c"
    - "sed -i 's|filter.o|filter.o fix_class_recs.o|' source/Makefile.common"
  spec_replacements:
    # Use make linux with cross-compiler
    - pattern: "%make_build"
      replacement: "make linux CC=%{__cc} AR=%{__ar} ARFLAGS=-urs"
    # Add desktop file and icon to %files
    - pattern: "%{_bindir}/*"
      replacement: |
        %{_bindir}/*
        %{_datadir}/applications/xnedit.desktop
        %{_datadir}/icons/xnedit.png
smoke_test:
- command: "/usr/sgug/bin/xnedit"
  args: "-V"
  expect: "XNEdit"
