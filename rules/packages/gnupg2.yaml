package: gnupg2
smoke_test:
- command: /usr/sgug/bin/gpg2 --version
  expect: 2.4.4
add_patch:
- gnupg2.sgifixes.patch
- gnupg2-gettime-sysutils-include.patch
add_source:
- npth-config.irix.sh
rules:
  inject_compat_functions:
  - explicit_bzero
  drop_buildrequires:
  - libusb1-devel
  - openldap-devel
  - tpm2-tss-devel
  - pcsc-lite-libs
  - fuse
  - docbook-utils
  - swtpm
  drop_requires:
  - pinentry
  ac_cv_overrides:
    gl_cv_func_working_getdelim: 'yes'
    ac_cv_func_stpcpy: 'yes'
    ac_cv_func_explicit_bzero: 'yes'
  prep_commands:
  - $MOGRIX_ROOT/tools/safepatch Makefile.in --old '${tests}' --new '' --no-backup --quiet
  - mkdir -p npth-config-wrapper
  - cp %{_sourcedir}/npth-config.irix.sh npth-config-wrapper/npth-config && chmod +x npth-config-wrapper/npth-config
  export_vars:
    NPTH_CONFIG: $(pwd)/npth-config-wrapper/npth-config
  configure_flags:
    add:
    - --disable-doc
    - --disable-ldap
    - --disable-ccid-driver
    - --disable-scdaemon
    - --disable-dirmngr
    - --disable-photo-viewers
    - --disable-card-support
    - --disable-wks-tools
    - --disable-g13
    - --disable-tpm2d
    - --disable-tofu
    - --without-libusb
    - --without-readline
    - --with-libgpg-error-prefix=/opt/sgug-staging/usr/sgug
    - --with-libgcrypt-prefix=/opt/sgug-staging/usr/sgug
    - --with-libassuan-prefix=/opt/sgug-staging/usr/sgug
    - --with-ksba-prefix=/opt/sgug-staging/usr/sgug
    remove:
    - --enable-g13
    - --enable-large-secmem
    - --with-tss=intel
  spec_replacements:
  - pattern: '%files -f %{name}.lang'
    replacement: '%files'
  - pattern: '%{_bindir}/dirmngr

      %{_bindir}/dirmngr-client'
    replacement: '# dirmngr disabled for IRIX (no gnutls)'
  - pattern: '%{_bindir}/g13

      '
    replacement: '# g13 disabled for IRIX

      '
  - pattern: '%{_bindir}/gpg-wks-server

      '
    replacement: '# wks-server disabled for IRIX

      '
  - pattern: 'install -d -m755 %{buildroot}%{_userunitdir}

      mv %{buildroot}%{_pkgdocdir}/examples/systemd-user/*.socket %{buildroot}%{_userunitdir}

      mv %{buildroot}%{_pkgdocdir}/examples/systemd-user/*.service %{buildroot}%{_userunitdir}

      '
    replacement: '# No systemd on IRIX

      '
  - pattern: '%{_userunitdir}/*'
    replacement: '# No systemd units on IRIX'
  - pattern: '%{_infodir}/*.info*'
    replacement: '# No info pages (--disable-doc)'
  - pattern: '%{_sbindir}/*'
    replacement: '# sbindir empty with disabled features'
  - pattern: 'ln -sf gpg.1 %{buildroot}%{_mandir}/man1/gpg2.1

      ln -sf gpgv.1 %{buildroot}%{_mandir}/man1/gpgv2.1

      ln -sf gnupg.7 %{buildroot}%{_mandir}/man7/gnupg2.7

      '
    replacement: '# No man pages (--disable-doc)

      '
  - pattern: '%{_mandir}/man?/*'
    replacement: '# No man pages (--disable-doc)'
  - pattern: '%exclude %{_mandir}/man?/gpgsm*'
    replacement: '# No man pages to exclude (--disable-doc)'
  - pattern: '%{_mandir}/man?/gpgsm*

      '
    replacement: '# No man pages (--disable-doc)

      '
  - pattern: 'sed -i -e ''s/"libpcsclite\.so"/"%{pcsclib}"/'' scd/scdaemon.c

      '
    replacement: '# scdaemon disabled, no pcsc-lite fixup needed

      '
  install_cleanup:
  - rm -rf $RPM_BUILD_ROOT%{_infodir}
  - rm -rf $RPM_BUILD_ROOT%{_sbindir}
  - rm -rf $RPM_BUILD_ROOT%{_mandir}
  - rm -rf $RPM_BUILD_ROOT%{_pkgdocdir}/examples/systemd-user
