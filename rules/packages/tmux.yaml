# tmux - terminal multiplexer (upstream: 3.5a)
# Autoconf build. Deps: libevent, ncurses (both staged).
# No FC40 SRPM — uses create-srpm from GitHub.
package: tmux

add_source:
  - forkpty-irix.c

upstream:
  url: https://github.com/tmux/tmux
  version: "3.5a"
  ref: "3.5a"
  type: git
  build_system: autoconf
  license: ISC
  summary: "Terminal multiplexer"

rules:
  inject_compat_functions:
    - getline
    - strdup
    - strndup

  prep_commands:
    # Git repo doesn't include pre-generated configure — generate it
    - "sh autogen.sh"
    # IRIX libc has __b64_ntop/__b64_pton but marked HIDDEN — rld can't
    # resolve at runtime. Force all b64 checks to fail so tmux uses its
    # own compat/base64.c (OpenBSD implementation).
    - "sed -i 's/found_b64_ntop=yes/found_b64_ntop=no/g' configure"
    # IRIX resolv.h has #define b64_ntop __b64_ntop — this renames the compat
    # function to __b64_ntop but callers (via compat.h) expect plain b64_ntop.
    # Undef after includes so compat/base64.c defines the plain symbols.
    - "sed -i 's/#include <string.h>/#include <string.h>\\n#undef b64_ntop\\n#undef b64_pton/' compat/base64.c"
    # IRIX has no UTF-8 locale — suppress tmux's hard UTF-8 requirement.
    # The setlocale fallback chain still runs; we just don't abort on non-UTF8.
    - "sed -i 's/errx(1, \"invalid LC_ALL, LC_CTYPE or LANG\")/(void)0/' tmux.c"
    - "sed -i 's/errx(1, \"need UTF-8 locale.*s)/(void)0/' tmux.c"
    # IRIX sendmsg limits iov entries to MSG_MAXIOVLEN (16). imsg-buffer.c uses
    # IOV_MAX (1024 on IRIX) which causes errno 97 when batching >16 messages.
    # Cap at 16 to match IRIX kernel limit.
    - "sed -i 's/IOV_MAX/16/g' compat/imsg-buffer.c"
    # Rename local variable that collides with getopt.h macro optional_argument
    - "sed -i 's/optional_argument/is_optional_arg/g' arguments.c"
    # IRIX lacks strsignal() — replace all occurrences with literal string
    - "sed -i 's/strsignal(sig)/\"signal\"/' client.c server.c"
    # Fix compat/setenv.c — xasprintf is tmux-internal, use standard asprintf;
    # environ needs extern declaration (IRIX has no setenv in libc)
    - "sed -i 's/xasprintf/asprintf/' compat/setenv.c"
    - "sed -i '/#include \"compat.h\"/a extern char **environ;' compat/setenv.c"
    # Install IRIX forkpty() using _getpty() — tmux detects IRIX as "unknown" platform
    - "cp %{_sourcedir}/forkpty-irix.c compat/forkpty-unknown.c"

  # basename/dirname are in libgen.so on IRIX (not libc). Pre-set LIBS so
  # the compat injection's "$LIBS" picks it up.
  export_vars:
    LIBS: "-lgen"

  spec_replacements:
    # Add man page to %files (template only has bindir)
    - pattern: "%{_bindir}/*"
      replacement: "%{_bindir}/*\n%{_mandir}/man1/tmux.1*"

  configure_flags:
    add:
      - --disable-utf8proc
