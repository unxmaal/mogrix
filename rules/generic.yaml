# generic.yaml - Universal rules applied to ALL packages BEFORE package-specific rules.
#
# DO NOT duplicate these rules in rules/packages/*.yaml.
# See rules/INDEX.md for the full list of what generic handles.
#
# ---metadata---
# scope: global (applies to every package)
# purpose: Remove Linux-specific deps, set IRIX paths, skip %check
# key_sections:
#   - drop_buildrequires: systemd, selinux, kernel-headers, libdicl, gcc, gcc-c++, gnupg2,
#       texinfo, doxygen, help2man, desktop-file-utils, git, valgrind,
#       python3, python3-devel, python3-setuptools, ruby, ruby-devel,
#       perl-generators, glibc-langpack-en, rust-*/golang-*/ghc-*
#   - drop_requires: libdicl (replaced by mogrix compat injection)
#   - remove_lines: gpgverify, ldconfig_scriptlets, libdicl exports, systemd scriptlets
#   - ac_cv_overrides: malloc_0_nonnull, realloc_0_nonnull, gl_cv_cc_wallow, gl_cv_func_select_*
#   - inject_compat_functions: strdup, strndup, strnlen, getline, getopt_long, asprintf,
#       vasprintf, setenv, strerror_r, reallocarray, stpcpy
#   - configure_flags.add: --disable-silent-rules
#   - rpm_macros: _prefix=/usr/sgug, _libdir=/usr/sgug/lib32
#   - configure_disable: selinux, systemd, udev, inotify, epoll, etc.
#   - header_overlays: generic (stdarg.h, stdio.h, etc.)
#   - install_cleanup: fix /usr/bin paths, rm *.la, rm infodir/dir
#   - skip_check: true (can't run cross-compiled tests)
#   - drop_subpackages: debuginfo, debugsource, langpack-*
# ---

generic:
  drop_buildrequires:
    - systemd
    - systemd-devel
    - libselinux
    - libselinux-devel
    - kernel-headers
    - alsa-lib-devel
    - systemtap-sdt-devel
    - libcap-devel
    - libcap-ng-devel
    - libacl-devel
    - libattr-devel
    - audit-libs-devel
    # Compilers not needed - we use clang cross-compiler
    - gcc
    - gcc-c++
    # GPG verification not needed for cross-compilation
    - gnupg2
    # libdicl replaced by mogrix compat injection
    - libdicl
    - libdicl-devel
    # Doc/build tools not needed for cross-compilation
    - texinfo
    - doxygen
    - help2man
    - desktop-file-utils
    - git
    - valgrind
    # Language ecosystems not on IRIX
    - python3
    - python3-devel
    - python3-setuptools
    - ruby
    - ruby-devel
    # RPM macro generators - Linux-only
    - perl-generators
    # Locale data not needed
    - glibc-langpack-en
    # Language ecosystems that have never been ported to IRIX (glob patterns)
    - "rust-*"
    - "golang-*"
    - "ghc-*"
    # Supporting packages for impossible ecosystems
    - rust
    - rust-packaging
    - rust-srpm-macros
    - cargo
    - go-rpm-macros
    - ghc-compiler
    - ghc-rpm-macros

  drop_requires:
    - libdicl
    - libdicl-devel

  # Remove gpgverify calls - source verification not needed for cross-compilation
  # Many Fedora packages use %{gpgverify} in %prep to verify source signatures
  remove_lines:
    - "%{gpgverify}"
    # ldconfig scriptlets don't work for cross-compilation
    - "%ldconfig_scriptlets"
    # libdicl setup lines - mogrix injects compat functions directly
    - 'export CPPFLAGS="-I%{_includedir}/libdicl-0.1"'
    - 'export LIBS="-ldicl-0.1"'
    # systemd scriptlets - IRIX has no systemd
    - "%systemd_post"
    - "%systemd_preun"
    - "%systemd_postun"
    - "%systemd_postun_with_restart"
    - "%systemd_user_post"
    - "%systemd_user_preun"
    - "%systemd_user_postun"
    - "%systemd_user_postun_with_restart"

  # Skip %check section - cannot run cross-compiled tests on build host
  skip_check: true

  # Autoconf cache overrides - IRIX malloc/realloc return non-null for size 0
  ac_cv_overrides:
    ac_cv_func_malloc_0_nonnull: "yes"
    ac_cv_func_realloc_0_nonnull: "yes"
    # Gnulib warning flag detection: configure preprocesses a conftest and
    # extracts -W flags from the output. Our cross-compiler's -E output
    # includes extra type definitions from header overlays (e.g.,
    # "typedef __builtin_va_list va_list;") which leak into
    # GL_CFLAG_GNULIB_WARNINGS and break compilation (shell interprets
    # the semicolons as command separators). Setting this to "none"
    # disables the gnulib warning flag detection entirely.
    gl_cv_cc_wallow: "none"
    # dicl-clang-compat provides a sys/random.h stub with static inline
    # getrandom(). Many packages conflict with this header. Since IRIX
    # has no sys/random.h or getrandom(), tell configure it doesn't exist.
    ac_cv_header_sys_random_h: "no"
    # Gnulib generates its own stdint.h replacement with different fast-int
    # types (long vs int) that conflict with dicl-clang-compat/stdint.h.
    # On MIPS n32 both int and long are 32-bit so our stdint.h is correct.
    gl_cv_header_working_stdint_h: "yes"
    # Gnulib select() detection: IRIX select works correctly for EBADF
    # and zero-timeout cases. These tests can't run cross-compiled.
    gl_cv_func_select_detects_ebadf: "yes"
    gl_cv_func_select_supports0: "yes"
    # Autoconf 2.72+ checks whether the compiler can detect undeclared
    # builtins. This test links a conftest and fails with our cross-
    # compiler (undefined main). Tell configure no special flags needed.
    ac_cv_c_undeclared_builtin_options: "none needed"

  # Common compat functions needed by most packages.
  # IRIX libc lacks these POSIX/BSD functions. Static archive linking
  # means unused functions are not pulled in, so this is safe globally.
  inject_compat_functions:
    - strdup
    - strndup
    - strnlen
    - getline
    - getopt_long
    - asprintf
    - vasprintf
    - setenv
    - strerror_r
    - reallocarray
    - stpcpy

  configure_flags:
    add:
      - "--disable-silent-rules"

  # RPM macros injected directly (replaces sgug-rpm-config)
  rpm_macros:
    # Target architecture for cross-compilation
    _target_cpu: mips
    _arch: mips
    # Disable automatic dependency detection - IRIX system libs aren't in RPM db
    __find_requires: "%{nil}"
    __find_provides: "%{nil}"
    _prefix: /usr/sgug
    _exec_prefix: /usr/sgug
    _bindir: /usr/sgug/bin
    _sbindir: /usr/sgug/sbin
    _libdir: /usr/sgug/lib32
    _includedir: /usr/sgug/include
    _datadir: /usr/sgug/share
    _mandir: /usr/sgug/share/man
    _infodir: /usr/sgug/share/info
    _sysconfdir: /usr/sgug/etc
    _localstatedir: /usr/sgug/var
    # NOTE: Do NOT set _var - it's used by RPM for %_tmppath and must remain /var
    _sharedstatedir: /usr/sgug/var/lib
    _docdir: /usr/sgug/share/doc
    _pkgdocdir: "%{_docdir}/%{name}"
    _pkglicensedir: "%{_datadir}/licenses/%{name}"

  configure_disable:
    - selinux
    - systemd
    - udev
    - inotify
    - epoll
    - fanotify
    - timerfd
    - libcap
    - audit

  rewrite_paths:
    /usr/lib64: /usr/sgug/lib32
    /usr/lib: /usr/sgug/lib32
    /usr/include: /usr/sgug/include

  header_overlays:
    - generic

  # Fix build-host paths baked into installed scripts and data files.
  # Build systems detect /usr/bin/perl, /usr/bin/m4, etc. on the Linux host
  # and hardcode those paths. On IRIX, these tools are at /usr/sgug/bin/.
  # /usr/bin/env is restored since it exists on IRIX.
  install_cleanup:
    - "find %{buildroot}%{_bindir} %{buildroot}%{_datadir} -type f -print0 2>/dev/null | xargs -0 -r grep -lZ '/usr/bin/' 2>/dev/null | xargs -0 -r file 2>/dev/null | grep text | sed 's/^\\(.*\\): .*/\\1/' | xargs -r sed -i 's|/usr/bin/|/usr/sgug/bin/|g; s|/usr/sgug/bin/env|/usr/bin/env|g'"
    # Remove libtool archives - IRIX doesn't use them
    - "rm -f %{buildroot}%{_libdir}/*.la"
    # Remove info dir file - rebuilt by install-info on target
    - "rm -f %{buildroot}%{_infodir}/dir"
    # Remove locale files - IRIX bundles don't use gettext translations
    - "rm -rf %{buildroot}%{_datadir}/locale"

  # Always skip %find_lang â€” locale files are removed by install_cleanup above.
  # This comments out %find_lang and strips -f *.lang from %files lines.
  skip_find_lang: true

  drop_subpackages:
    - "debuginfo"
    - "debugsource"
    - "langpack-*"
