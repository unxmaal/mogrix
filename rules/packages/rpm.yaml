package: rpm
smoke_test:
- command: /usr/sgug/bin/rpm --version
  expect: 4.19.1.1
- command: /usr/sgug/bin/rpm -qa
add_patch:
- rpm.irixfixes.patch
rules:
  inject_compat_functions:
  - openat
  - getprogname
  - posix_spawn
  drop_buildrequires:
  - dbus-devel
  - fapolicyd-devel
  - libfsverity-devel
  - ima-evm-utils-devel
  - sequoia-sq
  - sequoia-policy-config-devel
  drop_requires:
  - libselinux
  - audit-libs
  - coreutils
  - curl
  - findutils
  - sed
  - grep
  - gawk
  - diffutils
  - file
  - patch
  - popt
  - rpm-sequoia
  export_vars:
    PKG_CONFIG_PATH: /opt/sgug-staging/usr/sgug/lib32/pkgconfig
    PKG_CONFIG_LIBDIR: /opt/sgug-staging/usr/sgug/lib32/pkgconfig
    PKG_CONFIG_SYSROOT_DIR: /opt/sgug-staging
    CPPFLAGS: -I/opt/sgug-staging/usr/sgug/include $CPPFLAGS
    LDFLAGS: -L/opt/sgug-staging/usr/sgug/lib32 $LDFLAGS
  spec_replacements:
  - pattern: "cmake \\\n      -DCMAKE_INSTALL_PREFIX"
    replacement: "cmake \\\n      -DCMAKE_SYSTEM_NAME=IRIX \\\n      -DCMAKE_MAKE_PROGRAM=/usr/bin/make \\\n      -DCMAKE_C_COMPILER=%{__cc} \\\n      -DCMAKE_CXX_COMPILER=%{__cxx} \\\n      -DCMAKE_AR=%{__ar}\
      \ \\\n      -DCMAKE_RANLIB=%{__ranlib} \\\n      -DCMAKE_EXE_LINKER_FLAGS=\"-Wl,--image-base=0x1000000 -Wl,--whole-archive $COMPAT_DIR/libmogrix-compat.a -Wl,--no-whole-archive -lgen\" \\\n      -DCMAKE_SHARED_LINKER_FLAGS=\"\
      -Wl,--whole-archive $COMPAT_DIR/libmogrix-compat.a -Wl,--no-whole-archive -lgen\" \\\n      -DRPM_CONFIGDIR=/usr/sgug/lib32/rpm \\\n      -DCMAKE_FIND_ROOT_PATH=/opt/sgug-staging/usr/sgug \\\n   \
      \   -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY \\\n      -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY \\\n      -DCMAKE_FIND_ROOT_PATH_MODE_PROGRAM=NEVER \\\n      -DLUA_INCLUDE_DIR=/opt/sgug-staging/usr/sgug/include\
      \ \\\n      -DLUA_LIBRARIES=/opt/sgug-staging/usr/sgug/lib32/liblua.so \\\n      -DZLIB_LIBRARY=/opt/sgug-staging/usr/sgug/lib32/libz.so \\\n      -DZLIB_INCLUDE_DIR=/opt/sgug-staging/usr/sgug/include\
      \ \\\n      -DBZIP2_LIBRARY=/opt/sgug-staging/usr/sgug/lib32/libbz2.so \\\n      -DBZIP2_LIBRARIES=/opt/sgug-staging/usr/sgug/lib32/libbz2.so \\\n      -DBZIP2_INCLUDE_DIR=/opt/sgug-staging/usr/sgug/include\
      \ \\\n      -DBZIP2_INCLUDE_DIRS=/opt/sgug-staging/usr/sgug/include \\\n      -DLIBLZMA_LIBRARY=/opt/sgug-staging/usr/sgug/lib32/liblzma.so \\\n      -DLIBLZMA_INCLUDE_DIR=/opt/sgug-staging/usr/sgug/include\
      \ \\\n      -DOPENSSL_ROOT_DIR=/opt/sgug-staging/usr/sgug \\\n      -DOPENSSL_CRYPTO_LIBRARY=/opt/sgug-staging/usr/sgug/lib32/libcrypto.so \\\n      -DOPENSSL_SSL_LIBRARY=/opt/sgug-staging/usr/sgug/lib32/libssl.so\
      \ \\\n      -DPOPT_LIBRARY=/opt/sgug-staging/usr/sgug/lib32/libpopt.so \\\n      -DPOPT_INCLUDE_DIR=/opt/sgug-staging/usr/sgug/include \\\n      -DIconv_LIBRARY= \\\n      -DIconv_INCLUDE_DIR=/opt/irix-sysroot/usr/include\
      \ \\\n      -DIconv_IS_BUILT_IN=TRUE \\\n      -DENABLE_NLS=OFF \\\n      -DENABLE_OPENMP=OFF \\\n      -DENABLE_PYTHON=OFF \\\n      -DENABLE_PLUGINS=OFF \\\n      -DENABLE_TESTSUITE=OFF \\\n   \
      \   -DENABLE_SQLITE=ON \\\n      -DSQLite3_INCLUDE_DIR=/opt/sgug-staging/usr/sgug/include \\\n      -DSQLite3_LIBRARY=/opt/sgug-staging/usr/sgug/lib32/libsqlite3.so \\\n      -DENABLE_NDB=OFF \\\n\
      \      -DENABLE_BDB_RO=OFF \\\n      -DENABLE_CUTF8=OFF \\\n      -DWITH_CAP=OFF \\\n      -DWITH_ACL=OFF \\\n      -DWITH_SELINUX=OFF \\\n      -DWITH_AUDIT=OFF \\\n      -DWITH_DBUS=OFF \\\n   \
      \   -DWITH_FAPOLICYD=OFF \\\n      -DWITH_FSVERITY=OFF \\\n      -DWITH_IMAEVM=OFF \\\n      -DWITH_ARCHIVE=OFF \\\n      -DWITH_READLINE=OFF \\\n      -DWITH_INTERNAL_OPENPGP=ON \\\n      -DWITH_OPENSSL=ON\
      \ \\\n      -DMAGIC_LIBRARY=/opt/sgug-staging/usr/sgug/lib32/libmagic.so \\\n      -DMAGIC_INCLUDE_DIR=/opt/sgug-staging/usr/sgug/include \\\n      -DHAVE_BASENAME=1 \\\n      -DHAVE_DIRNAME=1 \\\n\
      \      -DHAVE_GETCWD=1 \\\n      -DHAVE_MKSTEMP=1 \\\n      -DHAVE_REALPATH=1 \\\n      -DHAVE_SETENV=1 \\\n      -DHAVE_UNSETENV=1 \\\n      -DHAVE_GETLINE=1 \\\n      -DHAVE_ASPRINTF=1 \\\n    \
      \  -DHAVE_VASPRINTF=1 \\\n      -DHAVE_OPENAT=1 \\\n      -DHAVE_FSTATAT=1 \\\n      -DHAVE_FACCESSAT=1 \\\n      -DHAVE_MKDIRAT=1 \\\n      -DHAVE_UNLINKAT=1 \\\n      -DHAVE_RENAMEAT=1 \\\n    \
      \  -DHAVE_READLINKAT=1 \\\n      -DHAVE_SYMLINKAT=1 \\\n      -DHAVE_LINKAT=1 \\\n      -DHAVE_FCHMODAT=1 \\\n      -DHAVE_FCHOWNAT=1 \\\n      -DHAVE_MKFIFOAT=1 \\\n      -DHAVE_MKNODAT=1 \\\n  \
      \    -DHAVE_UTIMENSAT=1 \\\n      -DHAVE_FUTIMENS=1 \\\n      -DHAVE_STPCPY=1 \\\n      -DHAVE_STPNCPY=1 \\\n      -DHAVE_SETPROGNAME=1 \\\n      -DCMAKE_INSTALL_PREFIX=/usr/sgug \\\n      -DCMAKE_INSTALL_LIBDIR=lib32\
      \ \\\n      -DCMAKE_INSTALL_SHAREDSTATEDIR:PATH=/usr/sgug/var/lib"
  - pattern: "-DCMAKE_INSTALL_PREFIX=%{_usr} \\\n      -DCMAKE_INSTALL_SHAREDSTATEDIR:PATH=%{_var}/lib"
    replacement: ''
  - pattern: '%{?with_bdb_ro:-DENABLE_BDB_RO=ON}'
    replacement: ''
  - pattern: '%{!?with_ndb:-DENABLE_NDB=OFF}'
    replacement: ''
  - pattern: '%{!?with_sqlite:-DENABLE_SQLITE=OFF}'
    replacement: ''
  - pattern: '%{!?with_plugins:-DENABLE_PLUGINS=OFF}'
    replacement: ''
  - pattern: '%{?with_fsverity:-DWITH_FSVERITY=ON}'
    replacement: ''
  - pattern: '%{?with_libimaevm:-DWITH_IMAEVM=ON}'
    replacement: ''
  - pattern: '%{!?with_libarchive:-DWITH_ARCHIVE=OFF}'
    replacement: ''
  - pattern: '%{!?with_check:-DENABLE_TESTSUITE=OFF}'
    replacement: ''
  - pattern: '%{!?with_sequoia:-DWITH_INTERNAL_OPENPGP=ON}'
    replacement: ''
  - pattern: '%{!?with_sequoia:-DWITH_OPENSSL=ON }'
    replacement: ''
  - pattern: '%autosetup -n rpm-%{srcver} -p1'
    replacement: '%autosetup -n rpm-%{srcver} -p1


      # IRIX WAL fix: RPM hardcodes PRAGMA journal_mode=WAL in lib/backend/sqlite.c.

      # IRIX fcntl correctly rejects F_WRLCK on O_RDONLY fds (POSIX compliant).

      # WAL needs write locks even for read operations. DELETE mode does not.

      # Belt-and-suspenders with SQLITE_OMIT_WAL in sqlite.yaml.

      sed -i ''s/PRAGMA journal_mode = WAL/PRAGMA journal_mode = DELETE/'' lib/backend/sqlite.c


      # Fix BZip2 imported target - set IMPORTED_LOCATION after find_package

      sed -i ''/^find_package(BZip2)/a if(BZIP2_FOUND)\n  set_target_properties(BZip2::BZip2 PROPERTIES IMPORTED_LOCATION \"${BZIP2_LIBRARIES}\")\nendif()'' CMakeLists.txt


      # Fix library SONAMEs - rpm libraries need proper SONAME to avoid build-path references

      # Without this, binaries link against ''../lib/librpm.so'' instead of ''librpm.so''

      sed -i ''s/OUTPUT_NAME rpm)/OUTPUT_NAME rpm SOVERSION 10)/'' lib/CMakeLists.txt

      sed -i ''s/OUTPUT_NAME rpmio)/OUTPUT_NAME rpmio SOVERSION 10)/'' rpmio/CMakeLists.txt

      sed -i ''s/OUTPUT_NAME rpmbuild)/OUTPUT_NAME rpmbuild SOVERSION 10)/'' build/CMakeLists.txt

      sed -i ''s/OUTPUT_NAME rpmsign)/OUTPUT_NAME rpmsign SOVERSION 10)/'' sign/CMakeLists.txt'
  - pattern: for be in %{?with_ndb:ndb} %{?with_sqlite:sqlite}; do
    replacement: '# Skip rpmdb --initdb for cross-compilation (IRIX binary can''t run on Linux)

      # for be in %{?with_ndb:ndb} %{?with_sqlite:sqlite}; do

      for be in; do'
  - pattern: ln -s ../../bin/find-debuginfo
    replacement: ln -sf ../../bin/find-debuginfo
  - pattern: '%find_lang rpm'
    replacement: '# %find_lang rpm - skipped (NLS disabled)'
  - pattern: '%files -f _build/rpm.lang'
    replacement: '%files'
  - pattern: '%{_unitdir}/rpmdb-rebuild.service'
    replacement: '# %{_unitdir}/rpmdb-rebuild.service - systemd not available on IRIX'
  - pattern: '%{_unitdir}/rpmdb-migrate.service'
    replacement: '# %{_unitdir}/rpmdb-migrate.service - systemd not available on IRIX'
  - pattern: '%{_bindir}/rpm2archive'
    replacement: '# %{_bindir}/rpm2archive - not built (libarchive disabled)'
  - pattern: '%{_mandir}/man8/rpm2archive.8*'
    replacement: '# %{_mandir}/man8/rpm2archive.8* - not built (libarchive disabled)'
  - pattern: '%{_bindir}/rpmsort'
    replacement: '# %{_bindir}/rpmsort - not built in minimal config'
  - pattern: '%{_mandir}/man8/rpm-plugins.8*'
    replacement: '# %{_mandir}/man8/rpm-plugins.8* - not built (plugins disabled)'
  - pattern: '%{_libdir}/librpmio.so.%{sover}.*'
    replacement: '%{_libdir}/librpmio.so'
  - pattern: '%{_libdir}/librpm.so.%{sover}.*'
    replacement: '%{_libdir}/librpm.so'
  - pattern: '%{_libdir}/librpmbuild.so.%{sover}.*'
    replacement: '%{_libdir}/librpmbuild.so'
  - pattern: '%{_libdir}/librpmsign.so.%{sover}.*'
    replacement: '%{_libdir}/librpmsign.so'
  - pattern: '%{_libdir}/librpmio.so.%{sover}'
    replacement: '# versioned librpmio - not built for IRIX'
  - pattern: '%{_libdir}/librpm.so.%{sover}'
    replacement: '# versioned librpm - not built for IRIX'
  - pattern: '%{_libdir}/librpmbuild.so.%{sover}'
    replacement: '# versioned librpmbuild - not built for IRIX'
  - pattern: '%{_libdir}/librpmsign.so.%{sover}'
    replacement: '# versioned librpmsign - not built for IRIX'
  - pattern: '%dir %{_libdir}/rpm-plugins'
    replacement: '# %dir %{_libdir}/rpm-plugins - plugins disabled'
  - pattern: rm $RPM_BUILD_ROOT/%{_defaultdocdir}/rpm/README.md
    replacement: "rm -f $RPM_BUILD_ROOT/%{_defaultdocdir}/rpm/README.md\n\n# Merge rpm lib files from lib to lib32 for N32 ABI\nif [ -d $RPM_BUILD_ROOT/usr/sgug/lib/rpm ]; then\n  mkdir -p $RPM_BUILD_ROOT/usr/sgug/lib32/rpm\n\
      \  cp -a $RPM_BUILD_ROOT/usr/sgug/lib/rpm/* $RPM_BUILD_ROOT/usr/sgug/lib32/rpm/\n  rm -rf $RPM_BUILD_ROOT/usr/sgug/lib/rpm\nfi\n\n# Create /var/run for lockfiles (rpm owns this as lowest-level package\
      \ needing it)\nmkdir -p $RPM_BUILD_ROOT/var/run\n\n# Create /var/lib/rpm symlink to actual database location\nmkdir -p $RPM_BUILD_ROOT/var/lib\nln -sf ../../usr/sgug/lib32/sysimage/rpm $RPM_BUILD_ROOT/var/lib/rpm\n\
      \n# Create macros.sqlite to set sqlite as default database backend for IRIX\nmkdir -p $RPM_BUILD_ROOT/usr/sgug/etc/rpm\necho '%%_db_backend sqlite' > $RPM_BUILD_ROOT/usr/sgug/etc/rpm/macros.sqlite\n\
      \n# Create macros.ldconfig to make ldconfig macros no-ops on IRIX (uses rld instead)\ncat > $RPM_BUILD_ROOT/usr/sgug/etc/rpm/macros.ldconfig << 'LDCONFIG_EOF'\n# IRIX uses rld, not ldconfig - make\
      \ ldconfig macros no-ops\n%%ldconfig /bin/true\n%%ldconfig_post(n:) /bin/true\n%%ldconfig_postun(n:) /bin/true\n%%ldconfig_scriptlets(n:) %%{nil}\nLDCONFIG_EOF"
  - pattern: '%dir %{python3_sitearch}/rpm

      '
    replacement: ''
  - pattern: '%{python3_sitearch}/rpm-%{rpmver}*.egg-info

      '
    replacement: ''
  - pattern: '%{python3_sitearch}/rpm/__init__.py

      '
    replacement: ''
  - pattern: '%{python3_sitearch}/rpm/transaction.py

      '
    replacement: ''
  - pattern: '%{python3_sitearch}/rpm/_rpm.so

      '
    replacement: ''
  - pattern: '%{python3_sitearch}/rpm/__pycache__/

      '
    replacement: ''
  - pattern: '%{_defaultdocdir}/rpm/examples/*.py'
    replacement: ''
  - pattern: '%{_libdir}/rpm-plugins/selinux.so'
    replacement: ''
  - pattern: '%{_mandir}/man8/rpm-plugin-selinux.8*'
    replacement: ''
  - pattern: '%{_libdir}/rpm-plugins/syslog.so'
    replacement: ''
  - pattern: '%{_mandir}/man8/rpm-plugin-syslog.8*'
    replacement: ''
  - pattern: '%{_libdir}/rpm-plugins/systemd_inhibit.so'
    replacement: ''
  - pattern: '%{_mandir}/man8/rpm-plugin-systemd-inhibit.8*'
    replacement: ''
  - pattern: '%{_libdir}/rpm-plugins/fapolicyd.so'
    replacement: ''
  - pattern: '%{_mandir}/man8/rpm-plugin-fapolicyd.8*'
    replacement: ''
  - pattern: '%{_libdir}/rpm-plugins/prioreset.so'
    replacement: ''
  - pattern: '%{_mandir}/man8/rpm-plugin-prioreset.8*'
    replacement: ''
  - pattern: '%{_libdir}/rpm-plugins/audit.so'
    replacement: ''
  - pattern: '%{_mandir}/man8/rpm-plugin-audit.8*'
    replacement: ''
  - pattern: '%{_libdir}/rpm-plugins/dbus_announce.so'
    replacement: ''
  - pattern: '%{_mandir}/man8/rpm-plugin-dbus-announce.8*'
    replacement: ''
  - pattern: '%{_datadir}/dbus-1/system.d/org.rpm.conf'
    replacement: ''
  - pattern: '%bcond_without libarchive'
    replacement: '%bcond_with libarchive'
  - pattern: '%bcond_without libimaevm'
    replacement: '%bcond_with libimaevm'
  - pattern: '%if 0%{?rhel}

      %bcond_with fsverity

      %else

      %bcond_without fsverity

      %endif'
    replacement: '%bcond_with fsverity'
  - pattern: 'mkdir -p $RPM_BUILD_ROOT%{_unitdir}

      install -m 644 %{SOURCE10} $RPM_BUILD_ROOT/%{_unitdir}

      install -m 644 %{SOURCE20} $RPM_BUILD_ROOT/%{_unitdir}'
    replacement: '# Skip systemd unit file installation (not needed for IRIX)

      # mkdir -p $RPM_BUILD_ROOT%{_unitdir}

      # install -m 644 %{SOURCE10} $RPM_BUILD_ROOT/%{_unitdir}

      # install -m 644 %{SOURCE20} $RPM_BUILD_ROOT/%{_unitdir}'
  - pattern: '%doc CREDITS docs/manual/[a-z]*

      %doc %{_defaultdocdir}/rpm/CONTRIBUTING.md

      %doc %{_defaultdocdir}/rpm/COPYING

      %doc %{_defaultdocdir}/rpm/INSTALL

      %doc %{_defaultdocdir}/rpm/README'
    replacement: '%doc CREDITS docs/manual/[a-z]*

      %{_defaultdocdir}/rpm/'
  - pattern: '%{_bindir}/rpm

      # %{_bindir}/rpm2archive'
    replacement: '%dir /var/run

      /var/lib/rpm

      %dir /usr/sgug/etc/rpm

      %config(noreplace) /usr/sgug/etc/rpm/macros.sqlite

      %config(noreplace) /usr/sgug/etc/rpm/macros.ldconfig


      %{_bindir}/rpm

      # %{_bindir}/rpm2archive'
  - pattern: ln -sfr
    replacement: ln -sf
  - pattern: rpmdb_files=$(find /var/lib/rpm -maxdepth 1 -type f | sed 's|^/var/lib/rpm/||g' | sort)
    replacement: "for rpmdb_path in /var/lib/rpm/*; do\n        [ -f \"$rpmdb_path\" ] || continue\n        rpmdb_file=$(basename \"$rpmdb_path\")"
  - pattern: for rpmdb_file in ${rpmdb_files[@]}; do
    replacement: '# rpmdb_file loop converted to basename above'
