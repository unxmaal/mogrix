package: st
rules:
  inject_compat_functions:
  - openpty
  - pselect
  - unsetenv
  drop_buildrequires:
  - libX11-devel
  - libXext-devel
  drop_subpackages:
  - user
  drop_requires:
  - ncurses-base
  - font(liberationmono)
  - '%{_sbindir}/update-alternatives'
  prep_commands:
  - $MOGRIX_ROOT/tools/safepatch config.mk --old '-lrt ' --new '' --no-backup --quiet
  - $MOGRIX_ROOT/tools/safepatch config.mk --old '-lutil ' --new '' --no-backup --quiet
  - $MOGRIX_ROOT/tools/safepatch config.mk --old 'X11INC = /usr/X11R6/include' --new 'X11INC = ' --no-backup --quiet
  - $MOGRIX_ROOT/tools/safepatch config.mk --old 'X11LIB = /usr/X11R6/lib' --new 'X11LIB = ' --no-backup --quiet
  - $MOGRIX_ROOT/tools/safepatch config.mk --old '-lXft' --new '-lXft -lgen' --no-backup --quiet
  - $MOGRIX_ROOT/tools/safepatch config.mk --old '-D_XOPEN_SOURCE=600' --new '' --no-backup --quiet
  - "$MOGRIX_ROOT/tools/safepatch st.c --old '<libutil.h>' --insert-after \"$(printf '#else\\n #include <time.h>\\n #include <sys/termios.h>\\n #include <pty.h>\\nint pselect(int, fd_set *, fd_set *, fd_set *, const struct timespec *, const sigset_t *);')\" --no-backup --quiet"
  - "$MOGRIX_ROOT/tools/safepatch x.c --insert-top \"$(printf '#ifndef CLOCK_MONOTONIC\\n#define CLOCK_MONOTONIC 2 /* CLOCK_SGI_CYCLE */\\n#endif')\" --no-backup --quiet"
  - "$MOGRIX_ROOT/tools/safepatch x.c --old '#include <X11/XKBlib.h>' --insert-after 'int pselect(int, fd_set *, fd_set *, fd_set *, const struct timespec *, const sigset_t *);' --no-backup --quiet"
  - $MOGRIX_ROOT/tools/safepatch x.c --old 'XICCallback' --new 'XIMCallback' --count 0 --no-backup --quiet
  - $MOGRIX_ROOT/tools/safepatch x.c --old 'static int xicdestroy' --new 'static void xicdestroy' --no-backup --quiet
  - "$MOGRIX_ROOT/tools/safepatch x.c --old \"$(printf 'int\\nxicdestroy')\" --new \"$(printf 'void\\nxicdestroy')\" --no-backup --quiet"
  - "$MOGRIX_ROOT/tools/safepatch x.c --old \"$(printf 'xw.ime.xic = NULL;\\n\\t\\treturn 1;')\" --new \"$(printf 'xw.ime.xic = NULL;\\n\\t\\treturn;')\" --no-backup --quiet"
  - "$MOGRIX_ROOT/tools/safepatch x.c --old 'int pselect(int, fd_set *, fd_set *, fd_set *, const struct timespec *, const sigset_t *);' --insert-after '#define XSetIMValues(...) 0  /* IRIX X11R6.3: not available */' --no-backup --quiet"
  - $MOGRIX_ROOT/tools/safepatch x.c --old 'Xutf8TextListToTextProperty' --new 'XmbTextListToTextProperty' --count 0 --no-backup --quiet
  - $MOGRIX_ROOT/tools/safepatch x.c --old 'XUTF8StringStyle' --new 'XCompoundTextStyle' --count 0 --no-backup --quiet
  - "$MOGRIX_ROOT/tools/safepatch st.c --old 'if \\(ioctl.*TIOCSCTTY.*\\)' --new 'if (0) /* TIOCSCTTY not on IRIX */' --regex --no-backup --quiet"
  - $MOGRIX_ROOT/tools/safepatch config.def.h --old 'Liberation Mono' --new 'monospace' --no-backup --quiet
  spec_replacements:
  - pattern: CFLAGS="%{optflags}" LDFLAGS="%{?__global_ldflags}" make %{?_smp_mflags}
    replacement: "# Build mogrix compat library first (before main build — plain Makefile, not autotools)\nCOMPAT_DIR=$(pwd)/mogrix-compat\nfor f in $COMPAT_DIR/*.c; do\n  %{__cc} %{optflags} -c \"$f\"\
      \ -o \"${f%.c}.o\"\ndone\n%{__ar} rcs \"$COMPAT_DIR/libmogrix-compat.a\" $COMPAT_DIR/*.o\n# Build st with cross-compiler and compat library\nexport PKG_CONFIG_LIBDIR=\"%{_sgug_staging}/lib32/pkgconfig\"\
      \nexport PKG_CONFIG_SYSROOT_DIR=\"/opt/sgug-staging\"\nmake %{?_smp_mflags} CC=\"%{__cc}\" CFLAGS=\"%{optflags}\" LDFLAGS=\"%{?__global_ldflags} -L$COMPAT_DIR -lmogrix-compat\"\n"
  - pattern: 'mv %{buildroot}%{_bindir}/%{name}{,-fedora}

      '
    replacement: '# st-fedora rename skipped for IRIX

      '
  - pattern: 'install -pm755 %{SOURCE2} %{buildroot}%{_bindir}/%{name}-user

      '
    replacement: '# st-user install skipped for IRIX

      '
  - pattern: 'install -Dpm644 %{SOURCE3} %{buildroot}%{_mandir}/man1/%{name}-user.1

      '
    replacement: '# st-user man page skipped for IRIX

      '
  - pattern: "for file in \\\n    %{buildroot}%{_bindir}/%{name}-user \\\n    %{buildroot}%{_mandir}/man1/%{name}-user.1; do\nsed -i -e 's/VERSION/%{version}/' \\\n       -e 's/RELEASE/%{release}/' \\\n\
      \       ${file}\ndone\n"
    replacement: '# st-user version substitution skipped

      '
  - pattern: "mkdir -p %{buildroot}%{_stsourcedir}\ninstall -m644 * \\\n    %{buildroot}%{_stsourcedir}\n"
    replacement: '# st-user source dir skipped

      '
  - pattern: 'touch %{buildroot}%{_bindir}/%{name}

      '
    replacement: '# ghost touch skipped — st is a real binary now

      '
  - pattern: 'desktop-file-install --dir=%{buildroot}%{_datadir}/applications %{SOURCE1}

      '
    replacement: '# desktop-file-install skipped for IRIX

      '
  - pattern: '%pre

      [ -L %{_bindir}/%{name} ] || rm -f %{_bindir}/%{name}

      '
    replacement: ''
  - pattern: "%post\n%{_sbindir}/update-alternatives --install %{_bindir}/%{name} %{name} \\\n    %{_bindir}/%{name}-fedora 10\n"
    replacement: ''
  - pattern: "%postun\nif [ $1 -eq 0 ] ; then\n    %{_sbindir}/update-alternatives --remove %{name} %{_bindir}/%{name}-fedora\nfi\n"
    replacement: ''
  - pattern: "%post user\n%{_sbindir}/update-alternatives --install %{_bindir}/%{name} %{name} \\\n    %{_bindir}/%{name}-user 20\n"
    replacement: ''
  - pattern: "%postun user\nif [ $1 -eq 0 ] ; then\n    %{_sbindir}/update-alternatives --remove %{name} %{_bindir}/%{name}-user\nfi\n"
    replacement: ''
  - pattern: '%ghost %{_bindir}/%{name}

      %{_bindir}/%{name}-fedora

      '
    replacement: '%{_bindir}/%{name}

      '
  - pattern: '%{_datadir}/applications/%{name}.desktop

      '
    replacement: ''
  - pattern: '%{_mandir}/man1/%{name}.*

      '
    replacement: '%{_mandir}/man1/%{name}.1*

      '
  install_cleanup:
  - rm -f %{buildroot}%{_datadir}/applications/st.desktop
  - rm -rf %{buildroot}%{_usrsrc}/st-*
  - rm -f %{buildroot}%{_bindir}/st-user
  - rm -f %{buildroot}%{_bindir}/st-fedora
  - rm -f %{buildroot}%{_mandir}/man1/st-user.1*
