# rsync - file synchronization tool (FC40: 3.2.7)
package: rsync

rules:
  inject_compat_functions:
    - stpcpy

  # IRIX doesn't support 128-bit long double — rsync's bundled snprintf
  # uses LDOUBLE for %f formatting, triggering __extenddftf2 which crashes.
  ac_cv_overrides:
    ac_cv_type_long_double_wider: "no"

  drop_buildrequires:
    - popt-devel
    - lz4-devel
    - xxhash-devel

  configure_flags:
    add:
      - "--disable-lz4"
      - "--disable-xxhash"
      - "--enable-openssl"
      - "--enable-zstd"
      - "--enable-ipv6"
    remove:
      - "--enable-lz4"
      - "--enable-xxhash"

  drop_subpackages:
    - "daemon"

  spec_replacements:
    # Collapse conditional %prep — isprerelease=0, so use non-prerelease setup
    # Also removes the %if block where emitter wrongly injected compat copies
    - pattern: |
        %if %isprerelease
        %setup -q -n rsync-%{version}%{?prerelease}
      replacement: |
        %if 0
        %setup -q -n rsync-%{version}%{?prerelease}

    # Re-inject compat copies after patches (emitter put them in dead %if branch)
    # Must list ALL compat sources — generic + package-specific + extra_files
    - pattern: "%patch 2 -p1 -b .buffer-overflow"
      replacement: |
        %patch 2 -p1 -b .buffer-overflow

        # Mogrix compat sources (re-injected — emitter put them in %if branch)
        mkdir -p mogrix-compat
        for src in %{SOURCE100} %{SOURCE101} %{SOURCE102} %{SOURCE103} %{SOURCE104} %{SOURCE105} %{SOURCE106}; do
          cp "$src" mogrix-compat/
        done

    # Remove systemd unit file installations (daemon subpackage dropped)
    - pattern: "install -D -m644 %{SOURCE3} $RPM_BUILD_ROOT/%{_unitdir}/rsyncd.service"
      replacement: "# systemd services disabled for IRIX"
    - pattern: "install -D -m644 %{SOURCE2} $RPM_BUILD_ROOT/%{_unitdir}/rsyncd.socket"
      replacement: "# systemd socket disabled"
    - pattern: "install -D -m644 %{SOURCE4} $RPM_BUILD_ROOT/%{_sysconfdir}/rsyncd.conf"
      replacement: "install -D -m644 %{SOURCE4} $RPM_BUILD_ROOT/%{_sysconfdir}/rsyncd.conf"
    - pattern: "install -D -m644 %{SOURCE5} $RPM_BUILD_ROOT/%{_sysconfdir}/sysconfig/rsyncd"
      replacement: "# sysconfig disabled"
    - pattern: "install -D -m644 %{SOURCE6} $RPM_BUILD_ROOT/%{_unitdir}/rsyncd@.service"
      replacement: "# systemd template disabled"

    # Remove daemon scriptlet sections (drop_subpackages doesn't remove these)
    - pattern: "%post daemon\n"
      replacement: ""
    - pattern: "%preun daemon\n"
      replacement: ""
    - pattern: "%postun daemon\n"
      replacement: ""

