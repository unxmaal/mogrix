# libxml2 - XML parsing library
# Successfully cross-compiled for IRIX N32
# Note: pthread causes crashes on IRIX, so threads are disabled

package: libxml2

# Note: The old SGUG patch (libxml2.sgifixes.patch) was for xml2-config.in libdir handling
# which is no longer needed in libxml2 2.12.x - it now uses @libdir@ from configure

rules:
  # Skip tests - can't run cross-compiled binaries
  skip_check: true

  # Compat functions that may be needed
  inject_compat_functions:
    - strdup
    - strndup

  # Configure flags
  configure_flags:
    add:
      - --disable-silent-rules
      - --without-python
      - --without-icu
      - --without-zlib
      - --without-lzma
      - --without-threads    # CRITICAL: pthread crashes IRIX rld
      - --without-tls
    remove:
      - --with-python
      - --with-zlib
      - --with-lzma
      - --with-threads
      - --with-tls

  configure_disable:
    - static

  # Disable the check targets in Makefile.in (cross-compiled binaries can't run on host)
  prep_commands:
    - "sed -i 's/^check-local:.*/check-local:/' Makefile.in"
    - "sed -i 's/^check-am:.*/check-am:/' Makefile.in"

  # All spec replacements in single section
  spec_replacements:
    # Skip the check phase entirely
    - pattern: "%check"
      replacement: "%check\nexit 0\n# Original check section:"

    # Fix libtool to build shared libraries for IRIX
    - pattern: "%make_build"
      replacement: |
        # Fix libtool to build shared libraries for IRIX
        sed -i 's/build_libtool_libs=no/build_libtool_libs=yes/g' libtool
        sed -i 's/deplibs_check_method="unknown"/deplibs_check_method="pass_all"/g' libtool
        sed -i 's/^version_type=none$/version_type=linux/g' libtool
        sed -i 's/^soname_spec=""$/soname_spec="\\$libname\\${shared_ext}\\$major"/g' libtool
        sed -i 's/^library_names_spec=""$/library_names_spec="\\$libname\\${shared_ext}\\$versuffix \\$libname\\${shared_ext}\\$major \\$libname\\${shared_ext}"/g' libtool
        %make_build

    # Remove Python subpackage since we build --without-python
    - pattern: "%package -n python3-libxml2"
      replacement: "# Disabled: %package -n python3-libxml2"
    - pattern: "%description -n python3-libxml2"
      replacement: "# Disabled: %description -n python3-libxml2"
    - pattern: "%files -n python3-libxml2"
      replacement: "# Disabled: %files -n python3-libxml2"
    - pattern: "%{python3_sitearch}/libxml2mod.so"
      replacement: ""
    - pattern: "%{python3_sitelib}/libxml2.py"
      replacement: ""
    - pattern: "%{python3_sitelib}/__pycache__/libxml2.*"
      replacement: ""
    - pattern: "%{python3_sitelib}/drv_libxml2.py"
      replacement: ""
    - pattern: "%{python3_sitelib}/__pycache__/drv_libxml2.*"
      replacement: ""
    - pattern: "%doc doc/apibuild.py"
      replacement: ""
