smoke_test:
- command: /usr/sgug/bin/perl -e 'print "ok\n"'
  expect: ok
- command: /usr/sgug/bin/perl -v
  expect: 5.38.2
package: perl
add_patch:
- perl.sgifixes.patch
add_source:
- perl.irix6_clang_config.sh
rules:
  drop_subpackages:
  - '[A-Za-z]*'
  drop_buildrequires:
  - libdb-devel
  - groff-base
  - procps
  - tcsh
  drop_requires:
  - rtld(GNU_HASH)
  remove_lines:
  - 'Requires:       perl-'
  - 'Requires:       %perl_compat'
  - '%gendep_perl'
  spec_replacements:
  - pattern: '%global dual_life 0'
    replacement: '%global dual_life 1'
  - pattern: '%bcond_without perl_enables_systemtap'
    replacement: '%bcond_with perl_enables_systemtap'
  - pattern: '%bcond_without perl_enables_cplusplus_test'
    replacement: '%bcond_with perl_enables_cplusplus_test'
  - pattern: '%bcond_without bdb'
    replacement: '%bcond_with bdb'
  - pattern: '%bcond_without gdbm'
    replacement: '%bcond_with gdbm'
  - pattern: '%bcond_without perl_enables_groff'
    replacement: '%bcond_with perl_enables_groff'
  - pattern: '%bcond_without perl_enables_turkish_test'
    replacement: '%bcond_with perl_enables_turkish_test'
  - pattern: '# Set optimize=none to prevent from injecting upstream''s value.

      /bin/sh Configure -des \

      '
    replacement: "# IRIX: Use pre-generated config.sh for cross-compilation\ncp %{SOURCE200} config.sh\nsed -i 's|DIDBSINSTALLPREFIX/lib|%{_libdir}|g' config.sh\nsed -i 's|DIDBSINSTALLPREFIX|%{_prefix}|g'\
      \ config.sh\n# Update perl version paths in config.sh\nsed -i 's|perl5/5.38|perl5/%{perl_abi}|g' config.sh\n# Fix cc/ld/cpp to use full staging path (irix-cc -> full path)\nsed -i \"s|irix-cc|%{__cc}|g\"\
      \ config.sh\nbash ./Configure -S\n# Build native miniperl for the host (no DynaLoader, can't load .so)\n# This prevents the \"wrong ELF class\" error when build scripts try to\n# load cross-compiled\
      \ MIPS .so files. A real miniperl has no XS loading.\ncp config.h config.h.cross\ncp $(perl -MConfig -e 'print $Config{archlib}')/CORE/config.h config.h\n# Point MINIPERL to our native binary (not\
      \ the IRIX one make will build)\n# -Ilib MUST be first so @INC[0]='lib' and buildcustomize.pl loads correctly\n# -I. added after for perl 5.26+ (. not in @INC)\nsed -i 's|MINIPERL = \\$(LDLIBPTH)\
      \ ./miniperl\\$(EXE_EXT) -Ilib|MINIPERL = $(LDLIBPTH) ./miniperl.native -Ilib -I.|' Makefile\n# Build generate_uudmap and generate headers (needed by globals.c)\ngcc -o generate_uudmap.host generate_uudmap.c\n\
      ./generate_uudmap.host uudmap.h bitcount.h mg_data.h\n# Create git_version.h if it doesn't exist\ntest -f git_version.h || echo '#define PERL_GIT_UNPUSHED_COMMITS /*leave blank*/' > git_version.h\n\
      mkdir -p native_obj\n# Note: op.c, perl.c, universal.c are excluded - only their mini variants\n# (opmini.c, perlmini.c, universalmini.c) with -DPERL_IS_MINIPERL are used\nfor src in av.c scope.c\
      \ peep.c doop.c doio.c dump.c gv.c hv.c \\\n    mg.c reentr.c mro_core.c perly.c pp.c pp_hot.c pp_ctl.c \\\n    pp_sys.c utf8.c sv.c taint.c toke.c util.c deb.c run.c builtin.c \\\n    class.c pad.c\
      \ globals.c keywords.c perlio.c numeric.c \\\n    mathoms.c locale.c pp_pack.c pp_sort.c caretx.c dquote.c time64.c \\\n    regcomp.c regcomp_debug.c regcomp_invlist.c regcomp_study.c \\\n    regcomp_trie.c\
      \ regexec.c miniperlmain.c; do\n    base=$(basename $src .c)\n    gcc -DPERL_CORE -DPTHREAD_H_FIRST -O2 -I. -fPIC \\\n        -c -o native_obj/${base}.o $src || exit 1\ndone\nln -sf op.c opmini.c\n\
      ln -sf perl.c perlmini.c\nln -sf universal.c universalmini.c\nfor src in opmini.c perlmini.c universalmini.c; do\n    base=$(basename $src .c)\n    gcc -DPERL_CORE -DPTHREAD_H_FIRST -DPERL_IS_MINIPERL\
      \ \\\n        -DPERL_EXTERNAL_GLOB -O2 -I. -fPIC \\\n        -c -o native_obj/${base}.o $src || exit 1\ndone\ngcc -o miniperl.native native_obj/*.o -ldl -lm -lpthread -lcrypt\ncp config.h.cross config.h\n\
      # Original Configure invocation disabled for cross-compilation:\nif false; then\n# Set optimize=none to prevent from injecting upstream's value.\n/bin/sh Configure -des \\\n"
  - pattern: '        -Duse64bitint'
    replacement: '        -Duse64bitint

      fi'
  - pattern: make %{?_smp_mflags}
    replacement: '# Clean stale artifacts from Configure -S''s internal make

      rm -f *.o makefile lib/buildcustomize.pl miniperl generate_uudmap miniperl.xok

      make %{?_smp_mflags}

      '
  - pattern: "for i in sys/ioctl.h sys/syscall.h syscall.h\ndo\n    %{new_perl} %{build_bindir}/h2ph -a -d %{build_archlib} $i || true\ndone\n"
    replacement: '# IRIX: Skip h2ph generation (requires running target perl)

      # h2ph should be run on IRIX after installation

      true

      '
  - pattern: "%{new_perl} -MConfig -i -pn \\\n    -e 's\"\\A#!(?:perl|\\./perl|/perl|/usr/bin/perl|/usr/bin/env perl)\\b\"$Config{startperl}\"' \\\n    $(find %{buildroot}%{perl5_testdir}/perl-tests -type\
      \ f)\n"
    replacement: '# IRIX: Skip shebang normalization (can''t run cross-compiled perl)

      true

      '
  - pattern: '%global perl_archname %{_arch}-%{_os}%{perl_arch_stem}'
    replacement: '%global perl_archname mips-thread-multi'
  - pattern: ln -s "libperl.so.%{perl_version}" "$RPM_BUILD_ROOT%{_libdir}/%{soname}"
    replacement: ln -sf "libperl.so.%{perl_version}" "$RPM_BUILD_ROOT%{_libdir}/%{soname}"
  - pattern: ln -s "libperl.so.%{perl_version}" "$RPM_BUILD_ROOT%{_libdir}/libperl.so"
    replacement: ln -sf "libperl.so.%{perl_version}" "$RPM_BUILD_ROOT%{_libdir}/libperl.so"
  - pattern: '    s|INCLUDE         = ./zlib-src|INCLUDE         = %{_includedir}|'
    replacement: '    s|INCLUDE         = ./zlib-src|INCLUDE         = /opt/sgug-staging/usr/sgug/include|'
  - pattern: '    s|LIB             = ./zlib-src|LIB             = %{_libdir}|'
    replacement: '    s|LIB             = ./zlib-src|LIB             = /opt/sgug-staging/usr/sgug/lib32|'
  - pattern: "pushd $RPM_BUILD_ROOT%{_mandir}/man1/\n  for i in perl588delta.1 perldelta.1 ; do\n    iconv -c -f MS-ANSI -t UTF-8 $i --output new-$i\n    rm $i\n    mv new-$i $i\n  done\npopd\n"
    replacement: "cd $RPM_BUILD_ROOT%{_mandir}/man1/\n  for i in perl588delta.1 perldelta.1 ; do\n    if [ -f \"$i\" ]; then\n      iconv -c -f MS-ANSI -t UTF-8 $i --output new-$i\n      rm $i\n      mv\
      \ new-$i $i\n    fi\n  done\ncd -\n"
  - pattern: '

      rm %{buildroot}'
    replacement: '

      rm -f %{buildroot}'
  - pattern: '

      rm %{build_'
    replacement: '

      rm -f %{build_'
  - pattern: '

      rm $RPM_BUILD_ROOT'
    replacement: '

      rm -f $RPM_BUILD_ROOT'
  - pattern: '%files

      # Main perl package is an empty meta package.'
    replacement: '%files -f perl-filelist.txt

      %license Artistic Copying'
  - pattern: '%global perl_archname mips-thread-multi'
    replacement: '%global perl_archname mips-thread-multi

      %define _unpackaged_files_terminate_build 0'
  - pattern: 'Provides:       perl-core = %{perl_version}-%{release}'
    replacement: 'Provides: perl-interpreter

      Provides: perl(File::Compare)

      Provides: perl(Thread::Queue)

      Provides: perl(threads)

      Provides:       perl-core = %{perl_version}-%{release}

      '
  install_cleanup:
  - find %{buildroot}%{_bindir} -type f -exec grep -l '#!/usr/bin/perl' {} \; | xargs -r sed -i 's|#!/usr/bin/perl|#!/usr/sgug/bin/perl|g'
  - find %{buildroot}%{_bindir} -type f -exec grep -l '#!.*perl' {} \; | xargs -r sed -i 's|#!/usr/local/bin/perl|#!/usr/sgug/bin/perl|g'
  - find $RPM_BUILD_ROOT -type f -o -type l | sed "s|$RPM_BUILD_ROOT||" | sort > perl-filelist.txt
