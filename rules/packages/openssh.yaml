# openssh - OpenSSH SSH daemon and client tools for IRIX
# FC40: openssh-9.6p1-1.fc40.2
# Build system: autotools (autoreconf in %prep)
#
# OpenSSH has extensive portability layer (openbsd-compat/) including
# memmem, getline, asprintf, snprintf, closefrom, openpty, getentropy.
# configure.ac already knows about IRIX (*-*-irix6* case).
# We do NOT inject mogrix compat functions — openssh provides its own.
#
# Strategy: Drop ALL Fedora patches. Use clean upstream openssh 9.6p1.
# Fedora patches add GSSAPI, SELinux, audit, systemd, FIPS, PKCS#11 URI
# support — all features we disable on IRIX. Clean upstream avoids
# patch dependency chains.

package: openssh

smoke_test:
  - command: "/usr/sgug/bin/ssh -V"
    expect: "OpenSSH_9.6"

rules:
  # === BuildRequires to drop ===
  drop_buildrequires:
    - pam-devel
    - libfido2-devel
    - p11-kit-devel
    - gtk3-devel
    - gtk2-devel
    - libX11-devel          # Only for gnome-askpass
    - perl-generators
    - perl-podlators
    - groff
    - util-linux
    - xauth
    - libedit-devel
    - ncurses-devel         # Only needed for libedit
    - krb5-devel
    - systemd-rpm-macros

  # === Runtime deps to drop ===
  drop_requires:
    - "/sbin/nologin"
    - "crypto-policies"
    - "pam"
    - "/usr/sbin/useradd"
    - "p11-kit"

  # === Subpackages to drop ===
  # Note: pam_ssh_agent_auth uses -n syntax which drop_subpackages can't handle.
  # Note: sk-dummy must NOT be here — _comment_subpackage overshoots past blank
  # line and comments %if %{pam_ssh_agent} that wraps the next %files section.
  # Both are handled via spec_replacements instead.
  drop_subpackages:
    - keycat
    - askpass

  # === ac_cv overrides ===
  ac_cv_overrides:
    # IRIX _getpty for PTY allocation
    ac_cv_func__getpty: "yes"
    ac_cv_func_setrlimit: "yes"
    # IRIX libc has __b64_ntop/__b64_pton but with HIDDEN visibility.
    # LLD sees them at build time but rld can't resolve at runtime.
    # Force openssh to use its own openbsd-compat replacements.
    ac_cv_func_b64_ntop: "no"
    ac_cv_func___b64_ntop: "no"
    ac_cv_func_b64_pton: "no"
    ac_cv_func___b64_pton: "no"
    # OpenSSL functions — all link tests fail in cross-compile.
    # These all exist in our OpenSSL 3.2.1 headers (some deprecated but present).
    ac_cv_func_BN_is_prime_ex: "yes"
    ac_cv_func_DSA_generate_parameters_ex: "yes"
    ac_cv_func_EC_KEY_METHOD_new: "yes"
    # EVP_CIPHER_CTX_get_iv does NOT exist in OpenSSL 3.x — openssh provides its own
    ac_cv_func_EVP_CIPHER_CTX_get_updated_iv: "yes"
    ac_cv_func_EVP_CIPHER_CTX_iv: "yes"
    ac_cv_func_EVP_CIPHER_CTX_iv_noconst: "yes"
    ac_cv_func_EVP_PKEY_get_raw_private_key: "yes"
    ac_cv_func_EVP_PKEY_get_raw_public_key: "yes"
    ac_cv_func_EVP_sha256: "yes"
    ac_cv_func_EVP_sha384: "yes"
    ac_cv_func_EVP_sha512: "yes"
    ac_cv_func_OpenSSL_version: "yes"
    ac_cv_func_OpenSSL_version_num: "yes"
    ac_cv_func_RSA_generate_key_ex: "yes"

  # === Configure flags ===
  # Note: Do NOT use configure_flags:remove here — it breaks \ continuations
  # in the multi-line %configure block. Instead, use spec_replacements to
  # replace flag lines with bare \ continuations.
  # Flags already in spec: --with-pie=no, --without-hardening
  # Flags from %else branches: --without-kerberos5 (kerberos5=0), --without-libedit (libedit=0)
  # Flags inside %if WITH_SELINUX (=0): --with-selinux, --with-audit, --with-sandbox=seccomp
  configure_flags:
    add:
      - "--with-sandbox=no"
      - "--without-pam"
      - "--without-systemd"
      - "--without-security-key-builtin"
      - "--with-privsep-user=sshd"
      - "--with-ssl-dir=/usr/sgug"
      - "--with-zlib=/usr/sgug"

  # === Systemd scriptlet removal ===
  remove_lines:
    - "%sysusers_create_compat"
    - "%systemd_post"
    - "%systemd_preun"
    - "%systemd_postun_with_restart"
    - "%systemd_user_post"
    - "%systemd_user_preun"

  # === Spec replacements ===
  spec_replacements:
    # ── Feature flag overrides ──
    - pattern: "%global WITH_SELINUX 1"
      replacement: "%global WITH_SELINUX 0"
    - pattern: "%global no_gnome_askpass 0"
      replacement: "%global no_gnome_askpass 1"
    - pattern: "%global pie 1"
      replacement: "%global pie 0"
    - pattern: "%global kerberos5 1"
      replacement: "%global kerberos5 0"
    - pattern: "%global libedit 1"
      replacement: "%global libedit 0"
    # pam_ssh_agent is conditional but may resolve to 1
    - pattern: "%global pam_ssh_agent 1"
      replacement: "%global pam_ssh_agent 0"

    # ── Remove standalone configure flags (keep \ continuation) ──
    # configure_flags:remove breaks \ continuations. Instead, replace
    # each flag line with just tab+backslash to maintain the chain.
    - pattern: "\t--with-systemd \\"
      replacement: "\t\\"
    - pattern: "\t--with-default-pkcs11-provider=yes \\"
      replacement: "\t\\"
    - pattern: "\t--with-security-key-builtin=yes \\"
      replacement: "\t\\"
    - pattern: "\t--with-pam \\"
      replacement: "\t\\"

    # ── Pre-comment %files sections to prevent _comment_subpackage overshoot ──
    # Bug: _comment_subpackage's %files loop doesn't stop at %if/%endif,
    # causing it to overshoot into adjacent sections. Pre-commenting the
    # %files blocks means the loop regex won't match, avoiding the bug.
    - pattern: "%files keycat\n%doc HOWTO.ssh-keycat\n%attr(0755,root,root) %{_libexecdir}/openssh/ssh-keycat\n%attr(0644,root,root) %config(noreplace) /etc/pam.d/ssh-keycat"
      replacement: "# %files keycat (disabled for IRIX)\n# %doc HOWTO.ssh-keycat\n# %attr ssh-keycat\n# %attr /etc/pam.d/ssh-keycat"
    - pattern: "%if ! %{no_gnome_askpass}\n%files askpass\n%attr(0644,root,root) %{_sysconfdir}/profile.d/gnome-ssh-askpass.*\n%attr(0755,root,root) %{_libexecdir}/openssh/gnome-ssh-askpass\n%attr(0755,root,root) %{_libexecdir}/openssh/ssh-askpass\n%endif"
      replacement: "# %if ! %{no_gnome_askpass}  (disabled for IRIX)\n# %files askpass (disabled)\n# %attr gnome-ssh-askpass.*\n# %attr gnome-ssh-askpass\n# %attr ssh-askpass\n# %endif"
    - pattern: "%files sk-dummy\n%attr(0755,root,root) %{_libdir}/sshtest/sk-dummy.so"
      replacement: "# %files sk-dummy (disabled for IRIX)\n# %attr sk-dummy.so"

    # ── sk-dummy %package/%description (drop_subpackages can't handle adjacency) ──
    - pattern: "%package sk-dummy\nSummary: OpenSSH SK driver for test purposes\nRequires: openssh = %{version}-%{release}"
      replacement: "# %package sk-dummy  # disabled for IRIX\n# Summary: OpenSSH SK driver (disabled)\n# Requires: openssh (sk-dummy disabled)"
    - pattern: "%description sk-dummy\nThis package contains a test SK driver used for OpenSSH test purposes"
      replacement: "# %description sk-dummy (disabled)\n# (test SK driver disabled)"

    # ── pam_ssh_agent_auth subpackage (drop_subpackages can't handle -n) ──
    - pattern: "%package -n pam_ssh_agent_auth"
      replacement: "# %package -n pam_ssh_agent_auth  # disabled for IRIX"
    - pattern: "Summary: PAM module for authentication with ssh-agent"
      replacement: "# Summary: PAM module (pam_ssh_agent_auth disabled)"
    - pattern: "Version: %{pam_ssh_agent_ver}"
      replacement: "# Version: pam_ssh_agent (disabled)"
    - pattern: "Release: %{pam_ssh_agent_rel}.%{openssh_rel}%{?dist}.2"
      replacement: "# Release: pam_ssh_agent (disabled)"
    - pattern: "License: BSD-3-Clause AND BSD-2-Clause AND ISC AND SSH-OpenSSH AND ssh-keyscan AND sprintf AND LicenseRef-Fedora-Public-Domain AND X11-distribute-modifications-variant AND OpenSSL"
      replacement: "# License: pam_ssh_agent (disabled)"
    - pattern: "%description -n pam_ssh_agent_auth"
      replacement: "# %description -n pam_ssh_agent_auth  # disabled for IRIX"
    - pattern: "This package contains a PAM module which can be used to authenticate"
      replacement: "# (pam_ssh_agent_auth description disabled)"
    - pattern: "users using ssh keys stored in a ssh-agent. Through the use of the"
      replacement: "#"
    - pattern: "forwarding of ssh-agent connection it also allows to authenticate with"
      replacement: "#"
    - pattern: "remote ssh-agent instance."
      replacement: "#"
    - pattern: "The module is most useful for su and sudo service stacks."
      replacement: "#"

    # ── pam_ssh_agent_auth autoreconf (unconditional in %prep, not wrapped in %if) ──
    - pattern: "pushd pam_ssh_agent_auth-pam_ssh_agent_auth-%{pam_ssh_agent_ver}\nautoreconf\npopd"
      replacement: "# pam_ssh_agent_auth autoreconf disabled (pam_ssh_agent=0)"

    # ── GPG verification (gpgv2 not in cross-build) ──
    - pattern: "gpgv2 --quiet --keyring %{SOURCE3} %{SOURCE1} %{SOURCE0}"
      replacement: "# gpgv2 verification disabled for cross-build"

    # ── Comment ALL Fedora patches ──
    # Lines 373-434: unconditional patch applications
    - pattern: "%patch -P 400 -p1 -b .role-mls"
      replacement: "# %patch -P 400 disabled (SELinux)"
    - pattern: "%patch -P 404 -p1 -b .privsep-selinux"
      replacement: "# %patch -P 404 disabled (SELinux)"
    - pattern: "%patch -P 502 -p1 -b .keycat"
      replacement: "# %patch -P 502 disabled (SELinux keycat)"
    - pattern: "%patch -P 601 -p1 -b .ip-opts"
      replacement: "# %patch -P 601 disabled (all Fedora patches dropped)"
    - pattern: "%patch -P 606 -p1 -b .ipv6man"
      replacement: "# %patch -P 606 disabled"
    - pattern: "%patch -P 607 -p1 -b .sigpipe"
      replacement: "# %patch -P 607 disabled"
    - pattern: "%patch -P 609 -p1 -b .x11"
      replacement: "# %patch -P 609 disabled"
    - pattern: "%patch -P 702 -p1 -b .progress"
      replacement: "# %patch -P 702 disabled"
    - pattern: "%patch -P 703 -p1 -b .grab-info"
      replacement: "# %patch -P 703 disabled"
    - pattern: "%patch -P 707 -p1 -b .redhat"
      replacement: "# %patch -P 707 disabled (Fedora defaults)"
    - pattern: "%patch -P 711 -p1 -b .log-usepam-no"
      replacement: "# %patch -P 711 disabled (PAM)"
    - pattern: "%patch -P 800 -p1 -b .gsskex"
      replacement: "# %patch -P 800 disabled (GSSAPI)"
    - pattern: "%patch -P 801 -p1 -b .force_krb"
      replacement: "# %patch -P 801 disabled (Kerberos)"
    - pattern: "%patch -P 804 -p1 -b .ccache_name"
      replacement: "# %patch -P 804 disabled (GSSAPI)"
    - pattern: "%patch -P 805 -p1 -b .k5login"
      replacement: "# %patch -P 805 disabled (Kerberos)"
    - pattern: "%patch -P 901 -p1 -b .kuserok"
      replacement: "# %patch -P 901 disabled (Kerberos)"
    - pattern: "%patch -P 906 -p1 -b .fromto-remote"
      replacement: "# %patch -P 906 disabled"
    - pattern: "%patch -P 916 -p1 -b .contexts"
      replacement: "# %patch -P 916 disabled (SELinux)"
    - pattern: "%patch -P 918 -p1 -b .log-in-chroot"
      replacement: "# %patch -P 918 disabled"
    - pattern: "%patch -P 919 -p1 -b .scp"
      replacement: "# %patch -P 919 disabled"
    - pattern: "%patch -P 802 -p1 -b .GSSAPIEnablek5users"
      replacement: "# %patch -P 802 disabled (GSSAPI)"
    - pattern: "%patch -P 922 -p1 -b .sshdt"
      replacement: "# %patch -P 922 disabled"
    - pattern: "%patch -P 926 -p1 -b .sftp-force-mode"
      replacement: "# %patch -P 926 disabled"
    - pattern: "%patch -P 939 -p1 -b .s390-dev"
      replacement: "# %patch -P 939 disabled (s390)"
    - pattern: "%patch -P 944 -p1 -b .x11max"
      replacement: "# %patch -P 944 disabled"
    - pattern: "%patch -P 948 -p1 -b .systemd"
      replacement: "# %patch -P 948 disabled (systemd)"
    - pattern: "%patch -P 949 -p1 -b .refactor"
      replacement: "# %patch -P 949 disabled (SELinux)"
    - pattern: "%patch -P 950 -p1 -b .sandbox"
      replacement: "# %patch -P 950 disabled (Linux sandbox)"
    - pattern: "%patch -P 951 -p1 -b .pkcs11-uri"
      replacement: "# %patch -P 951 disabled (PKCS#11)"
    - pattern: "%patch -P 953 -p1 -b .scp-ipv6"
      replacement: "# %patch -P 953 disabled"
    - pattern: "%patch -P 962 -p1 -b .crypto-policies"
      replacement: "# %patch -P 962 disabled (crypto-policies)"
    - pattern: "%patch -P 963 -p1 -b .openssl-evp"
      replacement: "# %patch -P 963 disabled (OpenSSL EVP)"
    - pattern: "%patch -P 964 -p1 -b .openssl-kdf"
      replacement: "# %patch -P 964 disabled (OpenSSL KDF)"
    - pattern: "%patch -P 965 -p1 -b .visibility"
      replacement: "# %patch -P 965 disabled"
    - pattern: "%patch -P 966 -p1 -b .x11-ipv6"
      replacement: "# %patch -P 966 disabled"
    - pattern: "%patch -P 974 -p1 -b .keygen-strip-doseol"
      replacement: "# %patch -P 974 disabled"
    - pattern: "%patch -P 975 -p1 -b .preserve-pam-errors"
      replacement: "# %patch -P 975 disabled (PAM)"
    - pattern: "%patch -P 977 -p1 -b .kill-scp"
      replacement: "# %patch -P 977 disabled"
    - pattern: "%patch -P 981 -p1 -b .scp-sftpdirs"
      replacement: "# %patch -P 981 disabled"
    - pattern: "%patch -P 982 -p1 -b .minrsabits"
      replacement: "# %patch -P 982 disabled"
    - pattern: "%patch -P 984 -p1 -b .ibmca"
      replacement: "# %patch -P 984 disabled (IBM)"
    - pattern: "%patch -P 200 -p1 -b .audit"
      replacement: "# %patch -P 200 disabled (audit)"
    - pattern: "%patch -P 201 -p1 -b .audit-race"
      replacement: "# %patch -P 201 disabled (audit)"
    - pattern: "%patch -P 202 -p1 -b .audit-log"
      replacement: "# %patch -P 202 disabled (audit)"
    - pattern: "%patch -P 700 -p1 -b .fips"
      replacement: "# %patch -P 700 disabled (FIPS)"
    - pattern: "%patch -P 1002 -p1 -b .ssh-manpage"
      replacement: "# %patch -P 1002 disabled"
    - pattern: "%patch -P 1006 -p1 -b .negotiate-supported-algs"
      replacement: "# %patch -P 1006 disabled"
    - pattern: "%patch -P 1012 -p1 -b .evp-fips-dh"
      replacement: "# %patch -P 1012 disabled (FIPS)"
    - pattern: "%patch -P 1013 -p1 -b .evp-fips-ecdh"
      replacement: "# %patch -P 1013 disabled (FIPS)"
    - pattern: "%patch -P 1014 -p1 -b .nosha1hostproof"
      replacement: "# %patch -P 1014 disabled (FIPS)"
    - pattern: "%patch -P 100 -p1 -b .coverity"
      replacement: "# %patch -P 100 disabled"

    # ── %build section fixes ──
    # Remove Fedora build flags macro
    - pattern: "%set_build_flags"
      replacement: "# %set_build_flags  # not available for cross-build"
    # Remove PIE/hardening LDFLAGS (disabled via %global pie 0 but
    # the assignment is inside %if %{pie} which is now false — harmless)
    # Remove -fvisibility=hidden (can cause linking issues in cross-build)
    - pattern: 'CFLAGS="$CFLAGS -fvisibility=hidden"; export CFLAGS'
      replacement: '# -fvisibility=hidden disabled for IRIX cross-build'
    # Remove sk-dummy.so build (FIDO2 disabled)
    - pattern: "make regress/misc/sk-dummy/sk-dummy.so"
      replacement: "# sk-dummy.so build disabled (no FIDO2)"
    # Force BROKEN_SNPRINTF — IRIX snprintf doesn't support %zu and
    # vsnprintf(NULL,0) returns -1. Cross-compile assumes working.
    # Inject -DBROKEN_SNPRINTF so openssh uses bsd-snprintf.c replacement.
    - pattern: "%configure \\"
      replacement: "CFLAGS=\"$CFLAGS -DBROKEN_SNPRINTF -Dgetdelim=getdelim -Dgetline=getline -Dasprintf=asprintf -Dvasprintf=vasprintf -DOPENSSL_HAS_ECC -DOPENSSL_HAS_NISTP256 -DOPENSSL_HAS_NISTP384 -DOPENSSL_HAS_NISTP521 -DHAVE_EC_KEY_METHOD_NEW\"\nexport CFLAGS\n%configure \\"

    # ── Configure flag fixes ──
    # Fix default PATH for SGUG
    - pattern: "--with-default-path=/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin"
      replacement: "--with-default-path=/usr/sgug/bin:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin"
    - pattern: "--with-superuser-path=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin"
      replacement: "--with-superuser-path=/usr/sgug/sbin:/usr/sgug/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin"

    # ── %install section fixes ──
    # Comment out PAM file installs
    - pattern: "install -d $RPM_BUILD_ROOT/etc/pam.d/"
      replacement: "# PAM disabled for IRIX"
    - pattern: "install -m644 %{SOURCE2} $RPM_BUILD_ROOT/etc/pam.d/sshd"
      replacement: "# PAM disabled"
    - pattern: "install -m644 %{SOURCE6} $RPM_BUILD_ROOT/etc/pam.d/ssh-keycat"
      replacement: "# PAM disabled"
    # Comment out sysconfig
    - pattern: "install -d $RPM_BUILD_ROOT/etc/sysconfig/"
      replacement: "# sysconfig disabled for IRIX"
    - pattern: "install -m644 %{SOURCE7} $RPM_BUILD_ROOT/etc/sysconfig/sshd"
      replacement: "# sysconfig disabled"
    # Comment out Fedora/RHEL config drop-ins (reference crypto-policies)
    - pattern: "install -m644 ssh_config_redhat $RPM_BUILD_ROOT%{_sysconfdir}/ssh/ssh_config.d/50-redhat.conf"
      replacement: "# Fedora crypto-policies config disabled for IRIX"
    - pattern: "install -m644 sshd_config_redhat_cp $RPM_BUILD_ROOT%{_sysconfdir}/ssh/sshd_config.d/40-redhat-crypto-policies.conf"
      replacement: "# crypto-policies config disabled for IRIX"
    - pattern: "install -m644 sshd_config_redhat $RPM_BUILD_ROOT%{_sysconfdir}/ssh/sshd_config.d/50-redhat.conf"
      replacement: "# Fedora sshd config disabled for IRIX"
    # Comment out systemd unit installs
    - pattern: "install -d -m755 $RPM_BUILD_ROOT/%{_unitdir}"
      replacement: "# systemd disabled for IRIX"
    - pattern: "install -m644 %{SOURCE9} $RPM_BUILD_ROOT/%{_unitdir}/sshd@.service"
      replacement: "# systemd disabled"
    - pattern: "install -m644 %{SOURCE10} $RPM_BUILD_ROOT/%{_unitdir}/sshd.socket"
      replacement: "# systemd disabled"
    - pattern: "install -m644 %{SOURCE11} $RPM_BUILD_ROOT/%{_unitdir}/sshd.service"
      replacement: "# systemd disabled"
    - pattern: "install -m644 %{SOURCE12} $RPM_BUILD_ROOT/%{_unitdir}/sshd-keygen@.service"
      replacement: "# systemd disabled"
    - pattern: "install -m644 %{SOURCE15} $RPM_BUILD_ROOT/%{_unitdir}/sshd-keygen.target"
      replacement: "# systemd disabled"
    - pattern: "install -d -m755 $RPM_BUILD_ROOT/%{_userunitdir}"
      replacement: "# systemd user units disabled"
    - pattern: "install -m644 %{SOURCE16} $RPM_BUILD_ROOT/%{_userunitdir}/ssh-agent.service"
      replacement: "# systemd disabled"
    - pattern: "install -m644 %{SOURCE17} $RPM_BUILD_ROOT/%{_userunitdir}/ssh-agent.socket"
      replacement: "# systemd disabled"
    # Comment out sysusers
    - pattern: "install -p -D -m 0644 %{SOURCE19} %{buildroot}%{_sysusersdir}/openssh-server.conf"
      replacement: "# sysusers disabled for IRIX"
    # Comment out ssh-host-keys-migration (systemd-based)
    - pattern: "install -m744 %{SOURCE20} $RPM_BUILD_ROOT/%{_libexecdir}/openssh/ssh-host-keys-migration.sh"
      replacement: "# host-keys-migration disabled (systemd)"
    - pattern: "install -m644 %{SOURCE21} $RPM_BUILD_ROOT/%{_unitdir}/ssh-host-keys-migration.service"
      replacement: "# host-keys-migration disabled (systemd)"
    # Comment out localstatedir ghost
    - pattern: "install -d $RPM_BUILD_ROOT/%{_localstatedir}/lib"
      replacement: "# localstatedir disabled for IRIX"
    - pattern: "touch $RPM_BUILD_ROOT/%{_localstatedir}/lib/.ssh-host-keys-migration"
      replacement: "# host-keys-migration ghost disabled"
    # Comment out sk-dummy install
    - pattern: "install -m 755 -d $RPM_BUILD_ROOT%{_libdir}/sshtest/"
      replacement: "# sk-dummy disabled (no FIDO2)"
    - pattern: "install -m 755 regress/misc/sk-dummy/sk-dummy.so $RPM_BUILD_ROOT%{_libdir}/sshtest"
      replacement: "# sk-dummy disabled"
    # Fix Perl path fixup (perl may not be on PATH in cross-build)
    - pattern: 'perl -pi -e "s|$RPM_BUILD_ROOT||g" $RPM_BUILD_ROOT%{_mandir}/man*/*'
      replacement: 'find $RPM_BUILD_ROOT%{_mandir} -type f -exec sed -i "s|$RPM_BUILD_ROOT||g" {} +'

    # ── %files server fixes ──
    # Comment out systemd units
    - pattern: "%attr(0644,root,root) %{_unitdir}/sshd.service"
      replacement: "# systemd units removed for IRIX"
    - pattern: "%attr(0644,root,root) %{_unitdir}/sshd@.service"
      replacement: "# systemd disabled"
    - pattern: "%attr(0644,root,root) %{_unitdir}/sshd.socket"
      replacement: "# systemd disabled"
    - pattern: "%attr(0644,root,root) %{_unitdir}/sshd-keygen@.service"
      replacement: "# systemd disabled"
    - pattern: "%attr(0644,root,root) %{_unitdir}/sshd-keygen.target"
      replacement: "# systemd disabled"
    - pattern: "%attr(0644,root,root) %{_sysusersdir}/openssh-server.conf"
      replacement: "# sysusers disabled"
    - pattern: "%attr(0644,root,root) %{_unitdir}/ssh-host-keys-migration.service"
      replacement: "# migration service disabled"
    - pattern: "%attr(0744,root,root) %{_libexecdir}/openssh/ssh-host-keys-migration.sh"
      replacement: "# migration script disabled"
    - pattern: "%ghost %attr(0644,root,root) %{_localstatedir}/lib/.ssh-host-keys-migration"
      replacement: "# migration ghost disabled"
    # Comment out PAM file
    - pattern: "%attr(0644,root,root) %config(noreplace) /etc/pam.d/sshd"
      replacement: "# PAM disabled for IRIX"
    # Comment out sysconfig
    - pattern: "%attr(0640,root,root) %config(noreplace) /etc/sysconfig/sshd"
      replacement: "# sysconfig disabled for IRIX"
    # Comment out Fedora crypto-policies config drop-ins
    - pattern: "%attr(0600,root,root) %config(noreplace) %{_sysconfdir}/ssh/sshd_config.d/40-redhat-crypto-policies.conf"
      replacement: "# crypto-policies disabled for IRIX"
    - pattern: "%attr(0600,root,root) %config(noreplace) %{_sysconfdir}/ssh/sshd_config.d/50-redhat.conf"
      replacement: "# Fedora sshd config disabled for IRIX"

    # ── %files clients fixes ──
    # Comment out systemd user units
    - pattern: "%attr(0644,root,root) %{_userunitdir}/ssh-agent.service"
      replacement: "# systemd user service disabled"
    - pattern: "%attr(0644,root,root) %{_userunitdir}/ssh-agent.socket"
      replacement: "# systemd user socket disabled"
    # Comment out Fedora ssh_config drop-in
    - pattern: "%attr(0644,root,root) %config(noreplace) %{_sysconfdir}/ssh/ssh_config.d/50-redhat.conf"
      replacement: "# Fedora ssh config disabled for IRIX"
    # Comment out ssh-pkcs11-helper (PKCS#11 disabled)
    - pattern: "%attr(0755,root,root) %{_libexecdir}/openssh/ssh-pkcs11-helper"
      replacement: "# PKCS#11 helper disabled"
    - pattern: "%attr(0644,root,root) %{_mandir}/man8/ssh-pkcs11-helper.8*"
      replacement: "# PKCS#11 man page disabled"
    # Comment out ssh-sk-helper (FIDO2 security key disabled)
    - pattern: "%attr(0755,root,root) %{_libexecdir}/openssh/ssh-sk-helper"
      replacement: "# FIDO2 sk-helper disabled"
    - pattern: "%attr(0644,root,root) %{_mandir}/man8/ssh-sk-helper.8*"
      replacement: "# FIDO2 man page disabled"

    # ── Man page .gz suffix fix ──
    # rpmmacros.irix disables brp scripts, man pages not compressed
    - pattern: "%{_mandir}/man1/ssh-keygen.1*"
      replacement: "%{_mandir}/man1/ssh-keygen.1"
    - pattern: "%{_mandir}/man8/ssh-keysign.8*"
      replacement: "%{_mandir}/man8/ssh-keysign.8"
    - pattern: "%{_mandir}/man1/ssh.1*"
      replacement: "%{_mandir}/man1/ssh.1"
    - pattern: "%{_mandir}/man1/scp.1*"
      replacement: "%{_mandir}/man1/scp.1"
    - pattern: "%{_mandir}/man5/ssh_config.5*"
      replacement: "%{_mandir}/man5/ssh_config.5"
    - pattern: "%{_mandir}/man1/ssh-agent.1*"
      replacement: "%{_mandir}/man1/ssh-agent.1"
    - pattern: "%{_mandir}/man1/ssh-add.1*"
      replacement: "%{_mandir}/man1/ssh-add.1"
    - pattern: "%{_mandir}/man1/ssh-keyscan.1*"
      replacement: "%{_mandir}/man1/ssh-keyscan.1"
    - pattern: "%{_mandir}/man1/sftp.1*"
      replacement: "%{_mandir}/man1/sftp.1"
    - pattern: "%{_mandir}/man1/ssh-copy-id.1*"
      replacement: "%{_mandir}/man1/ssh-copy-id.1"
    - pattern: "%{_mandir}/man5/sshd_config.5*"
      replacement: "%{_mandir}/man5/sshd_config.5"
    - pattern: "%{_mandir}/man5/moduli.5*"
      replacement: "%{_mandir}/man5/moduli.5"
    - pattern: "%{_mandir}/man8/sshd.8*"
      replacement: "%{_mandir}/man8/sshd.8"
    - pattern: "%{_mandir}/man8/sftp-server.8*"
      replacement: "%{_mandir}/man8/sftp-server.8"

    # ── %pre server fix ──
    # Remove sysusers_create_compat from %pre server
    # The entire %pre server section just has the sysusers line
    # After remove_lines strips it, the section is empty (harmless)

    # ── %post server fix ──
    # Comment the migration script block in %post server
    - pattern: "if [ $1 -gt 1 ]; then"
      replacement: "# migration disabled for IRIX\nif false; then"

  # === Install cleanup ===
  install_cleanup:
    - "rm -rf %{buildroot}/etc/pam.d"
    - "rm -rf %{buildroot}/etc/sysconfig"
    - "rm -rf %{buildroot}%{_libdir}/sshtest"
    # Remove PKCS#11 and FIDO2 helpers (commented out of %files)
    - "rm -f %{buildroot}%{_libexecdir}/openssh/ssh-pkcs11-helper"
    - "rm -f %{buildroot}%{_libexecdir}/openssh/ssh-sk-helper"
    - "rm -f %{buildroot}%{_mandir}/man8/ssh-pkcs11-helper.8"
    - "rm -f %{buildroot}%{_mandir}/man8/ssh-sk-helper.8"

  # === Prep commands ===
  prep_commands:
    # Fix vsnprintf/snprintf type conflict: IRIX declares vsnprintf(..., char *)
    # because IRIX va_list = char*, but our clang stdarg.h makes va_list = __builtin_va_list.
    # When BROKEN_SNPRINTF is defined, openssh compiles its own vsnprintf replacement
    # which conflicts with the IRIX declaration. Fix: rename the IRIX declarations
    # during header inclusion so they don't conflict with openssh's definitions.
    - "sed -i '/#include \"includes.h\"/{ i\\#define vsnprintf _irix_vsnprintf_decl\\n#define snprintf _irix_snprintf_decl\na\\#undef vsnprintf\\n#undef snprintf\n}' openbsd-compat/bsd-snprintf.c"
    # Fix volatile function pointer static initializer crash on IRIX:
    # static void (* volatile ssh_bzero)(void *, size_t) = bzero;
    # IRIX rld cannot resolve the bzero relocation in the static initializer.
    # Same pattern as gnupg2's wipememory() crash. Replace with volatile char
    # pointer loop that avoids function pointer relocation entirely.
    - |
      cat > openbsd-compat/explicit_bzero.c << 'IRIXFIX'
      /* IRIX replacement: avoid volatile function pointer static initializer */
      /* Original used: static void (* volatile ssh_bzero)(void *, size_t) = bzero; */
      /* which crashes on IRIX rld (relocation for bzero in static init fails). */
      #include "includes.h"
      #include <string.h>
      #ifndef HAVE_EXPLICIT_BZERO
      void
      explicit_bzero(void *p, size_t n)
      {
          volatile unsigned char *vp = (volatile unsigned char *)p;
          size_t i;
          if (n == 0)
              return;
          for (i = 0; i < n; i++)
              vp[i] = 0;
      }
      #endif /* HAVE_EXPLICIT_BZERO */
      IRIXFIX
    # Fix function pointer relocations in digest-openssl.c static array:
    # IRIX rld fails to apply some relocations for function pointers in
    # static const arrays. EVP_sha1 and EVP_sha512 resolve to NULL in
    # the digests[] table despite being valid symbols. Direct function calls
    # work fine (they go through GOT). Fix: add a helper that uses a switch
    # to call EVP functions directly, replacing digest->mdfunc() calls.
    - |
      cat > digest-openssl.c << 'DIGEST_IRIX_FIX'
      /* $OpenBSD: digest-openssl.c,v 1.9 2020/10/29 02:52:43 djm Exp $ */
      /* IRIX-patched: replaced function pointer array with switch dispatch */
      /* to avoid rld relocation failures in static data arrays. */
      #include "includes.h"
      #ifdef WITH_OPENSSL
      #include <sys/types.h>
      #include <limits.h>
      #include <stdlib.h>
      #include <string.h>
      #include <openssl/evp.h>
      #include "openbsd-compat/openssl-compat.h"
      #include "sshbuf.h"
      #include "digest.h"
      #include "ssherr.h"
      struct ssh_digest_ctx {
          int alg;
          EVP_MD_CTX *mdctx;
      };
      struct ssh_digest {
          int id;
          const char *name;
          size_t digest_len;
      };
      /* NB. Indexed directly by algorithm number */
      const struct ssh_digest digests[] = {
          { SSH_DIGEST_MD5,    "MD5",    16 },
          { SSH_DIGEST_SHA1,   "SHA1",   20 },
          { SSH_DIGEST_SHA256, "SHA256", 32 },
          { SSH_DIGEST_SHA384, "SHA384", 48 },
          { SSH_DIGEST_SHA512, "SHA512", 64 },
          { -1,                NULL,      0 },
      };
      /* IRIX rld fix: call EVP functions directly instead of through
       * function pointers in a static array (rld fails to relocate some). */
      static const EVP_MD *
      ssh_digest_md(int alg)
      {
          switch (alg) {
          case SSH_DIGEST_MD5:    return EVP_md5();
          case SSH_DIGEST_SHA1:   return EVP_sha1();
      #ifdef HAVE_EVP_SHA256
          case SSH_DIGEST_SHA256: return EVP_sha256();
      #endif
      #ifdef HAVE_EVP_SHA384
          case SSH_DIGEST_SHA384: return EVP_sha384();
      #endif
      #ifdef HAVE_EVP_SHA512
          case SSH_DIGEST_SHA512: return EVP_sha512();
      #endif
          default: return NULL;
          }
      }
      static const struct ssh_digest *
      ssh_digest_by_alg(int alg)
      {
          if (alg < 0 || alg >= SSH_DIGEST_MAX)
              return NULL;
          if (digests[alg].id != alg)
              return NULL;
          if (ssh_digest_md(alg) == NULL)
              return NULL;
          return &(digests[alg]);
      }
      int
      ssh_digest_alg_by_name(const char *name)
      {
          int alg;
          for (alg = 0; digests[alg].id != -1; alg++) {
              if (strcasecmp(name, digests[alg].name) == 0)
                  return digests[alg].id;
          }
          return -1;
      }
      const char *
      ssh_digest_alg_name(int alg)
      {
          const struct ssh_digest *digest = ssh_digest_by_alg(alg);
          return digest == NULL ? NULL : digest->name;
      }
      size_t
      ssh_digest_bytes(int alg)
      {
          const struct ssh_digest *digest = ssh_digest_by_alg(alg);
          return digest == NULL ? 0 : digest->digest_len;
      }
      size_t
      ssh_digest_blocksize(struct ssh_digest_ctx *ctx)
      {
          return EVP_MD_CTX_block_size(ctx->mdctx);
      }
      struct ssh_digest_ctx *
      ssh_digest_start(int alg)
      {
          const struct ssh_digest *digest = ssh_digest_by_alg(alg);
          const EVP_MD *md;
          struct ssh_digest_ctx *ret;
          if (digest == NULL || ((ret = calloc(1, sizeof(*ret))) == NULL))
              return NULL;
          ret->alg = alg;
          if ((ret->mdctx = EVP_MD_CTX_new()) == NULL) {
              free(ret);
              return NULL;
          }
          md = ssh_digest_md(alg);
          if (md == NULL || EVP_DigestInit_ex(ret->mdctx, md, NULL) != 1) {
              ssh_digest_free(ret);
              return NULL;
          }
          return ret;
      }
      int
      ssh_digest_copy_state(struct ssh_digest_ctx *from, struct ssh_digest_ctx *to)
      {
          if (from->alg != to->alg)
              return SSH_ERR_INVALID_ARGUMENT;
          if (!EVP_MD_CTX_copy_ex(to->mdctx, from->mdctx))
              return SSH_ERR_LIBCRYPTO_ERROR;
          return 0;
      }
      int
      ssh_digest_update(struct ssh_digest_ctx *ctx, const void *m, size_t mlen)
      {
          if (EVP_DigestUpdate(ctx->mdctx, m, mlen) != 1)
              return SSH_ERR_LIBCRYPTO_ERROR;
          return 0;
      }
      int
      ssh_digest_update_buffer(struct ssh_digest_ctx *ctx, const struct sshbuf *b)
      {
          return ssh_digest_update(ctx, sshbuf_ptr(b), sshbuf_len(b));
      }
      int
      ssh_digest_final(struct ssh_digest_ctx *ctx, u_char *d, size_t dlen)
      {
          const struct ssh_digest *digest = ssh_digest_by_alg(ctx->alg);
          u_int l = dlen;
          if (digest == NULL || dlen > UINT_MAX)
              return SSH_ERR_INVALID_ARGUMENT;
          if (dlen < digest->digest_len)
              return SSH_ERR_INVALID_ARGUMENT;
          if (EVP_DigestFinal_ex(ctx->mdctx, d, &l) != 1)
              return SSH_ERR_LIBCRYPTO_ERROR;
          if (l != digest->digest_len)
              return SSH_ERR_INTERNAL_ERROR;
          return 0;
      }
      void
      ssh_digest_free(struct ssh_digest_ctx *ctx)
      {
          if (ctx == NULL)
              return;
          EVP_MD_CTX_free(ctx->mdctx);
          freezero(ctx, sizeof(*ctx));
      }
      int
      ssh_digest_memory(int alg, const void *m, size_t mlen, u_char *d, size_t dlen)
      {
          const struct ssh_digest *digest = ssh_digest_by_alg(alg);
          const EVP_MD *md;
          u_int mdlen;
          if (digest == NULL)
              return SSH_ERR_INVALID_ARGUMENT;
          if (dlen > UINT_MAX)
              return SSH_ERR_INVALID_ARGUMENT;
          if (dlen < digest->digest_len)
              return SSH_ERR_INVALID_ARGUMENT;
          mdlen = dlen;
          md = ssh_digest_md(alg);
          if (md == NULL)
              return SSH_ERR_INVALID_ARGUMENT;
          if (!EVP_Digest(m, mlen, d, &mdlen, md, NULL))
              return SSH_ERR_LIBCRYPTO_ERROR;
          return 0;
      }
      int
      ssh_digest_buffer(int alg, const struct sshbuf *b, u_char *d, size_t dlen)
      {
          return ssh_digest_memory(alg, sshbuf_ptr(b), sshbuf_len(b), d, dlen);
      }
      #endif /* WITH_OPENSSL */
      DIGEST_IRIX_FIX
    # Fix IRIX rld R_MIPS_REL32 relocation failures in cipher.c:
    # Function pointers in the static ciphers[] array require dynamic
    # relocations that IRIX rld intermittently fails to process.
    # The failure is non-deterministic and depends on binary layout.
    # Fix: add ssh_cipher_evptype() dispatch function and replace the
    # (*cipher->evptype)() call site in cipher_init().
    - |
      perl -e '
        local $/;
        open(F, "<cipher.c") or die "cannot read cipher.c: $!";
        my $c = <F>;
        close F;
        my $dispatch = qq{
      /* IRIX rld fix: dispatch EVP cipher type by name instead of through
       * function pointers in a static array (rld fails some R_MIPS_REL32). */
      static const EVP_CIPHER *
      ssh_cipher_evptype(const char *name)
      {
      \tif (strcmp(name, "3des-cbc") == 0) return EVP_des_ede3_cbc();
      \tif (strcmp(name, "aes128-cbc") == 0) return EVP_aes_128_cbc();
      \tif (strcmp(name, "aes192-cbc") == 0) return EVP_aes_192_cbc();
      \tif (strcmp(name, "aes256-cbc") == 0) return EVP_aes_256_cbc();
      \tif (strcmp(name, "aes128-ctr") == 0) return EVP_aes_128_ctr();
      \tif (strcmp(name, "aes192-ctr") == 0) return EVP_aes_192_ctr();
      \tif (strcmp(name, "aes256-ctr") == 0) return EVP_aes_256_ctr();
      \tif (strcmp(name, "aes128-gcm\@openssh.com") == 0) return EVP_aes_128_gcm();
      \tif (strcmp(name, "aes256-gcm\@openssh.com") == 0) return EVP_aes_256_gcm();
      \treturn NULL;
      }
      };
        $c =~ s/(int\ncipher_init\(struct sshcipher_ctx)/$dispatch\n$1/;
        $c =~ s/type = \(\*cipher->evptype\)\(\);/type = ssh_cipher_evptype(cipher->name);/;
        # Replace EVP function pointers in ciphers[] static array with NULL
        # to eliminate R_MIPS_REL32 data relocations (dispatch function handles it now)
        $c =~ s/(CFLAG_CBC,\s+)EVP_\w+/${1}NULL/g;
        $c =~ s/(0,\s+)EVP_aes_\w+/${1}NULL/g;
        open(F, ">cipher.c") or die "cannot write cipher.c: $!";
        print F $c;
        close F;
      '
    # Fix IRIX rld R_MIPS_REL32 relocation failures in charclass.h:
    # The cclasses[] static array uses function pointers to libc ctype
    # functions (isalnum, isalpha, etc.) which require dynamic relocations.
    # Replace with a dispatch function that calls them directly.
    - |
      cat > openbsd-compat/charclass.h << 'CHARCLASS_IRIX_FIX'
      /* IRIX-patched: replaced function pointer array with dispatch function.
       * IRIX rld intermittently fails R_MIPS_REL32 relocations for function
       * pointers in static data arrays. */
      #include <ctype.h>
      static struct cclass {
      	const char *name;
      } cclasses[] = {
      	{ "alnum" },
      	{ "alpha" },
      	{ "blank" },
      	{ "cntrl" },
      	{ "digit" },
      	{ "graph" },
      	{ "lower" },
      	{ "print" },
      	{ "punct" },
      	{ "space" },
      	{ "upper" },
      	{ "xdigit" },
      	{ NULL }
      };
      static int
      cclass_isctype(const char *name, int c)
      {
      	if (strcmp(name, "alnum") == 0) return isalnum(c);
      	if (strcmp(name, "alpha") == 0) return isalpha(c);
      	if (strcmp(name, "blank") == 0) return isblank(c);
      	if (strcmp(name, "cntrl") == 0) return iscntrl(c);
      	if (strcmp(name, "digit") == 0) return isdigit(c);
      	if (strcmp(name, "graph") == 0) return isgraph(c);
      	if (strcmp(name, "lower") == 0) return islower(c);
      	if (strcmp(name, "print") == 0) return isprint(c);
      	if (strcmp(name, "punct") == 0) return ispunct(c);
      	if (strcmp(name, "space") == 0) return isspace(c);
      	if (strcmp(name, "upper") == 0) return isupper(c);
      	if (strcmp(name, "xdigit") == 0) return isxdigit(c);
      	return 0;
      }
      #define NCCLASSES (sizeof(cclasses)/sizeof(cclasses[0])-1)
      CHARCLASS_IRIX_FIX
    # Update charclass.h users to use cclass_isctype() instead of .isctype()
    # glob.c uses cclasses[idx].isctype(k) — access by array index
    - "sed -i 's/cclasses\\[idx\\]\\.isctype(k)/cclass_isctype(cclasses[idx].name, k)/g' openbsd-compat/glob.c"
    # fnmatch.c uses cc->isctype((unsigned char)test) — access by iterator
    - "sed -i 's/cc->isctype((unsigned char)test)/cclass_isctype(cc->name, (unsigned char)test)/g' openbsd-compat/fnmatch.c"

    # IRIX: bypass ensure_minimum_time_since() which crashes the privsep child.
    # The "none" auth method skips this call and works fine; pubkey/password
    # methods call it and the child dies. Likely related to monotime_double(),
    # nanosleep(), or floating-point conversion on IRIX.
    - "sed -i 's/ensure_minimum_time_since(tstart,/\\/\\* IRIX: disabled \\*\\/ if(0) ensure_minimum_time_since(tstart,/' auth2.c"
    # IRIX KNOWN ISSUE: fork-mode sshd fails (connection socket returns EOF
    # after privsep child exits — likely IRIX kernel socket refcount bug).
    # Workaround: run sshd with -d (single-connection debug mode) in a loop:
    #   while true; do /usr/sgug/sbin/sshd -d -e -p 22; done
    # Or use -ddd for verbose debugging. Works perfectly for single connections.

  # === sshd_config customization for IRIX ===
  # Applied via install_cleanup sed commands after make install
  # SyslogFacility AUTH (IRIX doesn't support AUTHPRIV)
  # Note: upstream default is already AUTH, Fedora patch changes to AUTHPRIV
  # Since we drop all patches, we get upstream defaults — no fix needed
