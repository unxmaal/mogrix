#!/bin/sh
#
# IRIX linker wrapper with automatic linker selection
#
# ============================================================================
# WARNING: DO NOT CHANGE LINKER SELECTION WITHOUT TESTING ON IRIX!
#
# KNOWN BAD FIX: Using GNU ld for executables causes SIGSEGV during rld init.
# This has been tried multiple times and always fails. If you're seeing
# relocation issues, the fix is to use LLD 18 with patches, NOT GNU ld.
#
# See: rules/methods/linker-selection.md
# ============================================================================
#
# Selects the appropriate linker based on the build type:
# - Shared libraries (-shared flag): Uses LLD 18 with IRIX-specific flags
#   --no-rosegment: Merge R and RE into single RE segment (2-segment layout)
#   -z norelro: IRIX rld doesn't support GNU_RELRO
#   --image-base=0x5ffe0000: Non-zero DT_MIPS_BASE_ADDRESS (required by IRIX rld)
#   -Bsymbolic: Keep global GOT under rld's ~4370 entry limit
#   Previously used GNU ld (BFD), but BFD has a multi-GOT bug with
#   -Bsymbolic-functions that corrupts ~30% of function-call GOT entries
#   in large libraries (WebKit). LLD's independent multi-GOT implementation
#   avoids this bug. Set MOGRIX_USE_BFDLD_SHARED=1 to use BFD ld instead.
# - Executables: Uses LLD 18 with IRIX patches (ld.lld-irix-18)
#   LLD 18 fixes the relocation bug in LLD 14 for external data symbols
#   --image-base=0x1000000 moves binary above rld quickstart table at 0x200000
#   giving 176MB of brk heap instead of 1.8MB (see irix-address-space.md)
#
# Deployed by: mogrix setup-cross
#

# Configurable paths - set by mogrix setup-cross or environment
SYSROOT="${IRIX_SYSROOT:-/opt/irix-sysroot}"
STAGING="${SGUG_STAGING:-/opt/sgug-staging/usr/sgug}"
# LLD 18 with IRIX patches - fixes relocation bug for external data symbols
LLD="${IRIX_LLD:-/home/edodd/projects/github/unxmaal/mogrix/tools/bin/ld.lld-irix-18}"
GNULD="${IRIX_GNULD:-/opt/cross/bin/mips-sgi-irix6.5-ld.bfd}"

# Filter out GCC-specific flags that don't apply to clang/lld
# and check for -shared in a single pass
# Also convert some flag formats for GNU ld compatibility
is_shared=0
filtered_args=""
skip_next=0
for arg in "$@"; do
    if [ "$skip_next" = "1" ]; then
        skip_next=0
        continue
    fi
    case "$arg" in
        -shared)
            is_shared=1
            filtered_args="$filtered_args $arg"
            ;;
        -static-libgcc)
            # Skip GCC-specific flag - not meaningful for clang/lld
            ;;
        -rdynamic)
            # Skip -rdynamic (GCC driver flag, LLD doesn't support it).
            # Use --export-dynamic directly for LLD if needed.
            ;;
        --export-dynamic)
            # Allow if MOGRIX_ALLOW_EXPORT_DYNAMIC=1 (for plugin hosts like bitlbee).
            # IRIX rld may crash on very large dynamic symbol tables (468+ entries)
            # due to brk heap limits (libpthread at 0x0C080000). Check with:
            #   readelf --dyn-syms <binary> | wc -l
            # Use dlmalloc (inject_compat_functions: strdup) to bypass brk limits.
            if [ "$MOGRIX_ALLOW_EXPORT_DYNAMIC" = "1" ]; then
                filtered_args="$filtered_args --export-dynamic"
            fi
            ;;
        --no-undefined|-z,no-undefined|--no-undefined-version)
            # Skip --no-undefined for cross builds: IRIX libc has TLS
            # references (__tls_get_addr) that can't be resolved at link time.
            # Shared libraries resolve symbols at load time via rld.
            ;;
        -melf32bsmip|-melf32bmip|-melf64bmip|-melf*)
            # Skip GNU ld emulation flags — LLD uses target triple instead.
            # libtool/autoconf probes the linker with -melf32bsmip.
            ;;
        --print-search-dirs|-print-search-dirs)
            # Skip linker search path query — not supported by LLD.
            # autoconf probes this to find library directories.
            ;;
        --version-script=*|--version-script)
            # Skip user-provided GNU symbol versioning — IRIX rld doesn't support
            # .gnu.version* sections. Version scripts create VERNEED/VERSYM dynamic
            # tags that crash rld during dlopen. We add our own CRT version script
            # internally (see crt-hide.ver) and strip-verneed cleans up the sections.
            case "$arg" in
                --version-script) skip_next=1 ;;
            esac
            ;;
        -soname,*)
            # Convert -soname,name to -soname name (GNU ld format)
            soname_val="${arg#-soname,}"
            filtered_args="$filtered_args -soname $soname_val"
            ;;
        *)
            filtered_args="$filtered_args $arg"
            ;;
    esac
done

    # strip-verneed: post-link tool to remove GNU version sections from shared libs.
    # IRIX rld crashes on VERNEED/VERSYM dynamic tags (GNU symbol versioning).
    # These are generated by GNU ld when linking against versioned libs (libstdc++).
    STRIP_VERNEED="${STRIP_VERNEED:-$(dirname "$0")/strip-verneed}"

if [ "$is_shared" = "1" ]; then
    CRTBEGIN=$STAGING/lib32/crtbeginS.o
    CRTEND=$STAGING/lib32/crtendS.o
    DSOHANDLE=$STAGING/lib32/dso_handle.o

    # Find the output file name from -o flag (needed for post-link strip-verneed)
    output_file=""
    next_is_output=0
    for a in $filtered_args; do
        if [ "$next_is_output" = "1" ]; then
            output_file="$a"
            next_is_output=0
        fi
        case "$a" in -o) next_is_output=1 ;; esac
    done

    if [ "$MOGRIX_USE_BFDLD_SHARED" = "1" ]; then
        # Fallback: GNU ld (BFD) with custom linker script.
        # WARNING: BFD ld has a multi-GOT bug with -Bsymbolic-functions that
        # corrupts ~30% of function-call GOT entries in large libraries.
        # Only use this for small libraries or debugging.
        LDSCRIPT=$STAGING/lib32/irix-shared.lds
        CRT_HIDE="$(dirname "$0")/../crt/crt-hide.ver"
        $GNULD \
          -Bsymbolic-functions \
          --version-script="$CRT_HIDE" \
          -T "$LDSCRIPT" \
          $CRTBEGIN \
          $DSOHANDLE \
          $filtered_args \
          -L$STAGING/lib32 \
          -L$SYSROOT/lib32 \
          -L$SYSROOT/usr/lib32 \
          $CRTEND
        rc=$?
    else
        # Default: LLD 18 for shared libraries.
        # LLD's independent multi-GOT implementation avoids BFD's corruption bug.
        # Flags:
        #   --no-rosegment: Merge R+RE into single RE segment (IRIX rld needs 2-segment)
        #   -z norelro: IRIX rld doesn't support GNU_RELRO
        #   --image-base=0x5ffe0000: IRIX rld requires non-zero DT_MIPS_BASE_ADDRESS
        #   -Bsymbolic: Keep global GOT under rld's ~4370 entry limit.
        #     Binds ALL defined symbols (functions AND data objects) locally within
        #     the shared library. -Bsymbolic-functions only binds functions, leaving
        #     OBJECT symbols in the global GOT. libwebkit2gtk had 1146 defined OBJECT
        #     symbols in global GOT, pushing it from 3515 to 4661 (291 over limit).
        #     -Bsymbolic is safe on IRIX: rld doesn't do copy relocations, so the
        #     address identity concern (exe &var != so &var) doesn't apply.
        #   --allow-shlib-undefined: IRIX libc TLS refs can't resolve at link time
        #   --mips-got-size=1048576: Force all GOT entries into the primary GOT.
        #     IRIX rld only processes primary GOT entries (described by DT_MIPS_LOCAL_GOTNO/
        #     GOTSYM/SYMTABNO). Secondary GOTs use GNU R_MIPS_REL32 relocations that IRIX
        #     rld ignores, leaving entries at 0 → SIGSEGV. Default 0xfff0 (16K entries)
        #     splits at ~4000 entries; 1048576 allows up to 262K entries (enough for WebKit).
        # crtbeginS.o provides .init → .ctors walker; crtendS.o provides sentinels.
        # LLD properly handles .hidden visibility on CRT symbols (no version script
        # needed, unlike BFD which loses .hidden and needs crt-hide.ver workaround).
        $LLD \
          -Bsymbolic \
          --no-rosegment \
          -z norelro \
          --image-base=0x5ffe0000 \
          --allow-shlib-undefined \
          --mips-got-size=1048576 \
          $CRTBEGIN \
          $DSOHANDLE \
          $filtered_args \
          -L$STAGING/lib32 \
          -L$SYSROOT/lib32 \
          -L$SYSROOT/usr/lib32 \
          $CRTEND
        rc=$?
    fi

    # Strip GNU version sections (VERNEED/VERSYM) — IRIX rld crashes on these.
    # Generated when linking against versioned libs (libstdc++, glibc).
    # Only strip if linking succeeded and output file exists.
    if [ "$rc" = "0" ] && [ -n "$output_file" ] && [ -f "$output_file" ]; then
        python3 "$STRIP_VERNEED" "$output_file" >/dev/null 2>&1 || true
    fi

    # Fix anonymous R_MIPS_REL32 relocations for IRIX rld compatibility.
    # LLD emits these with sym_idx=0 (anonymous), but IRIX rld's fix_all_defineds()
    # skips index 0. Also fixes named R_MIPS_REL32 addend formula mismatch
    # (IRIX rld gives addend+displacement instead of st_value+addend+displacement).
    # Safe for all libraries — exits early if no anonymous R_MIPS_REL32 found.
    FIX_ANON_RELOCS="${FIX_ANON_RELOCS:-$(dirname "$0")/fix-anon-relocs}"
    if [ "$rc" = "0" ] && [ -n "$output_file" ] && [ -f "$output_file" ]; then
        python3 "$FIX_ANON_RELOCS" "$output_file" "$output_file" >/dev/null 2>&1 || true
    fi

    exit $rc
else
    # Executable: use LLD with CRT files and soft float stubs
    # Use fixed CRT files (with .MIPS.events sections stripped)
    CRT1=$SYSROOT/usr/lib32/mips3/fixed/crt1.o
    CRTN=$SYSROOT/usr/lib32/mips3/fixed/crtn.o
    # C++ constructor/destructor support — processes .ctors/.dtors arrays
    # IRIX crt1/crtn don't process .ctors; these objects add that capability
    CRTBEGIN=$STAGING/lib32/crtbeginT.o
    CRTEND=$STAGING/lib32/crtendT.o
    DSOHANDLE=$STAGING/lib32/dso_handle.o
    # dlmalloc: mmap-based allocator that bypasses IRIX brk heap limit (176MB).
    # Linked ONLY into executables. Shared libraries leave malloc/free undefined
    # so rld resolves them to the executable's single dlmalloc, preventing
    # cross-heap corruption (each .so had its own dlmalloc → abort in free).
    if [ "$MOGRIX_NO_DLMALLOC" = "1" ]; then
        DLMALLOC=""
    else
        DLMALLOC=$STAGING/lib32/dlmalloc.o
    fi
    # safe_mem: Byte-safe memory/string functions (memcmp, strcmp, _Hash_bytes).
    # IRIX libc/libstdc++ optimized versions use word-aligned reads that overread
    # past buffer end into unmapped pages, causing SIGSEGV. These byte-by-byte
    # implementations avoid overreads. Linked into executables so dynamic symbol
    # resolution overrides the library versions for all code in the process.
    SAFEMEM=$STAGING/lib32/safe_mem.o

    # --image-base=0x1000000: Move binary above rld quickstart table (0x200000)
    # Default base 0x10000 gives only 1.8MB of brk heap; 0x1000000 gives 176MB
    # See rules/methods/irix-address-space.md for full address map
    # --disable-new-dtags: Emit DT_RPATH (0xf) instead of DT_RUNPATH (0x1d).
    # IRIX rld only recognizes DT_RPATH; DT_RUNPATH is ignored.
    # --export-dynamic-symbol=__rld_obj_head: IRIX rld symbol that the executable
    # must define. crt1.o provides it as COMMON, but LLD doesn't export COMMON
    # symbols to .dynsym by default. libC.so.2 and libGLcore.so reference it;
    # without this, any binary loading those libraries gets "unresolvable symbol".
    # -z norelro: IRIX rld doesn't support GNU_RELRO. Without this, LLD creates
    # a separate LOAD segment for .data.rel.ro with a GNU_RELRO header.
    # Large C++ binaries (GDB) with hundreds of RTTI relocations in .data.rel.ro
    # crash during static init when the RELRO segment is separate from .got/.data.
    exec $LLD \
      --allow-shlib-undefined \
      --disable-new-dtags \
      --export-dynamic-symbol=__rld_obj_head \
      --image-base=0x1000000 \
      -z norelro \
      -dynamic-linker /lib32/rld \
      $CRT1 \
      $CRTBEGIN \
      $DSOHANDLE \
      $DLMALLOC \
      $SAFEMEM \
      $filtered_args \
      -L$STAGING/lib32 \
      -L$SYSROOT/lib32 \
      -L$SYSROOT/usr/lib32 \
      -lsoft_float_stubs \
      -lc \
      $CRTEND \
      $CRTN
fi
