package: libepoxy

rules:
  drop_buildrequires:
    - libEGL-devel
    - libGL-devel
    - libX11-devel
    - mesa-dri-drivers
    - python3
    - xorg-x11-server-Xvfb
    - pkgconfig(egl)
    - pkgconfig(gl)
    - pkgconfig(glesv2)

  # IRIX has no err.h — remove include. IRIX has no RTLD_NOLOAD — define it.
  prep_commands:
    - "$MOGRIX_ROOT/tools/safepatch src/dispatch_common.c --delete-line '#include <err.h>' --no-backup --quiet"
    - "$MOGRIX_ROOT/tools/safepatch src/dispatch_common.c --old '#include <dlfcn.h>' --insert-after \"$(printf '#ifndef RTLD_NOLOAD\\n#define RTLD_NOLOAD 0x10\\n#endif')\" --no-backup --quiet"

  spec_replacements:
    # Replace %meson + %meson_build
    - pattern: "%meson\n%meson_build"
      replacement: |
        MOGRIX_CROSS=/home/edodd/projects/github/unxmaal/mogrix/cross/meson-irix-cross.ini
        /home/edodd/.local/bin/meson setup _build \
          --cross-file=$MOGRIX_CROSS \
          --prefix=%{_prefix} \
          --libdir=%{_libdir} \
          -Dglx=yes \
          -Degl=no \
          -Dx11=true \
          -Dtests=false \
          --wrap-mode=nodownload
        /home/edodd/.local/bin/meson compile -C _build

    # Replace %meson_install
    - pattern: "%meson_install"
      replacement: "DESTDIR=$RPM_BUILD_ROOT /home/edodd/.local/bin/meson install -C _build --no-rebuild"
