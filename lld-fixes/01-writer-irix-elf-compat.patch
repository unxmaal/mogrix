From: Mogrix Project
Subject: [PATCH 1/3] LLD: Skip IRIX-incompatible ELF features

IRIX 6.5's ELF parser and runtime linker (rld) predate several modern
MIPS ELF features. When these are present, IRIX tools crash or fail
to load the binary:

- PT_MIPS_ABIFLAGS program header (and .MIPS.abiflags section)
- PT_GNU_STACK program header
- PT_PHDR in shared libraries

This patch conditionally skips these features when the output OSABI
is set to ELFOSABI_IRIX (8), which is set via --osabi=irix or
-target mips-sgi-irix6.5.

Apply to: lld/ELF/Writer.cpp in LLVM 18.1.3

---
 lld/ELF/Writer.cpp | 16 ++++++++++++++--
 1 file changed, 14 insertions(+), 2 deletions(-)

--- a/lld/ELF/Writer.cpp
+++ b/lld/ELF/Writer.cpp
@@ -370,8 +370,10 @@ template <class ELFT> void Writer<ELFT>::createSyntheticSections() {
       in.mipsRldMap = std::make_unique<MipsRldMapSection>();
       add(*in.mipsRldMap);
     }
-    if ((in.mipsAbiFlags = MipsAbiFlagsSection<ELFT>::create()))
+    // IRIX ELF parser crashes on MIPS ABIFLAGS
+    if (config->osabi != ELFOSABI_IRIX && (in.mipsAbiFlags = MipsAbiFlagsSection<ELFT>::create()))
       add(*in.mipsAbiFlags);
     if ((in.mipsOptions = MipsOptionsSection<ELFT>::create()))
       add(*in.mipsOptions);
@@ -2145,7 +2147,9 @@ template <class ELFT> void Writer<ELFT>::createPhdrs() {
       if (config->emachine == EM_MIPS) {
         // Add separate segments for MIPS-specific sections.
-        addPhdrForSection(part, SHT_MIPS_ABIFLAGS, PT_MIPS_ABIFLAGS, PF_R);
+        // IRIX's ELF parser predates PT_MIPS_ABIFLAGS and crashes on it.
+        if (config->osabi != ELFOSABI_IRIX) {
+          addPhdrForSection(part, SHT_MIPS_ABIFLAGS, PT_MIPS_ABIFLAGS, PF_R);
+        }
         addPhdrForSection(part, SHT_MIPS_REGINFO, PT_MIPS_REGINFO, PF_R);
         addPhdrForSection(part, SHT_MIPS_OPTIONS, PT_MIPS_OPTIONS, PF_R);
       }
@@ -2390,8 +2394,12 @@ template <class ELFT> void Writer<ELFT>::createPhdrs() {
   if (!config->nmagic && !config->omagic) {
     // The first phdr entry is PT_PHDR which describes the program header
     // itself.
-    if (isMain)
+    // IRIX shared libraries don't have PT_PHDR - it confuses IRIX's ELF parser.
+    // Only skip PT_PHDR for IRIX shared libraries, not executables.
+    bool skipPhdr = config->osabi == ELFOSABI_IRIX && config->shared;
+    if (!skipPhdr && isMain)
       addHdr(PT_PHDR, PF_R)->add(Out::programHeaders);
-    else
+    else if (!skipPhdr)
       addHdr(PT_PHDR, PF_R)->add(part.programHeaders->getParent());

@@ -2508,6 +2516,10 @@ template <class ELFT> void Writer<ELFT>::createPhdrs() {
   if (OutputSection *cmd = findSection(".openbsd.randomdata", partNo))
     addHdr(PT_OPENBSD_RANDOMIZE, cmd->getPhdrFlags())->add(cmd);

+  // IRIX predates PT_GNU_STACK and crashes on it
+  if (config->osabi == ELFOSABI_IRIX)
+    config->zGnustack = GnuStackKind::None;
+
   if (config->zGnustack != GnuStackKind::None) {
     // PT_GNU_STACK is a special section to tell the loader to make the
     // pages for the stack non-executable.
