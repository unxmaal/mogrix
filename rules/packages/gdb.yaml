# gdb - GNU Debugger (hand-written spec for IRIX)
# Uses specs/packages/gdb.spec instead of Fedora's 6444-line spec.
# The Fedora spec is too complex: 46 patches, %include mechanism, PGO builds,
# RPM integration, multiple subpackages. For IRIX we just need core debugging.
package: gdb
upstream:
  url: https://ftp.gnu.org/gnu/gdb/gdb-14.2.tar.xz
  version: "14.2"
  type: tarball
  build_system: autoconf
  license: GPL-3.0-or-later
  summary: "GNU Debugger for IRIX"
  source_dir: gdb-14.2
rules:
  drop_buildrequires:
  - expat-devel
  drop_requires:
  - perl-interpreter
  # Override generic rewrite_paths — hand-written spec uses sysroot paths
  rewrite_paths:
    /usr/lib64: /usr/lib64
    /usr/lib: /usr/lib
    /usr/include: /usr/include
  prep_commands:
  # libiberty/filedescriptor.c uses dup2() without including unistd.h
  - "$MOGRIX_ROOT/tools/safepatch libiberty/filedescriptor.c --insert-top '#include <unistd.h>' --no-backup --quiet"
  # libiberty/fibheap.c uses LONG_MIN without including limits.h
  - "$MOGRIX_ROOT/tools/safepatch libiberty/fibheap.c --insert-top '#include <limits.h>' --no-backup --quiet"
  # pex-unix.c pid_t return type mismatch — IRIX pid_t is long, function returns int
  # Fix forward decl (one-line) and definition (two-line)
  - "$MOGRIX_ROOT/tools/safepatch libiberty/pex-unix.c --old 'static int pex_unix_wait' --new 'static pid_t pex_unix_wait' --count 0 --no-backup --quiet"
  - "$MOGRIX_ROOT/tools/safepatch libiberty/pex-unix.c --old \"$(printf 'static int\\npex_unix_wait')\" --new \"$(printf 'static pid_t\\npex_unix_wait')\" --no-backup --quiet"
  # gnulib's inttypes.h chain fails to define PRIo64 during cross-compile
  # Add it after __STDC_FORMAT_MACROS in common-defs.h (included by every file)
  - "$MOGRIX_ROOT/tools/safepatch gdbsupport/common-defs.h --old '__STDC_FORMAT_MACROS' --insert-after \"$(printf '#ifndef PRIo64\\n#define PRIo64 \"llo\"\\n#endif')\" --no-backup --quiet"
  # GDB 14.2 removed IRIX target support — remove IRIX from the obsolete list
  - "$MOGRIX_ROOT/tools/safepatch gdb/configure.tgt --delete-line '*-*-irix*' --no-backup --quiet"
  - "$MOGRIX_ROOT/tools/safepatch gdb/configure.host --delete-line '*-*-irix*' --no-backup --quiet"
  # IRIX has no TLS (__tls_get_addr) — replace thread_local with static
  # cp-support.c: "static thread_local SIGJMP_BUF" → "static SIGJMP_BUF"
  - "for f in gdb/cp-support.c gdb/event-top.c gdbsupport/safe-strerror.cc; do $MOGRIX_ROOT/tools/safepatch $f --old 'static thread_local' --new 'static' --count 0 --no-backup --quiet; done"
  ac_cv_overrides:
    ac_cv_header_fcntl_h: "yes"
  export_vars:
    PKG_CONFIG_PATH: /opt/sgug-staging/usr/sgug/lib32/pkgconfig
    PKG_CONFIG_LIBDIR: /opt/sgug-staging/usr/sgug/lib32/pkgconfig
