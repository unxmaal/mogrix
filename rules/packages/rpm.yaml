# rpm - RPM Package Manager
# Has sgifixes patches, needs compat functions

package: rpm


# IRIX-specific patches from SGUG-RSE
add_patch:
  - rpm.sgifixes.patch

rules:
  # Compat functions needed
  inject_compat_functions:
    - strdup
    - strndup
    - getline
    - asprintf
    - vasprintf

  # Drop libdicl and problematic dependencies
  drop_buildrequires:
    - libdicl-devel
    - libdicl
    - libselinux-devel
    - libcap-devel
    - libacl-devel
    - audit-libs-devel
    - systemd-devel

  drop_requires:
    - libdicl
    - libdicl-devel
    - libselinux
    - audit-libs

  # Autoconf cache overrides
  ac_cv_overrides:
    ac_cv_func_malloc_0_nonnull: "yes"
    ac_cv_func_realloc_0_nonnull: "yes"
    ac_cv_func_mmap_fixed_mapped: "no"

  # Configure flags
  configure_flags:
    add:
      - --disable-silent-rules
      - --without-selinux
      - --without-cap
      - --without-acl
      - --without-audit
      - --disable-plugins
      - --disable-inhibit-plugin
      - --disable-ima
      - --disable-fsverity
      - --with-crypto=openssl
    remove:
      - --enable-bdb-ro
      - --enable-sqlite
      - --enable-ndb
      - --with-cap
      - --with-acl

  configure_disable:
    - selinux
    - plugins
    - nls

  # Remove libdicl setup lines
  remove_lines:
    - 'export CPPFLAGS="-I%{_includedir}/libdicl-0.1"'
    - 'export LIBS="-ldicl-0.1"'

  # Comment out systemd conditionals
  comment_conditionals:
    - with_systemd
