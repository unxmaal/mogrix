# Mogrix Compat Source Catalog
# Maps function names to their source files
#
# ---index---
# Categories and key functions for quick reference:
#
# string/     : strdup, strndup, strcasestr, strsep, basename
# stdio/      : getline, asprintf, funopen (BSD cookie I/O - USE THIS, not fopencookie),
#               dprintf, open_memstream
# stdlib/     : reallocarray, secure_getenv, mkdtemp, qsort_r, bsearch
# runtime/    : stpcpy, spawn (posix_spawn/posix_spawnp/file_actions)
# dicl/       : openat-compat.c (17 POSIX "at" functions: openat, fstatat, futimens, etc.)
# functions/  : getopt_long
# unistd/     : getprogname, setprogname
# time/       : timegm
# error/      : err (BSD err/errx/warn/warnx), strerror_r
#
# IMPORTANT: fopencookie (stdio/fopencookie.c) CRASHES on IRIX - use funopen instead
# IMPORTANT: vasprintf in asprintf.c uses iterative approach (IRIX vsnprintf(NULL,0) returns -1)
# ---

functions:
  # String functions
  strdup:
    file: string/strdup.c
    header: string.h
    description: Duplicate a string
    source_patterns:
      - pattern: '\bstrdup\s*\('
        note: "dlmalloc replaces malloc but libc strdup still calls libc malloc — inject compat strdup"

  strndup:
    file: string/strndup.c
    header: string.h
    description: Duplicate at most n bytes of a string

  strnlen:
    file: string/strnlen.c
    header: string.h
    description: Determine the length of a fixed-size string

  strcasestr:
    file: string/strcasestr.c
    header: string.h
    description: Case-insensitive substring search (GNU extension)

  strsep:
    file: string/strsep.c
    header: string.h
    description: Extract token from string (BSD extension)

  stpcpy:
    file: runtime/stpcpy.c
    header: string.h
    description: Copy string and return pointer to end (POSIX.1-2008)

  stpncpy:
    file: runtime/stpncpy.c
    header: string.h
    description: Copy fixed-size string and return pointer to end (POSIX.1-2008)

  basename:
    file: string/basename.c
    header: libgen.h
    description: Extract filename from path (IRIX has this in libgen.so, not libc)

  explicit_bzero:
    file: string/explicit_bzero.c
    header: string.h
    description: Zero memory that won't be optimized away (OpenBSD/glibc extension)
    notes: |
      IRIX lacks explicit_bzero. GnuPG's wipememory() volatile function pointer
      to memset crashes on IRIX due to static initializer relocation issues.
      This provides explicit_bzero so wipememory uses it instead.
    source_patterns:
      - pattern: '\bexplicit_bzero\s*\('
        note: "IRIX lacks explicit_bzero — inject compat version"
      - pattern: 'static\s+.*\(\s*\*\s*volatile\s+\w+\)\s*.*=\s*.*memset'
        note: "Volatile fptr to memset crashes on IRIX — explicit_bzero avoids this pattern"

  # stdio functions
  getline:
    file: stdio/getline.c
    header: stdio.h
    description: Read a line from stream
    provides:
      - getline
      - getdelim
    source_patterns:
      - pattern: '\bgetline\s*\('
        note: "IRIX libc lacks getline — inject compat version (also allocates via dlmalloc)"

  getdelim:
    file: stdio/getline.c
    header: stdio.h
    description: Read delimited input from stream

  asprintf:
    file: stdio/asprintf.c
    header: stdio.h
    description: Print to allocated string
    provides:
      - asprintf
      - vasprintf
    source_patterns:
      - pattern: '\basprintf\s*\(|\bvasprintf\s*\('
        note: "IRIX libc lacks asprintf/vasprintf — inject compat (uses iterative vsnprintf)"

  vasprintf:
    file: stdio/asprintf.c
    header: stdio.h
    description: Print to allocated string (va_list version)

  fopencookie:
    file: stdio/fopencookie.c
    header: stdio/fopencookie.h
    description: Custom stream I/O (glibc extension for libsolv)
    requires_pthread: true
    notes: Portable implementation based on musl community code - CRASHES ON IRIX, use funopen instead

  funopen:
    file: stdio/funopen.c
    header: stdio.h
    description: Custom stream I/O (BSD extension for libsolv)
    requires_pthread: true
    notes: BSD-style cookie I/O, more reliable on IRIX than fopencookie
    source_patterns:
      - pattern: '\bfopencookie\s*\('
        note: "fopencookie crashes on IRIX — use funopen instead"

  # dprintf/vdprintf (IRIX lacks POSIX.1-2008 dprintf)
  dprintf:
    file: stdio/dprintf.c
    header: stdio.h
    description: Formatted print to file descriptor (POSIX.1-2008)
    provides:
      - dprintf
      - vdprintf
    source_patterns:
      - pattern: '\bdprintf\s*\('
        note: "IRIX libc lacks dprintf — inject compat version"

  vdprintf:
    file: stdio/dprintf.c
    header: stdio.h
    description: Formatted print to file descriptor (va_list version)

  # open_memstream (IRIX lacks POSIX.1-2008 open_memstream)
  open_memstream:
    file: stdio/open_memstream.c
    header: stdio.h
    description: Open a dynamic memory buffer as a stream (POSIX.1-2008)
    notes: |
      Implementation uses funopen() (BSD cookie I/O). Packages using
      open_memstream must also inject funopen.
    source_patterns:
      - pattern: '\bopen_memstream\s*\('
        note: "IRIX libc lacks open_memstream — inject compat version (requires funopen)"

  # setenv/unsetenv (IRIX only has putenv)
  setenv:
    file: stdlib/setenv.c
    header: stdlib.h
    description: Set environment variable (POSIX)
    provides:
      - setenv
      - unsetenv

  unsetenv:
    file: stdlib/setenv.c
    header: stdlib.h
    description: Remove environment variable (POSIX)

  # stdlib functions
  strtof:
    file: strtof.c
    header: stdlib.h
    description: Convert string to float (IRIX libc lacks this)

  reallocarray:
    file: stdlib/reallocarray.c
    header: stdlib.h
    description: Safe array reallocation with overflow check
    source_patterns:
      - pattern: '\breallocarray\s*\('
        note: "IRIX libc lacks reallocarray — inject compat version"

  secure_getenv:
    file: stdlib/secure_getenv.c
    header: stdlib.h
    description: Secure environment variable access (GNU extension)
    source_patterns:
      - pattern: '\bsecure_getenv\s*\('
        note: "IRIX libc lacks secure_getenv — inject compat version"

  mkdtemp:
    file: stdlib/mkdtemp.c
    header: stdlib.h
    description: Create a unique temporary directory (BSD/POSIX)

  bsearch:
    file: stdlib/bsearch.c
    header: stdlib.h
    description: POSIX-compliant bsearch (IRIX libc crashes on nmemb=0)
    notes: IRIX bsearch underflows nmemb-1 when nmemb=0, causing SIGSEGV

  qsort_r:
    file: stdlib/qsort_r.c
    header: stdlib.h
    description: qsort with user data pointer (GNU extension)
    notes: Not thread-safe - uses global state for emulation

  # time functions
  timegm:
    file: time/timegm.c
    header: time.h
    description: Convert broken-down time to time_t in UTC (GNU extension)

  # BSD error functions (err/errx/warn/warnx)
  err:
    file: error/err.c
    header: err.h
    description: BSD error reporting functions (err, errx, warn, warnx)
    provides:
      - err
      - errx
      - warn
      - warnx
      - verr
      - verrx
      - vwarn
      - vwarnx
    source_patterns:
      - pattern: '\berr[x]?\s*\(\d'
        note: "IRIX lacks <err.h> — inject compat BSD error functions"

  errx:
    file: error/err.c
    header: err.h
    description: BSD error reporting (no errno variant)

  warn:
    file: error/err.c
    header: err.h
    description: BSD warning reporting

  warnx:
    file: error/err.c
    header: err.h
    description: BSD warning reporting (no errno variant)

  # error functions
  strerror_r:
    file: error/strerror_r.c
    header: string.h
    description: Thread-safe strerror
    source_patterns:
      - pattern: '\bstrerror_r\s*\('
        note: "IRIX libc lacks strerror_r — inject compat version"

  # C99 intmax functions (IRIX 6.5 predates C99)
  strtoimax:
    file: intmax/strtoimax.c
    header: inttypes.h
    description: C99 intmax conversion functions (strtoimax, strtoumax, wcstoimax, wcstoumax)
    provides:
      - strtoimax
      - strtoumax
      - wcstoimax
      - wcstoumax

  # getopt_long (GNU extension for long options)
  getopt_long:
    file: functions/getopt_long.c
    header: getopt.h
    description: Parse long options (GNU extension)
    provides:
      - getopt_long
      - getopt_long_only
    source_patterns:
      - pattern: '\bgetopt_long\s*\('
        note: "IRIX libc lacks getopt_long — inject compat version"

  # Program name functions (BSD/GNU extension)
  getprogname:
    file: unistd/getprogname.c
    header: stdlib.h
    description: Get program name (BSD extension)
    provides:
      - getprogname
      - setprogname

  setprogname:
    file: unistd/getprogname.c
    header: stdlib.h
    description: Set program name (BSD extension)

  # POSIX spawn functions (IRIX lacks these)
  posix_spawn:
    file: runtime/spawn.c
    header: spawn.h
    description: Spawn a new process
    provides:
      - posix_spawn
      - posix_spawnp

  posix_spawnp:
    file: runtime/spawn.c
    header: spawn.h
    description: Spawn a new process, searching PATH

  # rld interface stubs
  _rld_new_interface:
    file: rld/rld_new_interface.c
    header: rld_interface.h
    description: IRIX rld interface stub for cross-compilation

  # mmap-based malloc (bypasses IRIX brk heap ceiling)
  # NOTE: dlmalloc is NO LONGER injected into compat archives.
  # It is linked by irix-ld into executables only (dlmalloc.o in staging).
  # Shared libraries leave malloc/free undefined so rld resolves them to
  # the executable's single dlmalloc, preventing cross-heap corruption.
  # See rules/INDEX.md "dlmalloc shared library crash".
  dlmalloc:
    file: malloc/dlmalloc.c
    header: stdlib.h
    description: mmap-based malloc replacement for IRIX (bypasses 176MB brk heap limit)
    extra_files:
      - malloc/dlmalloc-src.inc
    notes: |
      Uses dlmalloc 2.8.6 (MIT-0) configured with HAVE_MORECORE=0.
      All allocations go through mmap, bypassing the brk() ceiling at
      libpthread (0x0C080000). See rules/methods/irix-address-space.md.
      IMPORTANT: Linked into executables only via irix-ld (dlmalloc.o).
      Never inject into shared libraries — causes cross-heap corruption
      with -Bsymbolic-functions (each .so gets private heap).

  # PTY functions (IRIX uses _getpty instead of openpty)
  openpty:
    file: stdlib/openpty.c
    header: pty.h
    description: Open a pseudo-terminal (IRIX uses _getpty())
    notes: |
      IRIX has no openpty() or <pty.h>. This wraps _getpty() (declared in
      <unistd.h>) to provide the BSD/glibc openpty() interface.
    source_patterns:
      - pattern: '\bopenpty\s*\('
        note: "IRIX lacks openpty — inject compat using _getpty()"

  # pselect (IRIX has select but not pselect)
  pselect:
    file: stdlib/pselect.c
    header: sys/select.h
    description: Synchronous I/O multiplexing with signal mask (POSIX.1-2001)
    notes: |
      Wraps select() with sigprocmask(). Not fully atomic (tiny race window)
      but sufficient for terminal emulators and similar use cases.
    source_patterns:
      - pattern: '\bpselect\s*\('
        note: "IRIX lacks pselect — inject compat wrapping select()+sigprocmask"

  # SQLite3 stub for packages that optionally use sqlite3 (e.g., tdnf history)
  sqlite3_stub:
    file: sqlite/sqlite3_stub.c
    header: sqlite3.h
    description: Stub sqlite3 implementation for IRIX (history features disabled)
    notes: All functions return error codes - history functionality will not work

  # POSIX.1-2008 "at" functions (IRIX lacks these)
  openat:
    file: dicl/openat-compat.c
    header: fcntl.h
    description: Open file relative to directory file descriptor
    provides:
      - openat
      - fstatat
      - faccessat
      - mkdirat
      - unlinkat
      - renameat
      - readlinkat
      - symlinkat
      - linkat
      - fchmodat
      - fchownat
      - mkfifoat
      - mknodat
      - utimensat
      - futimens
      - stpcpy
      - stpncpy

  fstatat:
    file: dicl/openat-compat.c
    header: sys/stat.h
    description: Get file status relative to directory fd

  faccessat:
    file: dicl/openat-compat.c
    header: unistd.h
    description: Check permissions relative to directory fd

  mkdirat:
    file: dicl/openat-compat.c
    header: sys/stat.h
    description: Create directory relative to directory fd

  unlinkat:
    file: dicl/openat-compat.c
    header: unistd.h
    description: Remove file/directory relative to directory fd

  renameat:
    file: dicl/openat-compat.c
    header: stdio.h
    description: Rename file relative to directory fds

  readlinkat:
    file: dicl/openat-compat.c
    header: unistd.h
    description: Read symbolic link relative to directory fd

  symlinkat:
    file: dicl/openat-compat.c
    header: unistd.h
    description: Create symbolic link relative to directory fd

  linkat:
    file: dicl/openat-compat.c
    header: unistd.h
    description: Create hard link relative to directory fds

  fchmodat:
    file: dicl/openat-compat.c
    header: sys/stat.h
    description: Change file mode relative to directory fd

  fchownat:
    file: dicl/openat-compat.c
    header: unistd.h
    description: Change file owner relative to directory fd

# Common function sets for package classes
sets:
  # Basic string functions most packages need
  basic_string:
    - strdup
    - strndup

  # GNU extensions commonly used
  gnu_extensions:
    - strdup
    - strndup
    - getline
    - asprintf

  # POSIX.1-2008 "at" functions for packages requiring directory-relative ops
  posix_at:
    - openat
    - fstatat
    - faccessat
    - mkdirat
    - unlinkat
    - renameat
    - readlinkat
    - symlinkat
    - linkat
    - fchmodat
    - fchownat

  # Full compat set (replaces libdicl)
  full:
    - strdup
    - strndup
    - getline
    - asprintf
    - reallocarray
    - strerror_r
