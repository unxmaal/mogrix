# libpsl - C library for the Public Suffix List
# Uses libidn2 for both builtin and runtime (no ICU on IRIX)
# Bundled PSL data used since publicsuffix-list package not available

package: libpsl

rules:
  drop_buildrequires:
    - libicu-devel
    - gtk-doc
    - publicsuffix-list
    - python3-devel
    - libxslt
    - gettext-devel

  drop_requires:
    - publicsuffix-list-dafsa
    - publicsuffix-list

  drop_subpackages:
    - psl
    - psl-make-dafsa

  configure_flags:
    add:
      - --disable-static
      - --disable-gtk-doc
      - --disable-man
    remove:
      - --enable-man
      - --enable-gtk-doc
      - "--enable-builtin=libicu"
      - "--with-psl-distfile=%{_datadir}/publicsuffix/public_suffix_list.dafsa"
      - "--with-psl-file=%{_datadir}/publicsuffix/effective_tld_names.dat"
      - "--with-psl-testfile=%{_datadir}/publicsuffix/test_psl.txt"

  install_cleanup:
    - "rm -f %{buildroot}%{_bindir}/psl"
    - "rm -f %{buildroot}%{_bindir}/psl-make-dafsa"
    - "rm -rf %{buildroot}%{_mandir}/man1"

  spec_replacements:
    # Keep bundled PSL data - don't symlink to system publicsuffix-list
    - pattern: "rm -frv list"
      replacement: "# mogrix: keep bundled PSL data"
    - pattern: "ln -sv %{_datadir}/publicsuffix list"
      replacement: "# mogrix: using bundled PSL data"
    # Remove python3 shebang fix (no python3)
    - pattern: "%py3_shebang_fix src/psl-make-dafsa"
      replacement: "# mogrix: no python3"
    # Use libidn2 for builtin instead of libicu
    - pattern: "--enable-runtime=libidn2"
      replacement: "--enable-builtin=libidn2 --enable-runtime=libidn2"
    # Remove rpath sed hack (multiline) - not needed for cross-compile
    - pattern: "# avoid using rpath"
      replacement: "# mogrix: skip rpath fixup"
    - pattern: "sed -i libtool \\"
      replacement: "# mogrix: rpath sed removed \\"
    - pattern: "    -e 's|^\\(runpath_var=\\).*$|\\1|' \\"
      replacement: "# mogrix: rpath sed line 1 \\"
    - pattern: "    -e 's|^\\(hardcode_libdir_flag_spec=\\).*$|\\1|'"
      replacement: "# mogrix: rpath sed line 2"
    # Add explicit Provides since AutoProv is disabled
    - pattern: "Summary:        C library for the Publix Suffix List"
      replacement: "Summary:        C library for the Public Suffix List\nProvides: libpsl.so.5"
    # Remove gtk-doc files from devel subpackage (gtk-doc disabled)
    - pattern: "%{_datadir}/gtk-doc/html/libpsl/"
      replacement: ""
    # Remove man page from devel subpackage (man disabled)
    - pattern: "%{_mandir}/man3/libpsl.3*"
      replacement: ""
