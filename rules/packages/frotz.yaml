# frotz - Interactive fiction interpreter for Z-Machine games (FC40: 2.54)
# Makefile-based build, ncurses interface. Builds frotz + dfrotz (text mode).
# GUI versions (sfrotz/xfrotz) disabled — SDL2 and X11 font deps not available.
# Sound disabled — missing libmodplug and libsamplerate.
package: frotz

rules:
  # Drop deps for GUI and sound features we won't build
  drop_buildrequires:
    - pkgconfig(ao)
    - pkgconfig(libmodplug)
    - pkgconfig(samplerate)
    - pkgconfig(sndfile)
    - pkgconfig(vorbisfile)
    - pkgconfig(bzip2)
    - pkgconfig(freetype2)
    - pkgconfig(libpng)
    - pkgconfig(libjpeg)
    - pkgconfig(sdl2)
    - pkgconfig(SDL2_mixer)
    - pkgconfig(zlib)
    - pkgconfig(xt)
    - pkgconfig(fontutil)
    - bdftopcf

  # Drop the GUI subpackage entirely
  drop_subpackages:
    - gui

  # Inject setenv compat (IRIX libc lacks setenv/unsetenv)
  inject_compat_functions:
    - setenv

  prep_commands:
    # IRIX has no execinfo.h (backtrace) or ucontext.h (makecontext)
    - "sed -i 's/^#NO_EXECINFO_H.*/NO_EXECINFO_H = yes/' Makefile"
    # IRIX sys/types.h defines cell_t as short — conflicts with frotz's cell_t struct
    - "sed -i 's/cell_t/frotz_cell_t/g' src/dumb/doutput.c"

  spec_replacements:
    # Build only frotz (ncurses) and dfrotz (dumb) — skip sfrotz/xfrotz
    # Inject CC/AR/RANLIB for cross-compilation, disable sound
    # PKG_CONFIG must go through staging for ncurses detection
    # LDFLAGS must include compat archive + libgen (dirname/basename on IRIX)
    - pattern: "%make_build all"
      replacement: |
        export PKG_CONFIG_SYSROOT_DIR="/opt/sgug-staging"
        COMPAT_DIR=$(pwd)/mogrix-compat
        %make_build CC="%{__cc}" AR="%{__ar}" RANLIB="%{__ranlib}" \
          SOUND_TYPE=none NO_BLORB=yes NO_EXECINFO_H=yes \
          CFLAGS="%{optflags} -std=c99 -Wall" \
          LDFLAGS="-L$COMPAT_DIR -lmogrix-compat -lgen" \
          frotz dfrotz
    # Install: pass same vars so install targets don't re-link with system cc
    - pattern: "%make_install PREFIX=%{_prefix} install_all"
      replacement: |
        COMPAT_DIR=$(pwd)/mogrix-compat
        %make_install PREFIX=%{_prefix} CC="%{__cc}" AR="%{__ar}" RANLIB="%{__ranlib}" SOUND_TYPE=none NO_BLORB=yes NO_EXECINFO_H=yes CFLAGS="%{optflags} -std=c99 -Wall" LDFLAGS="-L$COMPAT_DIR -lmogrix-compat -lgen" install_frotz install_dfrotz
    # Remove the GUI %files section references (sfrotz/xfrotz not built)
    - pattern: |
        %files gui
        %{_bindir}/sfrotz
        %{_bindir}/xfrotz
        %{_mandir}/man6/sfrotz.6*
        %{_mandir}/man6/xfrotz.6*
      replacement: |
        # GUI disabled for IRIX (no SDL2/X11 font deps)

smoke_test:
  - command: "/usr/sgug/bin/dfrotz --version 2>&1 | head -1"
    expect: "Frotz"
