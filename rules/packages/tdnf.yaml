# tdnf - Tiny DNF package manager
# TARGET PACKAGE - The goal of the entire mogrix project
# Has sgifixes patches, needs compat functions
#
# ---metadata---
# complexity: high
# build_system: cmake
# key_fixes: [mips_arch_hardcode, plugin_disable, cmake_cross, systemd_removal, etc_path_fix]
# similar_to: [libsolv, rpm]
# depends: [libsolv, rpm, curl, openssl, libxml2]
# status: WORKING (repolist, makecache, install all verified)
# ---
#
# IMPORTANT: Hardcoded /etc paths in source code
# ================================================
# tdnf has hardcoded "/etc/tdnf/tdnf.conf" and "/etc/yum.repos.d" in:
#   - client/defines.h (TDNF_CONF_FILE, TDNF_DEFAULT_REPO_LOCATION, TDNF_DEFAULT_PLUGIN_CONF_PATH)
#   - common/config.h (same + TDNF_DEFAULT_VARS_DIRS)
#
# These are NOT cmake-configurable. Must be patched in %build section.
# Our patches change them to /usr/sgug/etc/* to match SGUG-RSE conventions.
#
# Build command (MUST use --target for correct arch):
#   rpmbuild --macros="/usr/lib/rpm/macros:/opt/sgug-staging/rpmmacros.irix" \
#     --define '_disable_source_fetch 1' --nodeps --target=mips-sgi-irix -ba tdnf.spec
# ---

package: tdnf


# IRIX-specific patches
# client-defines.sgifixes.patch - fixes hardcoded /etc paths to /usr/sgug/etc
# gpgcheck-rpm419.sgifixes.patch - fixes gpgcheck for rpm 4.19 API
add_patch:
  - client-defines.sgifixes.patch
  - gpgcheck-rpm419.sgifixes.patch

rules:
  # Mogrix provides compat functions - override SGUG-RSE's libdicl-based system
  # These get statically linked so we don't need libdicl at runtime
  inject_compat_functions:
    - strdup
    - strndup
    - getline
    - asprintf      # includes vasprintf with IRIX-safe iterative implementation
    - getopt_long

  # Drop problematic dependencies (libdicl handled in generic.yaml)
  drop_buildrequires:
    - systemd-devel
    - gpgme-devel

  drop_requires:
    - systemd

  # tdnf uses cmake
  # CMake options for IRIX:
  # -DSYSTEMD_DIR=OFF or remove systemd integration
  # -DWITH_METALINK=ON

  # Comment out systemd conditionals
  comment_conditionals:
    - with_systemd
    - systemd

  # Skip tests - can't run cross-compiled binaries
  skip_check: true

  # Use cross-compiled deps from staging
  export_vars:
    PKG_CONFIG_PATH: "/opt/sgug-staging/usr/sgug/lib32/pkgconfig"
    PKG_CONFIG_LIBDIR: "/opt/sgug-staging/usr/sgug/lib32/pkgconfig"
    PKG_CONFIG_SYSROOT_DIR: "/opt/sgug-staging"

  # Fix the %check section and cmake macros for cross-compilation
  spec_replacements:
    # Use SGUG-RSE compat system, but replace sqlite3_stub with real sqlite3
    # Only disable Source101 (sqlite3_stub) and its cp command
    - pattern: "Source101: sqlite3_stub.c"
      replacement: "# Source101: sqlite3_stub.c - using real sqlite3 instead"
    - pattern: "cp %{SOURCE101} mogrix-compat/"
      replacement: "# cp %{SOURCE101} mogrix-compat/ - using real sqlite3 instead"
    # Remove stale SOURCE107 reference (doesn't exist after previous conversions)
    - pattern: "cp %{SOURCE107} mogrix-compat/"
      replacement: "# cp %{SOURCE107} - removed (Source107 no longer exists)"
    # Remove the entire conditional-wrapped %check block (can't just comment - macros still expand)
    - pattern: |
        %if 0%{?with_check}
        %check
        pip3 install flake8
        %make_build -C %{__cmake_builddir} check
        %endif
      replacement: |
        # Tests skipped for cross-compilation
    # Replace cmake macro with cross-compilation settings
    - pattern: |
        %{cmake} \
          -DCMAKE_BUILD_TYPE=Debug \
          -DBUILD_SHARED_LIBS=OFF \
          -DCMAKE_INSTALL_LIBDIR:PATH=%{_libdir} \
          -DSYSTEMD_DIR=%{_unitdir} \
          -DHISTORY_DB_DIR=%{hist_db_dir}
      replacement: |
        # Disable Python bindings - can't cross-compile these
        sed -i 's|add_subdirectory.*python.*|# & (disabled for cross-compilation)|' CMakeLists.txt
        # Disable repogpgcheck plugin - requires gpgme which we don't have
        sed -i 's|add_subdirectory.*repogpgcheck.*|# & (disabled - no gpgme)|' plugins/CMakeLists.txt
        # Disable metalink plugin - also requires gpgme
        sed -i 's|add_subdirectory.*metalink.*|# & (disabled - no gpgme)|' plugins/CMakeLists.txt
        # Path fixes are handled by client-defines.sgifixes.patch (added via add_patch rule)
        # Add strings.h include for strcasecmp on IRIX (needed in multiple files)
        find . -name "*.c" -exec grep -l "strcasecmp\|strncasecmp" {} \; | while read f; do
          sed -i '1i #include <strings.h>' "$f"
        done
        # Fix IRIX header order - ensure BSD types are defined before sys/vfs.h
        # Add sys/types.h and sys/bsd_types.h right after the header guard
        sed -i '/#define __CLIENT_INCLUDES_H__/a #include <sys/bsd_types.h>' client/includes.h
        sed -i '/#define __CLIENT_INCLUDES_H__/a #include <sys/types.h>' client/includes.h
        # gpgcheck.c ported to rpm 4.19 API via gpgcheck-rpm419.sgifixes.patch
        # Add sys/statfs.h for IRIX (statfs is not in sys/vfs.h on IRIX)
        sed -i '/#include <sys\/vfs.h>/a #include <sys/statfs.h>' client/includes.h
        # DEBUG: To add debug tracing, manually apply /home/edodd/rpmbuild/SOURCES/tdnf-debug.patch
        # after extraction, or run /home/edodd/rpmbuild/SOURCES/apply-debug.py in the source dir
        # Add sys/ttold.h for struct winsize (unconditional), sys/termios.h for TIOCGWINSZ, sys/ioccom.h for _IOR
        sed -i '1i #include <sys/ioctl.h>' tools/cli/lib/output.c
        sed -i '1i #include <sys/termios.h>' tools/cli/lib/output.c
        sed -i '1i #include <sys/ttold.h>' tools/cli/lib/output.c
        sed -i '1i #include <sys/ioccom.h>' tools/cli/lib/output.c
        # Add rpm/rpmmacro.h for rpmDefineMacro
        sed -i '/#include <rpm\/header.h>/a #include <rpm/rpmmacro.h>' client/includes.h
        # Fix statfs call for IRIX (different signature and struct)
        # IRIX: statfs(path, buf, len, 0) and uses f_bfree instead of f_bavail
        sed -i 's/statfs(pConf->pszCacheDir, \&stfs)/statfs(pConf->pszCacheDir, \&stfs, sizeof(stfs), 0)/' client/packageutils.c
        sed -i 's/stfs.f_bavail/stfs.f_bfree/' client/packageutils.c
        # IRIX uname reports machine as IP30, IP32, etc. - hardcode to mips for IRIX
        sed -i 's/pool_setarch(pPool, systemInfo.machine)/pool_setarch(pPool, "mips")/' solv/tdnfpool.c
        export COMPAT_DIR=$(pwd)/mogrix-compat
        # Create mogrix-compat directory and build compat library
        mkdir -p $COMPAT_DIR
        # Copy fixed asprintf.c (IRIX vsnprintf(NULL,0) returns -1, not buffer size)
        cp /opt/sgug-staging/asprintf.c $COMPAT_DIR/asprintf.c
        # Copy getopt_long.c (IRIX doesn't have getopt_long)
        cp /home/edodd/projects/github/unxmaal/mogrix/compat/functions/getopt_long.c $COMPAT_DIR/getopt_long.c
        # Build libmogrix-compat.a
        %{__cc} -c -o $COMPAT_DIR/asprintf.o $COMPAT_DIR/asprintf.c -I/opt/sgug-staging/usr/sgug/include
        %{__cc} -c -o $COMPAT_DIR/getopt_long.o $COMPAT_DIR/getopt_long.c -I/opt/sgug-staging/usr/sgug/include/mogrix-compat/generic
        %{__ar} rcs $COMPAT_DIR/libmogrix-compat.a $COMPAT_DIR/asprintf.o $COMPAT_DIR/getopt_long.o
        cmake -B _build -S . \
          -DCMAKE_SYSTEM_NAME=IRIX \
          -DCMAKE_C_COMPILER=%{__cc} \
          -DCMAKE_CXX_COMPILER=%{__cxx} \
          -DCMAKE_AR=%{__ar} \
          -DCMAKE_RANLIB=%{__ranlib} \
          -DCMAKE_INSTALL_PREFIX=%{_prefix} \
          -DCMAKE_INSTALL_LIBDIR=%{_libdir} \
          -DCMAKE_C_FLAGS="-I/opt/sgug-staging/usr/sgug/include/mogrix-compat/generic -I/opt/sgug-staging/usr/sgug/include" \
          -DCMAKE_EXE_LINKER_FLAGS="-L/opt/sgug-staging/usr/sgug/lib32 $COMPAT_DIR/libmogrix-compat.a -lgen -lpthread -lsqlite3" \
          -DCMAKE_SHARED_LINKER_FLAGS="-L/opt/sgug-staging/usr/sgug/lib32 $COMPAT_DIR/libmogrix-compat.a -lgen -lpthread -lsqlite3" \
          -DCMAKE_PREFIX_PATH=/opt/sgug-staging/usr/sgug \
          -DCMAKE_INCLUDE_PATH=/opt/sgug-staging/usr/sgug/include \
          -DCMAKE_LIBRARY_PATH=/opt/sgug-staging/usr/sgug/lib32 \
          -DCMAKE_FIND_ROOT_PATH=/opt/sgug-staging/usr/sgug \
          -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY \
          -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY \
          -DCMAKE_BUILD_TYPE=Debug \
          -DBUILD_SHARED_LIBS=ON \
          -DHISTORY_DB_DIR=%{hist_db_dir} \
          -DCMAKE_INSTALL_SYSCONFDIR=%{_sysconfdir} \
          -DSYSCONFDIR=%{_sysconfdir} \
          -DWITHOUT_SYSTEMD=ON
    # Use make instead of cmake_build/cmake_install
    - pattern: "%{cmake_build}"
      replacement: "cd _build && make %{?_smp_mflags}"
    - pattern: "%{cmake_install}"
      replacement: |
        cd _build && make install DESTDIR=%{buildroot}
        # Clean up files we don't want (systemd, plugins, automatic, motdgen)
        rm -rf %{buildroot}/lib/systemd
        rm -rf %{buildroot}%{_prefix}/lib/systemd
        rm -rf %{buildroot}/etc/motdgen.d
        rm -rf %{buildroot}%{_sysconfdir}/motdgen.d
        rm -rf %{buildroot}/etc/%{name}/automatic.conf
        rm -rf %{buildroot}%{_sysconfdir}/%{name}/automatic.conf
        rm -rf %{buildroot}/etc/%{name}/pluginconf.d
        rm -rf %{buildroot}%{_sysconfdir}/%{name}/pluginconf.d
        rm -rf %{buildroot}/etc/%{name}/tdnf.conf
        rm -rf %{buildroot}%{_sysconfdir}/%{name}/tdnf.conf
        rm -f %{buildroot}%{_bindir}/%{name}-automatic
        rm -f %{buildroot}%{_bindir}/tdnf-automatic
    # Skip python bindings build (can't run cross-compiled python)
    - pattern: "%make_build -C %{__cmake_builddir} python"
      replacement: "# Skip python bindings for cross-compilation"
    # Remove systemd service installation
    - pattern: "rm %{buildroot}%{_unitdir}/%{name}-cache-updateinfo.{timer,service}"
      replacement: "# Skip systemd cleanup (not built)"
    # Skip Python bindings installation (not built)
    - pattern: |
        pushd %{__cmake_builddir}/python
        %py3_install
        popd
      replacement: |
        # Skip Python bindings installation (not built for cross-compilation)
    # Fix shared library patterns for non-versioned libs
    - pattern: "%{_libdir}/libtdnf.so.*"
      replacement: "%{_libdir}/libtdnf.so"
    - pattern: "%{_libdir}/libtdnfcli.so.*"
      replacement: "%{_libdir}/libtdnfcli.so"
    # Remove disabled plugin files
    - pattern: "%{_tdnfpluginsdir}/libtdnfmetalink.so"
      replacement: "# disabled: %{_tdnfpluginsdir}/libtdnfmetalink.so"
    - pattern: "%{_tdnfpluginsdir}/libtdnfrepogpgcheck.so"
      replacement: "# disabled: %{_tdnfpluginsdir}/libtdnfrepogpgcheck.so"
    # Remove motdgen file if not installed
    - pattern: "%{_sysconfdir}/motdgen.d/02-%{name}-updateinfo.sh"
      replacement: "# not installed: %{_sysconfdir}/motdgen.d/02-%{name}-updateinfo.sh"
    # Remove requires for disabled plugins
    - pattern: "Requires:   %{name}-plugin-repogpgcheck = %{version}-%{release}"
      replacement: "# disabled: Requires:   %{name}-plugin-repogpgcheck = %{version}-%{release}"
    - pattern: "Requires:   %{name}-plugin-metalink = %{version}-%{release}"
      replacement: "# disabled: Requires:   %{name}-plugin-metalink = %{version}-%{release}"
    # Comment out plugin config directories and files
    - pattern: "%dir %{_sysconfdir}/tdnf/pluginconf.d"
      replacement: "# disabled: %dir %{_sysconfdir}/tdnf/pluginconf.d"
    - pattern: "%dir %{_sysconfdir}/%{name}/pluginconf.d"
      replacement: "# disabled: %dir %{_sysconfdir}/%{name}/pluginconf.d"
    - pattern: "%config(noreplace) %{_sysconfdir}/tdnf/pluginconf.d/tdnfmetalink.conf"
      replacement: "# disabled: %config(noreplace) %{_sysconfdir}/tdnf/pluginconf.d/tdnfmetalink.conf"
    - pattern: "%config(noreplace) %{_sysconfdir}/%{name}/pluginconf.d/tdnfrepogpgcheck.conf"
      replacement: "# disabled: %config(noreplace) %{_sysconfdir}/%{name}/pluginconf.d/tdnfrepogpgcheck.conf"
    # Remove python package requires
    - pattern: "Requires:   %{name}-python = %{version}-%{release}"
      replacement: "# disabled: Requires:   %{name}-python = %{version}-%{release}"
    - pattern: "Requires:   python3-pytest"
      replacement: "# disabled: Requires:   python3-pytest"
    - pattern: "Requires:   python3-requests"
      replacement: "# disabled: Requires:   python3-requests"
    # Comment out python files section
    - pattern: "%{python3_sitelib}/*"
      replacement: "# disabled: %{python3_sitelib}/*"
    # Disable automatic package (requires systemd)
    - pattern: "Requires:   %{name}-automatic = %{version}-%{release}"
      replacement: "# disabled: Requires:   %{name}-automatic = %{version}-%{release}"
    - pattern: "%{_bindir}/%{name}-automatic"
      replacement: "# disabled: %{_bindir}/%{name}-automatic"
    - pattern: "%config(noreplace) %{_sysconfdir}/%{name}/automatic.conf"
      replacement: "# disabled: %config(noreplace) %{_sysconfdir}/%{name}/automatic.conf"
    - pattern: "%{_unitdir}/%{name}-automatic.timer"
      replacement: "# disabled: %{_unitdir}/%{name}-automatic.timer"
    - pattern: "%{_unitdir}/%{name}-automatic.service"
      replacement: "# disabled: %{_unitdir}/%{name}-automatic.service"
    - pattern: "%{_unitdir}/%{name}-automatic-install.timer"
      replacement: "# disabled: %{_unitdir}/%{name}-automatic-install.timer"
    - pattern: "%{_unitdir}/%{name}-automatic-install.service"
      replacement: "# disabled: %{_unitdir}/%{name}-automatic-install.service"
    - pattern: "%{_unitdir}/%{name}-automatic-notifyonly.timer"
      replacement: "# disabled: %{_unitdir}/%{name}-automatic-notifyonly.timer"
    - pattern: "%{_unitdir}/%{name}-automatic-notifyonly.service"
      replacement: "# disabled: %{_unitdir}/%{name}-automatic-notifyonly.service"
    # Disable systemd scriptlets
    - pattern: "%systemd_post %{automatic_services}"
      replacement: "# disabled: %systemd_post %{automatic_services}"
    - pattern: "%systemd_preun %{automatic_services}"
      replacement: "# disabled: %systemd_preun %{automatic_services}"
    - pattern: "%systemd_postun_with_restart %{automatic_services}"
      replacement: "# disabled: %systemd_postun_with_restart %{automatic_services}"

  # Fix tdnf.conf paths for IRIX - must be rooted at /usr/sgug, not /etc or /var
  install_cleanup:
    - sed -i 's|repodir=/etc/|repodir=/usr/sgug/etc/|' $RPM_BUILD_ROOT%{_sysconfdir}/%{name}/tdnf.conf
    - sed -i 's|cachedir=/var/|cachedir=/usr/sgug/var/|' $RPM_BUILD_ROOT%{_sysconfdir}/%{name}/tdnf.conf
    - mkdir -p $RPM_BUILD_ROOT/usr/sgug/etc/yum.repos.d
    - mkdir -p $RPM_BUILD_ROOT/usr/sgug/var/cache/tdnf
