# sqlite - SQL database engine
#
# ---metadata---
# complexity: medium
# build_system: autoconf
# key_fixes: [disable_math_funcs, LLONG_MAX_define, _ABI_SOURCE, LONGDOUBLE_TYPE]
# similar_to: []
# depends: [zlib]
# status: WORKING (library works, CLI has file write crash - not blocking)
# ---

package: sqlite

rules:
  # Note: bcond_invert is not implemented, using spec_replacements instead

  configure_flags:
    add:
      - --disable-static
      - --enable-shared
      - --disable-math  # IRIX lacks C99 math functions (acosh/asinh/atanh)
    remove:
      # These are Linux-specific features not available on IRIX
      - --enable-threadsafe
      - --enable-threads-override-locks

  # Force libtool to build shared libraries (it mis-detects cross-compilation)
  ac_cv_overrides:
    lt_cv_deplibs_check_method: "pass_all"

  # IRIX compatibility environment variables
  export_vars:
    # SQLITE_ENABLE_MATH_FUNCTIONS=0 disables SQL math functions
    # SQLITE_HAVE_C99_MATH_FUNCS=0 disables C99 math functions (acosh/asinh/atanh not on IRIX)
    # Define LLONG_MAX/MIN since IRIX predates C99
    # _ABI_SOURCE makes _ABIAPI true, using extern select() instead of static wrapper
    # LONGDOUBLE_TYPE=double avoids 128-bit long double (clang MIPS doesn't support -mlong-double-64)
    CPPFLAGS: "-D_ABI_SOURCE -DSQLITE_ENABLE_MATH_FUNCTIONS=0 -DSQLITE_HAVE_C99_MATH_FUNCS=0 -DLLONG_MAX=9223372036854775807LL -DLLONG_MIN=-9223372036854775808LL -DLONGDOUBLE_TYPE=double -DSQLITE_MAX_MMAP_SIZE=268435456 $CPPFLAGS"

  # Note: skip_check is handled globally in generic.yaml

  # Remove .la and .a files left after install (we only want shared libs)
  install_cleanup:
    - rm -f $RPM_BUILD_ROOT%{_libdir}/*.la
    - rm -f $RPM_BUILD_ROOT%{_libdir}/*.a

  spec_replacements:
    # Disable tcl support - not available for IRIX cross-compilation
    - pattern: "%bcond_without tcl"
      replacement: "%bcond_with tcl"
    - pattern: "%bcond_without sqldiff"
      replacement: "%bcond_with sqldiff"
    # Fix libtool to build shared libraries for IRIX using generic script
    - pattern: "sed -i 's|^runpath_var=LD_RUN_PATH|runpath_var=DIE_RPATH_DIE|g' libtool"
      replacement: |
        sed -i 's|^runpath_var=LD_RUN_PATH|runpath_var=DIE_RPATH_DIE|g' libtool
        # Fix libtool for IRIX cross-compilation
        $MOGRIX_ROOT/tools/fix-libtool-irix.sh libtool || exit 1
