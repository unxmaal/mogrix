# tmux - terminal multiplexer (upstream: 3.5a)
# Autoconf build. Deps: libevent, ncurses (both staged).
# No FC40 SRPM — uses create-srpm from GitHub.
package: tmux

add_source:
  - forkpty-irix.c

upstream:
  url: https://github.com/tmux/tmux
  version: "3.5a"
  ref: "3.5a"
  type: git
  build_system: autoconf
  license: ISC
  summary: "Terminal multiplexer"

rules:
  prep_commands:
    # Git repo doesn't include pre-generated configure — generate it
    - "sh autogen.sh"
    # IRIX libc has __b64_ntop/__b64_pton but marked HIDDEN — rld can't
    # resolve at runtime. Force all b64 checks to fail so tmux uses its
    # own compat/base64.c (OpenBSD implementation).
    - "$MOGRIX_ROOT/tools/safepatch configure --old 'found_b64_ntop=yes' --new 'found_b64_ntop=no' --count 0 --no-backup --quiet"
    # IRIX resolv.h has #define b64_ntop __b64_ntop — this renames the compat
    # function to __b64_ntop but callers (via compat.h) expect plain b64_ntop.
    # Undef after includes so compat/base64.c defines the plain symbols.
    - "$MOGRIX_ROOT/tools/safepatch compat/base64.c --old '#include <string.h>' --insert-after \"$(printf '#undef b64_ntop\\n#undef b64_pton')\" --no-backup --quiet"
    # IRIX has no UTF-8 locale — suppress tmux's hard UTF-8 requirement.
    # The setlocale fallback chain still runs; we just don't abort on non-UTF8.
    - "$MOGRIX_ROOT/tools/safepatch tmux.c --old 'errx(1, \"invalid LC_ALL, LC_CTYPE or LANG\")' --new '(void)0' --no-backup --quiet"
    - "$MOGRIX_ROOT/tools/safepatch tmux.c --old 'errx(1, \"need UTF-8 locale.*s)' --new '(void)0' --regex --no-backup --quiet"
    # IRIX sendmsg limits iov entries to MSG_MAXIOVLEN (16). imsg-buffer.c uses
    # IOV_MAX (1024 on IRIX) which causes errno 97 when batching >16 messages.
    # Cap at 16 to match IRIX kernel limit.
    - "$MOGRIX_ROOT/tools/safepatch compat/imsg-buffer.c --old 'IOV_MAX' --new '16' --count 0 --no-backup --quiet"
    # Rename local variable that collides with getopt.h macro optional_argument
    - "$MOGRIX_ROOT/tools/safepatch arguments.c --old 'optional_argument' --new 'is_optional_arg' --count 0 --no-backup --quiet"
    # IRIX lacks strsignal() — replace all occurrences with literal string
    - "for f in client.c server.c; do $MOGRIX_ROOT/tools/safepatch $f --old 'strsignal(sig)' --new '\"signal\"' --no-backup --quiet; done"
    # Fix compat/setenv.c — xasprintf is tmux-internal, use standard asprintf;
    # environ needs extern declaration (IRIX has no setenv in libc)
    - "$MOGRIX_ROOT/tools/safepatch compat/setenv.c --old 'xasprintf' --new 'asprintf' --no-backup --quiet"
    - "$MOGRIX_ROOT/tools/safepatch compat/setenv.c --old '#include \"compat.h\"' --insert-after 'extern char **environ;' --no-backup --quiet"
    # Install IRIX forkpty() using _getpty() — tmux detects IRIX as "unknown" platform
    - "cp %{_sourcedir}/forkpty-irix.c compat/forkpty-unknown.c"

  # basename/dirname are in libgen.so on IRIX (not libc). Pre-set LIBS so
  # the compat injection's "$LIBS" picks it up.
  export_vars:
    LIBS: "-lgen"

  spec_replacements:
    # Add man page to %files (template only has bindir)
    - pattern: "%{_bindir}/*"
      replacement: "%{_bindir}/*\n%{_mandir}/man1/tmux.1*"

  configure_flags:
    add:
      - --disable-utf8proc
